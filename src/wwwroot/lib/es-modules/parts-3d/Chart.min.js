"use strict";import H from"../parts/Globals.js";import U from"../parts/Utilities.js";var isArray=U.isArray,pick=U.pick;import"../parts/Chart.js";var addEvent=H.addEvent,Chart=H.Chart,merge=H.merge,perspective=H.perspective,wrap=H.wrap;function getScale(e,t){var i,r=e.plotLeft,o=e.plotWidth+r,l=e.plotTop,s=e.plotHeight+l,a=r+e.plotWidth/2,x=l+e.plotHeight/2,n={minX:Number.MAX_VALUE,maxX:-Number.MAX_VALUE,minY:Number.MAX_VALUE,maxY:-Number.MAX_VALUE},h=1;return i=[{x:r,y:l,z:0},{x:r,y:l,z:t}],[0,1].forEach(function(e){i.push({x:o,y:i[e].y,z:i[e].z})}),[0,1,2,3].forEach(function(e){i.push({x:i[e].x,y:s,z:i[e].z})}),(i=perspective(i,e,!1)).forEach(function(e){n.minX=Math.min(n.minX,e.x),n.maxX=Math.max(n.maxX,e.x),n.minY=Math.min(n.minY,e.y),n.maxY=Math.max(n.maxY,e.y)}),r>n.minX&&(h=Math.min(h,1-Math.abs((r+a)/(n.minX+a))%1)),o<n.maxX&&(h=Math.min(h,(o-a)/(n.maxX-a))),l>n.minY&&(h=n.minY<0?Math.min(h,(l+x)/(-n.minY+l+x)):Math.min(h,1-(l+x)/(n.minY+x)%1)),s<n.maxY&&(h=Math.min(h,Math.abs((s-x)/(n.maxY-x)))),h}Chart.prototype.is3d=function(){return this.options.chart.options3d&&this.options.chart.options3d.enabled},Chart.prototype.propsRequireDirtyBox.push("chart.options3d"),Chart.prototype.propsRequireUpdateSeries.push("chart.options3d"),addEvent(Chart,"afterInit",function(){var e=this.options;this.is3d()&&(e.series||[]).forEach(function(t){"scatter"===(t.type||e.chart.type||e.chart.defaultSeriesType)&&(t.type="scatter3d")})}),addEvent(Chart,"addSeries",function(e){this.is3d()&&"scatter"===e.options.type&&(e.options.type="scatter3d")}),H.wrap(H.Chart.prototype,"isInsidePlot",function(e){return this.is3d()||e.apply(this,[].slice.call(arguments,1))});var defaultOptions=H.getOptions(),extendedOptions={chart:{options3d:{enabled:!1,alpha:0,beta:0,depth:100,fitToPlot:!0,viewDistance:25,axisLabelPosition:null,frame:{visible:"default",size:1,bottom:{},top:{},left:{},right:{},back:{},front:{}}}}};merge(!0,defaultOptions,extendedOptions),addEvent(Chart,"afterGetContainer",function(){this.styledMode&&(this.renderer.definition({tagName:"style",textContent:".highcharts-3d-top{filter: url(#highcharts-brighter)}\n.highcharts-3d-side{filter: url(#highcharts-darker)}\n"}),[{name:"darker",slope:.6},{name:"brighter",slope:1.4}].forEach(function(e){this.renderer.definition({tagName:"filter",id:"highcharts-"+e.name,children:[{tagName:"feComponentTransfer",children:[{tagName:"feFuncR",type:"linear",slope:e.slope},{tagName:"feFuncG",type:"linear",slope:e.slope},{tagName:"feFuncB",type:"linear",slope:e.slope}]}]})},this))}),wrap(Chart.prototype,"setClassName",function(e){e.apply(this,[].slice.call(arguments,1)),this.is3d()&&(this.container.className+=" highcharts-3d-chart")}),addEvent(H.Chart,"afterSetChartSize",function(){var e=this.options.chart.options3d;if(this.is3d()){var t=this.inverted,i=this.clipBox,r=this.margin,o=t?"x":"y",l=t?"height":"width",s=t?"width":"height";i[t?"y":"x"]=-(r[3]||0),i[o]=-(r[0]||0),i[l]=this.chartWidth+(r[3]||0)+(r[1]||0),i[s]=this.chartHeight+(r[0]||0)+(r[2]||0),this.scale3d=1,!0===e.fitToPlot&&(this.scale3d=getScale(this,e.depth)),this.frame3d=this.get3dFrame()}}),addEvent(Chart,"beforeRedraw",function(){this.is3d()&&(this.isDirtyBox=!0)}),addEvent(Chart,"beforeRender",function(){this.is3d()&&(this.frame3d=this.get3dFrame())}),wrap(Chart.prototype,"renderSeries",function(e){var t,i=this.series.length;if(this.is3d())for(;i--;)(t=this.series[i]).translate(),t.render();else e.call(this)}),addEvent(Chart,"afterDrawChartBox",function(){if(this.is3d()){var e=this.renderer,t=this.options.chart.options3d,i=this.get3dFrame(),r=this.plotLeft,o=this.plotLeft+this.plotWidth,l=this.plotTop,s=this.plotTop+this.plotHeight,a=t.depth,x=r-(i.left.visible?i.left.size:0),n=o+(i.right.visible?i.right.size:0),h=l-(i.top.visible?i.top.size:0),y=s+(i.bottom.visible?i.bottom.size:0),z=0-(i.front.visible?i.front.size:0),c=a+(i.back.visible?i.back.size:0),b=this.hasRendered?"animate":"attr";this.frame3d=i,this.frameShapes||(this.frameShapes={bottom:e.polyhedron().add(),top:e.polyhedron().add(),left:e.polyhedron().add(),right:e.polyhedron().add(),back:e.polyhedron().add(),front:e.polyhedron().add()}),this.frameShapes.bottom[b]({class:"highcharts-3d-frame highcharts-3d-frame-bottom",zIndex:i.bottom.frontFacing?-1e3:1e3,faces:[{fill:H.color(i.bottom.color).brighten(.1).get(),vertexes:[{x:x,y:y,z:z},{x:n,y:y,z:z},{x:n,y:y,z:c},{x:x,y:y,z:c}],enabled:i.bottom.visible},{fill:H.color(i.bottom.color).brighten(.1).get(),vertexes:[{x:r,y:s,z:a},{x:o,y:s,z:a},{x:o,y:s,z:0},{x:r,y:s,z:0}],enabled:i.bottom.visible},{fill:H.color(i.bottom.color).brighten(-.1).get(),vertexes:[{x:x,y:y,z:z},{x:x,y:y,z:c},{x:r,y:s,z:a},{x:r,y:s,z:0}],enabled:i.bottom.visible&&!i.left.visible},{fill:H.color(i.bottom.color).brighten(-.1).get(),vertexes:[{x:n,y:y,z:c},{x:n,y:y,z:z},{x:o,y:s,z:0},{x:o,y:s,z:a}],enabled:i.bottom.visible&&!i.right.visible},{fill:H.color(i.bottom.color).get(),vertexes:[{x:n,y:y,z:z},{x:x,y:y,z:z},{x:r,y:s,z:0},{x:o,y:s,z:0}],enabled:i.bottom.visible&&!i.front.visible},{fill:H.color(i.bottom.color).get(),vertexes:[{x:x,y:y,z:c},{x:n,y:y,z:c},{x:o,y:s,z:a},{x:r,y:s,z:a}],enabled:i.bottom.visible&&!i.back.visible}]}),this.frameShapes.top[b]({class:"highcharts-3d-frame highcharts-3d-frame-top",zIndex:i.top.frontFacing?-1e3:1e3,faces:[{fill:H.color(i.top.color).brighten(.1).get(),vertexes:[{x:x,y:h,z:c},{x:n,y:h,z:c},{x:n,y:h,z:z},{x:x,y:h,z:z}],enabled:i.top.visible},{fill:H.color(i.top.color).brighten(.1).get(),vertexes:[{x:r,y:l,z:0},{x:o,y:l,z:0},{x:o,y:l,z:a},{x:r,y:l,z:a}],enabled:i.top.visible},{fill:H.color(i.top.color).brighten(-.1).get(),vertexes:[{x:x,y:h,z:c},{x:x,y:h,z:z},{x:r,y:l,z:0},{x:r,y:l,z:a}],enabled:i.top.visible&&!i.left.visible},{fill:H.color(i.top.color).brighten(-.1).get(),vertexes:[{x:n,y:h,z:z},{x:n,y:h,z:c},{x:o,y:l,z:a},{x:o,y:l,z:0}],enabled:i.top.visible&&!i.right.visible},{fill:H.color(i.top.color).get(),vertexes:[{x:x,y:h,z:z},{x:n,y:h,z:z},{x:o,y:l,z:0},{x:r,y:l,z:0}],enabled:i.top.visible&&!i.front.visible},{fill:H.color(i.top.color).get(),vertexes:[{x:n,y:h,z:c},{x:x,y:h,z:c},{x:r,y:l,z:a},{x:o,y:l,z:a}],enabled:i.top.visible&&!i.back.visible}]}),this.frameShapes.left[b]({class:"highcharts-3d-frame highcharts-3d-frame-left",zIndex:i.left.frontFacing?-1e3:1e3,faces:[{fill:H.color(i.left.color).brighten(.1).get(),vertexes:[{x:x,y:y,z:z},{x:r,y:s,z:0},{x:r,y:s,z:a},{x:x,y:y,z:c}],enabled:i.left.visible&&!i.bottom.visible},{fill:H.color(i.left.color).brighten(.1).get(),vertexes:[{x:x,y:h,z:c},{x:r,y:l,z:a},{x:r,y:l,z:0},{x:x,y:h,z:z}],enabled:i.left.visible&&!i.top.visible},{fill:H.color(i.left.color).brighten(-.1).get(),vertexes:[{x:x,y:y,z:c},{x:x,y:h,z:c},{x:x,y:h,z:z},{x:x,y:y,z:z}],enabled:i.left.visible},{fill:H.color(i.left.color).brighten(-.1).get(),vertexes:[{x:r,y:l,z:a},{x:r,y:s,z:a},{x:r,y:s,z:0},{x:r,y:l,z:0}],enabled:i.left.visible},{fill:H.color(i.left.color).get(),vertexes:[{x:x,y:y,z:z},{x:x,y:h,z:z},{x:r,y:l,z:0},{x:r,y:s,z:0}],enabled:i.left.visible&&!i.front.visible},{fill:H.color(i.left.color).get(),vertexes:[{x:x,y:h,z:c},{x:x,y:y,z:c},{x:r,y:s,z:a},{x:r,y:l,z:a}],enabled:i.left.visible&&!i.back.visible}]}),this.frameShapes.right[b]({class:"highcharts-3d-frame highcharts-3d-frame-right",zIndex:i.right.frontFacing?-1e3:1e3,faces:[{fill:H.color(i.right.color).brighten(.1).get(),vertexes:[{x:n,y:y,z:c},{x:o,y:s,z:a},{x:o,y:s,z:0},{x:n,y:y,z:z}],enabled:i.right.visible&&!i.bottom.visible},{fill:H.color(i.right.color).brighten(.1).get(),vertexes:[{x:n,y:h,z:z},{x:o,y:l,z:0},{x:o,y:l,z:a},{x:n,y:h,z:c}],enabled:i.right.visible&&!i.top.visible},{fill:H.color(i.right.color).brighten(-.1).get(),vertexes:[{x:o,y:l,z:0},{x:o,y:s,z:0},{x:o,y:s,z:a},{x:o,y:l,z:a}],enabled:i.right.visible},{fill:H.color(i.right.color).brighten(-.1).get(),vertexes:[{x:n,y:y,z:z},{x:n,y:h,z:z},{x:n,y:h,z:c},{x:n,y:y,z:c}],enabled:i.right.visible},{fill:H.color(i.right.color).get(),vertexes:[{x:n,y:h,z:z},{x:n,y:y,z:z},{x:o,y:s,z:0},{x:o,y:l,z:0}],enabled:i.right.visible&&!i.front.visible},{fill:H.color(i.right.color).get(),vertexes:[{x:n,y:y,z:c},{x:n,y:h,z:c},{x:o,y:l,z:a},{x:o,y:s,z:a}],enabled:i.right.visible&&!i.back.visible}]}),this.frameShapes.back[b]({class:"highcharts-3d-frame highcharts-3d-frame-back",zIndex:i.back.frontFacing?-1e3:1e3,faces:[{fill:H.color(i.back.color).brighten(.1).get(),vertexes:[{x:n,y:y,z:c},{x:x,y:y,z:c},{x:r,y:s,z:a},{x:o,y:s,z:a}],enabled:i.back.visible&&!i.bottom.visible},{fill:H.color(i.back.color).brighten(.1).get(),vertexes:[{x:x,y:h,z:c},{x:n,y:h,z:c},{x:o,y:l,z:a},{x:r,y:l,z:a}],enabled:i.back.visible&&!i.top.visible},{fill:H.color(i.back.color).brighten(-.1).get(),vertexes:[{x:x,y:y,z:c},{x:x,y:h,z:c},{x:r,y:l,z:a},{x:r,y:s,z:a}],enabled:i.back.visible&&!i.left.visible},{fill:H.color(i.back.color).brighten(-.1).get(),vertexes:[{x:n,y:h,z:c},{x:n,y:y,z:c},{x:o,y:s,z:a},{x:o,y:l,z:a}],enabled:i.back.visible&&!i.right.visible},{fill:H.color(i.back.color).get(),vertexes:[{x:r,y:l,z:a},{x:o,y:l,z:a},{x:o,y:s,z:a},{x:r,y:s,z:a}],enabled:i.back.visible},{fill:H.color(i.back.color).get(),vertexes:[{x:x,y:y,z:c},{x:n,y:y,z:c},{x:n,y:h,z:c},{x:x,y:h,z:c}],enabled:i.back.visible}]}),this.frameShapes.front[b]({class:"highcharts-3d-frame highcharts-3d-frame-front",zIndex:i.front.frontFacing?-1e3:1e3,faces:[{fill:H.color(i.front.color).brighten(.1).get(),vertexes:[{x:x,y:y,z:z},{x:n,y:y,z:z},{x:o,y:s,z:0},{x:r,y:s,z:0}],enabled:i.front.visible&&!i.bottom.visible},{fill:H.color(i.front.color).brighten(.1).get(),vertexes:[{x:n,y:h,z:z},{x:x,y:h,z:z},{x:r,y:l,z:0},{x:o,y:l,z:0}],enabled:i.front.visible&&!i.top.visible},{fill:H.color(i.front.color).brighten(-.1).get(),vertexes:[{x:x,y:h,z:z},{x:x,y:y,z:z},{x:r,y:s,z:0},{x:r,y:l,z:0}],enabled:i.front.visible&&!i.left.visible},{fill:H.color(i.front.color).brighten(-.1).get(),vertexes:[{x:n,y:y,z:z},{x:n,y:h,z:z},{x:o,y:l,z:0},{x:o,y:s,z:0}],enabled:i.front.visible&&!i.right.visible},{fill:H.color(i.front.color).get(),vertexes:[{x:o,y:l,z:0},{x:r,y:l,z:0},{x:r,y:s,z:0},{x:o,y:s,z:0}],enabled:i.front.visible},{fill:H.color(i.front.color).get(),vertexes:[{x:n,y:y,z:z},{x:x,y:y,z:z},{x:x,y:h,z:z},{x:n,y:h,z:z}],enabled:i.front.visible}]})}}),Chart.prototype.retrieveStacks=function(e){var t,i=this.series,r={},o=1;return this.series.forEach(function(l){t=pick(l.options.stack,e?0:i.length-1-l.index),r[t]?r[t].series.push(l):(r[t]={series:[l],position:o},o++)}),r.totalStacks=o+1,r},Chart.prototype.get3dFrame=function(){var e=this,t=e.options.chart.options3d,i=t.frame,r=e.plotLeft,o=e.plotLeft+e.plotWidth,l=e.plotTop,s=e.plotTop+e.plotHeight,a=t.depth,x=function(t){var i=H.shapeArea3d(t,e);return i>.5?1:i<-.5?-1:0},n=x([{x:r,y:s,z:a},{x:o,y:s,z:a},{x:o,y:s,z:0},{x:r,y:s,z:0}]),h=x([{x:r,y:l,z:0},{x:o,y:l,z:0},{x:o,y:l,z:a},{x:r,y:l,z:a}]),y=x([{x:r,y:l,z:0},{x:r,y:l,z:a},{x:r,y:s,z:a},{x:r,y:s,z:0}]),z=x([{x:o,y:l,z:a},{x:o,y:l,z:0},{x:o,y:s,z:0},{x:o,y:s,z:a}]),c=x([{x:r,y:s,z:0},{x:o,y:s,z:0},{x:o,y:l,z:0},{x:r,y:l,z:0}]),b=x([{x:r,y:l,z:a},{x:o,y:l,z:a},{x:o,y:s,z:a},{x:r,y:s,z:a}]),f=!1,p=!1,d=!1,v=!1;[].concat(e.xAxis,e.yAxis,e.zAxis).forEach(function(e){e&&(e.horiz?e.opposite?p=!0:f=!0:e.opposite?v=!0:d=!0)});var g=function(e,t,i){for(var r=["size","color","visible"],o={},l=0;l<r.length;l++)for(var s=r[l],a=0;a<e.length;a++)if("object"==typeof e[a]){var x=e[a][s];if(null!=x){o[s]=x;break}}var n=i;return!0===o.visible||!1===o.visible?n=o.visible:"auto"===o.visible&&(n=t>0),{size:pick(o.size,1),color:pick(o.color,"none"),frontFacing:t>0,visible:n}},m={axes:{},bottom:g([i.bottom,i.top,i],n,f),top:g([i.top,i.bottom,i],h,p),left:g([i.left,i.right,i.side,i],y,d),right:g([i.right,i.left,i.side,i],z,v),back:g([i.back,i.front,i],b,!0),front:g([i.front,i.back,i],c,!1)};if("auto"===t.axisLabelPosition){var u=function(e,t){return e.visible!==t.visible||e.visible&&t.visible&&e.frontFacing!==t.frontFacing},k=[];u(m.left,m.front)&&k.push({y:(l+s)/2,x:r,z:0,xDir:{x:1,y:0,z:0}}),u(m.left,m.back)&&k.push({y:(l+s)/2,x:r,z:a,xDir:{x:0,y:0,z:-1}}),u(m.right,m.front)&&k.push({y:(l+s)/2,x:o,z:0,xDir:{x:0,y:0,z:1}}),u(m.right,m.back)&&k.push({y:(l+s)/2,x:o,z:a,xDir:{x:-1,y:0,z:0}});var C=[];u(m.bottom,m.front)&&C.push({x:(r+o)/2,y:s,z:0,xDir:{x:1,y:0,z:0}}),u(m.bottom,m.back)&&C.push({x:(r+o)/2,y:s,z:a,xDir:{x:-1,y:0,z:0}});var D=[];u(m.top,m.front)&&D.push({x:(r+o)/2,y:l,z:0,xDir:{x:1,y:0,z:0}}),u(m.top,m.back)&&D.push({x:(r+o)/2,y:l,z:a,xDir:{x:-1,y:0,z:0}});var E=[];u(m.bottom,m.left)&&E.push({z:(0+a)/2,y:s,x:r,xDir:{x:0,y:0,z:-1}}),u(m.bottom,m.right)&&E.push({z:(0+a)/2,y:s,x:o,xDir:{x:0,y:0,z:1}});var S=[];u(m.top,m.left)&&S.push({z:(0+a)/2,y:l,x:r,xDir:{x:0,y:0,z:-1}}),u(m.top,m.right)&&S.push({z:(0+a)/2,y:l,x:o,xDir:{x:0,y:0,z:1}});var F=function(t,i,r){if(0===t.length)return null;if(1===t.length)return t[0];for(var o=0,l=perspective(t,e,!1),s=1;s<l.length;s++)r*l[s][i]>r*l[o][i]?o=s:r*l[s][i]==r*l[o][i]&&l[s].z<l[o].z&&(o=s);return t[o]};m.axes={y:{left:F(k,"x",-1),right:F(k,"x",1)},x:{top:F(D,"y",-1),bottom:F(C,"y",1)},z:{top:F(S,"y",-1),bottom:F(E,"y",1)}}}else m.axes={y:{left:{x:r,z:0,xDir:{x:1,y:0,z:0}},right:{x:o,z:0,xDir:{x:0,y:0,z:1}}},x:{top:{y:l,z:0,xDir:{x:1,y:0,z:0}},bottom:{y:s,z:0,xDir:{x:1,y:0,z:0}}},z:{top:{x:d?o:r,y:l,xDir:d?{x:0,y:0,z:1}:{x:0,y:0,z:-1}},bottom:{x:d?o:r,y:s,xDir:d?{x:0,y:0,z:1}:{x:0,y:0,z:-1}}}};return m},H.Fx.prototype.matrixSetter=function(){var e;if(this.pos<1&&(isArray(this.start)||isArray(this.end))){var t=this.start||[1,0,0,1,0,0],i=this.end||[1,0,0,1,0,0];e=[];for(var r=0;r<6;r++)e.push(this.pos*i[r]+(1-this.pos)*t[r])}else e=this.end;this.elem.attr(this.prop,e,null,!0)};