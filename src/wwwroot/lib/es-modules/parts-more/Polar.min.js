"use strict";import H from"../parts/Globals.js";import U from"../parts/Utilities.js";var pick=U.pick,splat=U.splat;import"../parts/Pointer.js";import"../parts/Series.js";import"../parts/Pointer.js";var colProto,Pointer=H.Pointer,Series=H.Series,seriesTypes=H.seriesTypes,wrap=H.wrap,seriesProto=Series.prototype,pointerProto=Pointer.prototype;seriesProto.searchPointByAngle=function(t){var e=this.chart,r=this.xAxis.pane.center,i=t.chartX-r[0]-e.plotLeft,o=t.chartY-r[1]-e.plotTop;return this.searchKDTree({clientX:180+Math.atan2(i,o)*(-180/Math.PI)})},seriesProto.getConnectors=function(t,e,r,i){var o,a,s,n,l,p,h,c,P,f,u,d,g,y,A,v,x,X,C,M,Y,m=i?1:0;return a=(o=e>=0&&e<=t.length-1?e:e<0?t.length-1+e:0)-1<0?t.length-(1+m):o-1,s=o+1>t.length-1?m:o+1,n=t[a],l=t[s],p=n.plotX,h=n.plotY,c=l.plotX,P=l.plotY,g=(1.5*(f=t[o].plotX)+p)/2.5,y=(1.5*(u=t[o].plotY)+h)/2.5,A=(1.5*f+c)/2.5,v=(1.5*u+P)/2.5,x=Math.sqrt(Math.pow(g-f,2)+Math.pow(y-u,2)),X=Math.sqrt(Math.pow(A-f,2)+Math.pow(v-u,2)),C=Math.atan2(y-u,g-f),M=Math.atan2(v-u,A-f),Y=Math.PI/2+(C+M)/2,Math.abs(C-Y)>Math.PI/2&&(Y-=Math.PI),g=f+Math.cos(Y)*x,y=u+Math.sin(Y)*x,d={rightContX:A=f+Math.cos(Math.PI+Y)*X,rightContY:v=u+Math.sin(Math.PI+Y)*X,leftContX:g,leftContY:y,plotX:f,plotY:u},r&&(d.prevPointCont=this.getConnectors(t,a,!1,i)),d},seriesProto.toXY=function(t){var e,r,i=this.chart,o=t.plotX,a=t.plotY;t.rectPlotX=o,t.rectPlotY=a,e=this.xAxis.postTranslate(t.plotX,this.yAxis.len-a),t.plotX=t.polarPlotX=e.x-i.plotLeft,t.plotY=t.polarPlotY=e.y-i.plotTop,this.kdByAngle?((r=(o/Math.PI*180+this.xAxis.pane.options.startAngle)%360)<0&&(r+=360),t.clientX=r):t.clientX=t.plotX},seriesTypes.spline&&(wrap(seriesTypes.spline.prototype,"getPointSpline",function(t,e,r,i){var o;return this.chart.polar?i?["C",(o=this.getConnectors(e,i,!0,this.connectEnds)).prevPointCont.rightContX,o.prevPointCont.rightContY,o.leftContX,o.leftContY,o.plotX,o.plotY]:["M",r.plotX,r.plotY]:t.call(this,e,r,i)}),seriesTypes.areasplinerange&&(seriesTypes.areasplinerange.prototype.getPointSpline=seriesTypes.spline.prototype.getPointSpline)),H.addEvent(Series,"afterTranslate",function(){var t,e,r=this.chart;if(r.polar&&this.xAxis){if(this.kdByAngle=r.tooltip&&r.tooltip.shared,this.kdByAngle?this.searchPoint=this.searchPointByAngle:this.options.findNearestPointBy="xy",!this.preventPostTranslate)for(e=(t=this.points).length;e--;)this.toXY(t[e]),!r.hasParallelCoordinates&&!this.yAxis.reversed&&t[e].y<this.yAxis.min&&(t[e].isNull=!0);this.hasClipCircleSetter||(this.hasClipCircleSetter=Boolean(H.addEvent(this,"afterRender",function(){var t;r.polar&&(t=this.yAxis.center,this.group.clip(r.renderer.clipCircle(t[0],t[1],t[2]/2)),this.setClip=H.noop)})))}},{order:2}),wrap(seriesProto,"getGraphPath",function(t,e){var r,i,o,a=this;if(this.chart.polar){for(e=e||this.points,r=0;r<e.length;r++)if(!e[r].isNull){i=r;break}!1!==this.options.connectEnds&&void 0!==i&&(this.connectEnds=!0,e.splice(e.length,0,e[i]),o=!0),e.forEach(function(t){void 0===t.polarPlotY&&a.toXY(t)})}var s=t.apply(this,[].slice.call(arguments,1));return o&&e.pop(),s});var polarAnimate=function(t,e){var r,i=this.chart,o=this.options.animation,a=this.group,s=this.markerGroup,n=this.xAxis.center,l=i.plotLeft,p=i.plotTop;i.polar?i.renderer.isSVG&&(!0===o&&(o={}),e?(r={translateX:n[0]+l,translateY:n[1]+p,scaleX:.001,scaleY:.001},a.attr(r),s&&s.attr(r)):(r={translateX:l,translateY:p,scaleX:1,scaleY:1},a.animate(r,o),s&&s.animate(r,o),this.animate=null)):t.call(this,e)};wrap(seriesProto,"animate",polarAnimate),seriesTypes.column&&((colProto=seriesTypes.column.prototype).polarArc=function(t,e,r,i){var o=this.xAxis.center,a=this.yAxis.len;return this.chart.renderer.symbols.arc(o[0],o[1],a-e,null,{start:r,end:i,innerR:a-pick(t,a)})},wrap(colProto,"animate",polarAnimate),wrap(colProto,"translate",function(t){var e,r,i,o,a=this.xAxis,s=a.startAngleRad;if(this.preventPostTranslate=!0,t.call(this),a.isRadial)for(o=(r=this.points).length;o--;)e=(i=r[o]).barX+s,i.shapeType="path",i.shapeArgs={d:this.polarArc(i.yBottom,i.plotY,e,e+i.pointWidth)},this.toXY(i),i.tooltipPos=[i.plotX,i.plotY],i.ttBelow=i.plotY>a.center[1]}),wrap(colProto,"alignDataLabel",function(t,e,r,i,o,a){if(this.chart.polar){var s,n,l=e.rectPlotX/Math.PI*180;null===i.align&&(s=l>20&&l<160?"left":l>200&&l<340?"right":"center",i.align=s),null===i.verticalAlign&&(n=l<45||l>315?"bottom":l>135&&l<225?"top":"middle",i.verticalAlign=n),seriesProto.alignDataLabel.call(this,e,r,i,o,a)}else t.call(this,e,r,i,o,a)})),wrap(pointerProto,"getCoordinates",function(t,e){var r=this.chart,i={xAxis:[],yAxis:[]};return r.polar?r.axes.forEach(function(t){var o,a,s=t.isXAxis,n=t.center;"colorAxis"!==t.coll&&(o=e.chartX-n[0]-r.plotLeft,a=e.chartY-n[1]-r.plotTop,i[s?"xAxis":"yAxis"].push({axis:t,value:t.translate(s?Math.PI-Math.atan2(o,a):Math.sqrt(Math.pow(o,2)+Math.pow(a,2)),!0)}))}):i=t.call(this,e),i}),H.SVGRenderer.prototype.clipCircle=function(t,e,r){var i,o=H.uniqueKey(),a=this.createElement("clipPath").attr({id:o}).add(this.defs);return(i=this.circle(t,e,r).add(a)).id=o,i.clipPath=a,i},H.addEvent(H.Chart,"getAxes",function(){this.pane||(this.pane=[]),splat(this.options.pane).forEach(function(t){new H.Pane(t,this)},this)}),H.addEvent(H.Chart,"afterDrawChartBox",function(){this.pane.forEach(function(t){t.render()})}),wrap(H.Chart.prototype,"get",function(t,e){return H.find(this.pane,function(t){return t.options.id===e})||t.call(this,e)});