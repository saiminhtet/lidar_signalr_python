"use strict";import H from"../parts/Globals.js";import"../parts/Color.js";import"../parts/Legend.js";import"../parts/Options.js";import"../parts/Point.js";import"../parts/ScatterSeries.js";import"../parts/Series.js";import"./ColorMapSeriesMixin.js";import U from"../parts/Utilities.js";var extend=U.extend,isArray=U.isArray,isNumber=U.isNumber,objectEach=U.objectEach,pick=U.pick,splat=U.splat,colorMapPointMixin=H.colorMapPointMixin,colorMapSeriesMixin=H.colorMapSeriesMixin,LegendSymbolMixin=H.LegendSymbolMixin,merge=H.merge,noop=H.noop,fireEvent=H.fireEvent,Point=H.Point,Series=H.Series,seriesType=H.seriesType,seriesTypes=H.seriesTypes;seriesType("map","scatter",{animation:!1,dataLabels:{crop:!1,formatter:function(){return this.point.value},inside:!0,overflow:!1,padding:0,verticalAlign:"middle"},marker:null,nullColor:"#f7f7f7",stickyTracking:!1,tooltip:{followPointer:!0,pointFormat:"{point.name}: {point.value}<br/>"},turboThreshold:0,allAreas:!0,borderColor:"#cccccc",borderWidth:1,joinBy:"hc-key",states:{hover:{halo:null,brightness:.2},normal:{animation:!0},select:{color:"#cccccc"},inactive:{opacity:1}}},merge(colorMapSeriesMixin,{type:"map",getExtremesFromAll:!0,useMapGeometry:!0,forceDL:!0,searchPoint:noop,directTouch:!0,preserveAspectRatio:!0,pointArrayMap:["value"],setOptions:function(t){var i=Series.prototype.setOptions.call(this,t),a=i.joinBy;return null===a&&(a="_i"),(a=this.joinBy=splat(a))[1]||(a[1]=a[0]),i},getBox:function(t){var i,a=Number.MAX_VALUE,e=-a,s=a,r=-a,n=a,o=a,l=this.xAxis,p=this.yAxis;(t||[]).forEach(function(t){if(t.path){"string"==typeof t.path&&(t.path=H.splitPath(t.path));var l=t.path||[],p=l.length,h=!1,c=-a,m=a,d=-a,u=a,f=t.properties;if(!t._foundBox){for(;p--;)isNumber(l[p])&&(h?(c=Math.max(c,l[p]),m=Math.min(m,l[p])):(d=Math.max(d,l[p]),u=Math.min(u,l[p])),h=!h);t._midX=m+(c-m)*pick(t.middleX,f&&f["hc-middle-x"],.5),t._midY=u+(d-u)*pick(t.middleY,f&&f["hc-middle-y"],.5),t._maxX=c,t._minX=m,t._maxY=d,t._minY=u,t.labelrank=pick(t.labelrank,(c-m)*(d-u)),t._foundBox=!0}e=Math.max(e,t._maxX),s=Math.min(s,t._minX),r=Math.max(r,t._maxY),n=Math.min(n,t._minY),o=Math.min(t._maxX-t._minX,t._maxY-t._minY,o),i=!0}}),i&&(this.minY=Math.min(n,pick(this.minY,a)),this.maxY=Math.max(r,pick(this.maxY,-a)),this.minX=Math.min(s,pick(this.minX,a)),this.maxX=Math.max(e,pick(this.maxX,-a)),l&&void 0===l.options.minRange&&(l.minRange=Math.min(5*o,(this.maxX-this.minX)/5,l.minRange||a)),p&&void 0===p.options.minRange&&(p.minRange=Math.min(5*o,(this.maxY-this.minY)/5,p.minRange||a)))},hasData:function(){return!!this.processedXData.length},getExtremes:function(){Series.prototype.getExtremes.call(this,this.valueData),this.chart.hasRendered&&this.isDirtyData&&this.getBox(this.options.data),this.valueMin=this.dataMin,this.valueMax=this.dataMax,this.dataMin=this.minY,this.dataMax=this.maxY},translatePath:function(t){var i,a=!1,e=this.xAxis,s=this.yAxis,r=e.min,n=e.transA,o=e.minPixelPadding,l=s.min,p=s.transA,h=s.minPixelPadding,c=[];if(t)for(i=t.length;i--;)isNumber(t[i])?(c[i]=a?(t[i]-r)*n+o:(t[i]-l)*p+h,a=!a):c[i]=t[i];return c},setData:function(t,i,a,e){var s,r,n,o=this.options,l=this.chart.options.chart,p=l&&l.map,h=o.mapData,c=this.joinBy,m=o.keys||this.pointArrayMap,d=[],u={},f=this.chart.mapTransforms;if(!h&&p&&(h="string"==typeof p?H.maps[p]:p),t&&t.forEach(function(i,a){var e=0;if(isNumber(i))t[a]={value:i};else if(isArray(i)){t[a]={},!o.keys&&i.length>m.length&&"string"==typeof i[0]&&(t[a]["hc-key"]=i[0],++e);for(var s=0;s<m.length;++s,++e)m[s]&&void 0!==i[e]&&(m[s].indexOf(".")>0?H.Point.prototype.setNestedProperty(t[a],i[e],m[s]):t[a][m[s]]=i[e])}c&&"_i"===c[0]&&(t[a]._i=a)}),this.getBox(t),this.chart.mapTransforms=f=l&&l.mapTransforms||h&&h["hc-transform"]||f,f&&objectEach(f,function(t){t.rotation&&(t.cosAngle=Math.cos(t.rotation),t.sinAngle=Math.sin(t.rotation))}),h){for("FeatureCollection"===h.type&&(this.mapTitle=h.title,h=H.geojson(h,this.type,this)),this.mapData=h,this.mapMap={},n=0;n<h.length;n++)r=(s=h[n]).properties,s._i=n,c[0]&&r&&r[c[0]]&&(s[c[0]]=r[c[0]]),u[s[c[0]]]=s;this.mapMap=u,t&&c[1]&&t.forEach(function(t){u[t[c[1]]]&&d.push(u[t[c[1]]])}),o.allAreas?(this.getBox(h),t=t||[],c[1]&&t.forEach(function(t){d.push(t[c[1]])}),d="|"+d.map(function(t){return t&&t[c[0]]}).join("|")+"|",h.forEach(function(i){c[0]&&-1!==d.indexOf("|"+i[c[0]]+"|")||(t.push(merge(i,{value:null})),e=!1)})):this.getBox(d)}Series.prototype.setData.call(this,t,i,a,e)},drawGraph:noop,drawDataLabels:noop,doFullTranslate:function(){return this.isDirtyData||this.chart.isResizing||this.chart.renderer.isVML||!this.baseTrans},translate:function(){var t=this,i=t.xAxis,a=t.yAxis,e=t.doFullTranslate();t.generatePoints(),t.data.forEach(function(s){isNumber(s._midX)&&isNumber(s._midY)&&(s.plotX=i.toPixels(s._midX,!0),s.plotY=a.toPixels(s._midY,!0)),e&&(s.shapeType="path",s.shapeArgs={d:t.translatePath(s.path)})}),fireEvent(t,"afterTranslate")},pointAttribs:function(t,i){var a=t.series.chart.styledMode?this.colorAttribs(t):seriesTypes.column.prototype.pointAttribs.call(this,t,i);return a["stroke-width"]=pick(t.options[this.pointAttrToOptions&&this.pointAttrToOptions["stroke-width"]||"borderWidth"],"inherit"),a},drawPoints:function(){var t,i,a,e,s,r,n,o,l,p=this,h=p.xAxis,c=p.yAxis,m=p.group,d=p.chart,u=d.renderer,f=this.baseTrans;p.transformGroup||(p.transformGroup=u.g().attr({scaleX:1,scaleY:1}).add(m),p.transformGroup.survive=!0),p.doFullTranslate()?(d.hasRendered&&!d.styledMode&&p.points.forEach(function(t){t.shapeArgs&&(t.shapeArgs.fill=p.pointAttribs(t,t.state).fill)}),p.group=p.transformGroup,seriesTypes.column.prototype.drawPoints.apply(p),p.group=m,p.points.forEach(function(t){if(t.graphic){var i="";t.name&&(i+="highcharts-name-"+t.name.replace(/ /g,"-").toLowerCase()),t.properties&&t.properties["hc-key"]&&(i+=" highcharts-key-"+t.properties["hc-key"].toLowerCase()),i&&t.graphic.addClass(i),d.styledMode&&t.graphic.css(p.pointAttribs(t,t.selected&&"select"))}}),this.baseTrans={originX:h.min-h.minPixelPadding/h.transA,originY:c.min-c.minPixelPadding/c.transA+(c.reversed?0:c.len/c.transA),transAX:h.transA,transAY:c.transA},this.transformGroup.animate({translateX:0,translateY:0,scaleX:1,scaleY:1})):(t=h.transA/f.transAX,i=c.transA/f.transAY,a=h.toPixels(f.originX,!0),e=c.toPixels(f.originY,!0),t>.99&&t<1.01&&i>.99&&i<1.01&&(t=1,i=1,a=Math.round(a),e=Math.round(e)),s=this.transformGroup,d.renderer.globalAnimation?(r=s.attr("translateX"),n=s.attr("translateY"),o=s.attr("scaleX"),l=s.attr("scaleY"),s.attr({animator:0}).animate({animator:1},{step:function(p,h){s.attr({translateX:r+(a-r)*h.pos,translateY:n+(e-n)*h.pos,scaleX:o+(t-o)*h.pos,scaleY:l+(i-l)*h.pos})}})):s.attr({translateX:a,translateY:e,scaleX:t,scaleY:i})),d.styledMode||m.element.setAttribute("stroke-width",pick(p.options[p.pointAttrToOptions&&p.pointAttrToOptions["stroke-width"]||"borderWidth"],1)/(t||1)),this.drawMapDataLabels()},drawMapDataLabels:function(){Series.prototype.drawDataLabels.call(this),this.dataLabelsGroup&&this.dataLabelsGroup.clip(this.chart.clipRect)},render:function(){var t=this,i=Series.prototype.render;t.chart.renderer.isVML&&t.data.length>3e3?setTimeout(function(){i.call(t)}):i.call(t)},animate:function(t){var i=this.chart,a=this.options.animation,e=this.group,s=this.xAxis,r=this.yAxis,n=s.pos,o=r.pos;i.renderer.isSVG&&(!0===a&&(a={duration:1e3}),t?e.attr({translateX:n+s.len/2,translateY:o+r.len/2,scaleX:.001,scaleY:.001}):(e.animate({translateX:n,translateY:o,scaleX:1,scaleY:1},a),this.animate=null))},animateDrilldown:function(t){var i,a=this.chart.plotBox,e=this.chart.drilldownLevels[this.chart.drilldownLevels.length-1],s=e.bBox,r=this.chart.options.drilldown.animation;t||(i=Math.min(s.width/a.width,s.height/a.height),e.shapeArgs={scaleX:i,scaleY:i,translateX:s.x,translateY:s.y},this.points.forEach(function(t){t.graphic&&t.graphic.attr(e.shapeArgs).animate({scaleX:1,scaleY:1,translateX:0,translateY:0},r)}),this.animate=null)},drawLegendSymbol:LegendSymbolMixin.drawRectangle,animateDrillupFrom:function(t){seriesTypes.column.prototype.animateDrillupFrom.call(this,t)},animateDrillupTo:function(t){seriesTypes.column.prototype.animateDrillupTo.call(this,t)}}),extend({applyOptions:function(t,i){var a,e=this.series,s=Point.prototype.applyOptions.call(this,t,i),r=e.joinBy;return e.mapData&&((a=void 0!==s[r[1]]&&e.mapMap[s[r[1]]])?(e.xyFromShape&&(s.x=a._midX,s.y=a._midY),extend(s,a)):s.value=s.value||null),s},onMouseOver:function(t){H.clearTimeout(this.colorInterval),null!==this.value||this.series.options.nullInteraction?Point.prototype.onMouseOver.call(this,t):this.series.onMouseOut(t)},zoomTo:function(){var t=this.series;t.xAxis.setExtremes(this._minX,this._maxX,!1),t.yAxis.setExtremes(this._minY,this._maxY,!1),t.chart.redraw()}},colorMapPointMixin));