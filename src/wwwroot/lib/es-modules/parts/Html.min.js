"use strict";import H from"./Globals.js";import U from"./Utilities.js";var attr=U.attr,defined=U.defined,extend=U.extend,pick=U.pick,pInt=U.pInt;import"./SvgRenderer.js";var createElement=H.createElement,css=H.css,isFirefox=H.isFirefox,isMS=H.isMS,isWebKit=H.isWebKit,SVGElement=H.SVGElement,SVGRenderer=H.SVGRenderer,win=H.win;extend(SVGElement.prototype,{htmlCss:function(t){var e,i="SPAN"===this.element.tagName&&t&&"width"in t,s=pick(i&&t.width,void 0);return i&&(delete t.width,this.textWidth=s,e=!0),t&&"ellipsis"===t.textOverflow&&(t.whiteSpace="nowrap",t.overflow="hidden"),this.styles=extend(this.styles,t),css(this.element,t),e&&this.htmlUpdateTransform(),this},htmlGetBBox:function(){var t=this.element;return{x:t.offsetLeft,y:t.offsetTop,width:t.offsetWidth,height:t.offsetHeight}},htmlUpdateTransform:function(){if(this.added){var t=this.renderer,e=this.element,i=this.translateX||0,s=this.translateY||0,n=this.x||0,r=this.y||0,o=this.textAlign||"left",a={left:0,center:.5,right:1}[o],h=this.styles,d=h&&h.whiteSpace;if(css(e,{marginLeft:i,marginTop:s}),!t.styledMode&&this.shadows&&this.shadows.forEach(function(t){css(t,{marginLeft:i+1,marginTop:s+1})}),this.inverted&&[].forEach.call(e.childNodes,function(i){t.invertChild(i,e)}),"SPAN"===e.tagName){var l,f=this.rotation,p=this.textWidth&&pInt(this.textWidth),c=[f,o,e.innerHTML,this.textWidth,this.textAlign].join(",");p!==this.oldTextWidth&&(p>this.oldTextWidth||(this.textPxLength||(css(e,{width:"",whiteSpace:d||"nowrap"}),e.offsetWidth))>p)&&(/[ \-]/.test(e.textContent||e.innerText)||"ellipsis"===e.style.textOverflow)?(css(e,{width:p+"px",display:"block",whiteSpace:d||"normal"}),this.oldTextWidth=p,this.hasBoxWidthChanged=!0):this.hasBoxWidthChanged=!1,c!==this.cTT&&(l=t.fontMetrics(e.style.fontSize,e).b,!defined(f)||f===(this.oldRotation||0)&&o===this.oldAlign||this.setSpanRotation(f,a,l),this.getSpanCorrection(!defined(f)&&this.textPxLength||e.offsetWidth,l,a,f,o)),css(e,{left:n+(this.xCorr||0)+"px",top:r+(this.yCorr||0)+"px"}),this.cTT=c,this.oldRotation=f,this.oldAlign=o}}else this.alignOnAdd=!0},setSpanRotation:function(t,e,i){var s={},n=this.renderer.getTransformKey();s[n]=s.transform="rotate("+t+"deg)",s[n+(isFirefox?"Origin":"-origin")]=s.transformOrigin=100*e+"% "+i+"px",css(this.element,s)},getSpanCorrection:function(t,e,i){this.xCorr=-t*i,this.yCorr=-e}}),extend(SVGRenderer.prototype,{getTransformKey:function(){return isMS&&!/Edge/.test(win.navigator.userAgent)?"-ms-transform":isWebKit?"-webkit-transform":isFirefox?"MozTransform":win.opera?"-o-transform":""},html:function(t,e,i){var s=this.createElement("span"),n=s.element,r=s.renderer,o=r.isSVG,a=function(t,e){["opacity","visibility"].forEach(function(i){t[i+"Setter"]=function(s,n,r){var o=t.div?t.div.style:e;SVGElement.prototype[i+"Setter"].call(this,s,n,r),o&&(o[n]=s)}}),t.addedSetters=!0};return s.textSetter=function(t){t!==n.innerHTML&&(delete this.bBox,delete this.oldTextWidth),this.textStr=t,n.innerHTML=pick(t,""),s.doTransform=!0},o&&a(s,s.element.style),s.xSetter=s.ySetter=s.alignSetter=s.rotationSetter=function(t,e){"align"===e&&(e="textAlign"),s[e]=t,s.doTransform=!0},s.afterSetters=function(){this.doTransform&&(this.htmlUpdateTransform(),this.doTransform=!1)},s.attr({text:t,x:Math.round(e),y:Math.round(i)}).css({position:"absolute"}),r.styledMode||s.css({fontFamily:this.style.fontFamily,fontSize:this.style.fontSize}),n.style.whiteSpace="nowrap",s.css=s.htmlCss,o&&(s.add=function(t){var e,i,o=r.box.parentNode,h=[];if(this.parentGroup=t,t){if(!(e=t.div)){for(i=t;i;)h.push(i),i=i.parentGroup;h.reverse().forEach(function(t){var i,n=attr(t.element,"class");function r(e,s){t[s]=e,"translateX"===s?i.left=e+"px":i.top=e+"px",t.doTransform=!0}e=t.div=t.div||createElement("div",n?{className:n}:void 0,{position:"absolute",left:(t.translateX||0)+"px",top:(t.translateY||0)+"px",display:t.display,opacity:t.opacity,pointerEvents:t.styles&&t.styles.pointerEvents},e||o),i=e.style,extend(t,{classSetter:function(t){return function(e){this.element.setAttribute("class",e),t.className=e}}(e),on:function(){return h[0].div&&s.on.apply({element:h[0].div},arguments),t},translateXSetter:r,translateYSetter:r}),t.addedSetters||a(t)})}}else e=o;return e.appendChild(n),s.added=!0,s.alignOnAdd&&s.htmlUpdateTransform(),s}),s}});