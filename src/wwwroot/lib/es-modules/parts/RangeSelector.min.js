"use strict";import H from"./Globals.js";import U from"./Utilities.js";var defined=U.defined,destroyObjectProperties=U.destroyObjectProperties,discardElement=U.discardElement,extend=U.extend,isNumber=U.isNumber,objectEach=U.objectEach,pick=U.pick,pInt=U.pInt,splat=U.splat;import"./Axis.js";import"./Chart.js";var addEvent=H.addEvent,Axis=H.Axis,Chart=H.Chart,css=H.css,createElement=H.createElement,defaultOptions=H.defaultOptions,fireEvent=H.fireEvent,merge=H.merge;function RangeSelector(t){this.init(t)}extend(defaultOptions,{rangeSelector:{verticalAlign:"top",buttonTheme:{width:28,height:18,padding:2,zIndex:7},floating:!1,x:0,y:0,height:void 0,inputPosition:{align:"right",x:0,y:0},buttonPosition:{align:"left",x:0,y:0},labelStyle:{color:"#666666"}}}),defaultOptions.lang=merge(defaultOptions.lang,{rangeSelectorZoom:"Zoom",rangeSelectorFrom:"From",rangeSelectorTo:"To"}),RangeSelector.prototype={clickButton:function(t,e){var n,i,o,a,r,s,l,u=this.chart,c=this.buttonOptions[t],d=u.xAxis[0],g=u.scroller&&u.scroller.getUnionExtremes()||d||{},p=g.dataMin,h=g.dataMax,m=d&&Math.round(Math.min(d.max,pick(h,d.max))),x=c.type,f=c._range,v=c.dataGrouping;if(null!==p&&null!==h){if(u.fixedRange=f,v&&(this.forcedDataGrouping=!0,Axis.prototype.setDataGrouping.call(d||{chart:this.chart},v,!1),this.frozenStates=c.preserveDataGrouping),"month"===x||"year"===x)d?(s={range:c,max:m,chart:u,dataMin:p,dataMax:h},n=d.minFromRange.call(s),isNumber(s.newMax)&&(m=s.newMax)):f=c;else if(f)n=Math.max(m-f,p),m=Math.min(n+f,h);else if("ytd"===x){if(!d)return void(this.deferredYTDClick=t);void 0===h&&(p=Number.MAX_VALUE,h=Number.MIN_VALUE,u.series.forEach(function(t){var e=t.xData;p=Math.min(e[0],p),h=Math.max(e[e.length-1],h)}),e=!1),n=o=(l=this.getYTDExtremes(h,p,u.time.useUTC)).min,m=l.max}else"all"===x&&d&&(n=p,m=h);n+=c._offsetMin,m+=c._offsetMax,this.setSelected(t),d?d.setExtremes(n,m,pick(e,1),null,{trigger:"rangeSelectorButton",rangeSelectorButton:c}):(i=splat(u.options.xAxis)[0],r=i.range,i.range=f,a=i.min,i.min=o,addEvent(u,"load",function(){i.range=r,i.min=a}))}},setSelected:function(t){this.selected=this.options.selected=t},defaultButtons:[{type:"month",count:1,text:"1m"},{type:"month",count:3,text:"3m"},{type:"month",count:6,text:"6m"},{type:"ytd",text:"YTD"},{type:"year",count:1,text:"1y"},{type:"all",text:"All"}],init:function(t){var e=this,n=t.options.rangeSelector,i=n.buttons||[].concat(e.defaultButtons),o=n.selected,a=function(){var t=e.minInput,n=e.maxInput;t&&t.blur&&fireEvent(t,"blur"),n&&n.blur&&fireEvent(n,"blur")};e.chart=t,e.options=n,e.buttons=[],e.buttonOptions=i,this.unMouseDown=addEvent(t.container,"mousedown",a),this.unResize=addEvent(t,"resize",a),i.forEach(e.computeButtonRange),void 0!==o&&i[o]&&this.clickButton(o,!1),addEvent(t,"load",function(){t.xAxis&&t.xAxis[0]&&addEvent(t.xAxis[0],"setExtremes",function(n){this.max-this.min!==t.fixedRange&&"rangeSelectorButton"!==n.trigger&&"updatedData"!==n.trigger&&e.forcedDataGrouping&&!e.frozenStates&&this.setDataGrouping(!1,!1)})})},updateButtonStates:function(){var t=this,e=this.chart,n=e.xAxis[0],i=Math.round(n.max-n.min),o=!n.hasVisibleSeries,a=e.scroller&&e.scroller.getUnionExtremes()||n,r=a.dataMin,s=a.dataMax,l=t.getYTDExtremes(s,r,e.time.useUTC),u=l.min,c=l.max,d=t.selected,g=isNumber(d),p=t.options.allButtonsEnabled,h=t.buttons;t.buttonOptions.forEach(function(e,a){var l,m,x=e._range,f=e.type,v=e.count||1,b=h[a],y=0,M=e._offsetMax-e._offsetMin,B=a===d,S=x>s-r,E=x<n.minRange,T=!1,w=!1,A=x===i;("month"===f||"year"===f)&&i+36e5>=864e5*{month:28,year:365}[f]*v-M&&i-36e5<=864e5*{month:31,year:366}[f]*v+M?A=!0:"ytd"===f?(A=c-u+M===i,T=!B):"all"===f&&(A=n.max-n.min>=s-r,w=!B&&g&&A),l=!p&&(S||E||w||o),m=B&&A||A&&!g&&!T||B&&t.frozenStates,l?y=3:m&&(g=!0,y=2),b.state!==y&&(b.setState(y),0===y&&d===a&&t.setSelected(null))})},computeButtonRange:function(t){var e=t.type,n=t.count||1,i={millisecond:1,second:1e3,minute:6e4,hour:36e5,day:864e5,week:6048e5};i[e]?t._range=i[e]*n:"month"!==e&&"year"!==e||(t._range=24*{month:30,year:365}[e]*36e5*n),t._offsetMin=pick(t.offsetMin,0),t._offsetMax=pick(t.offsetMax,0),t._range+=t._offsetMax-t._offsetMin},setInputValue:function(t,e){var n=this.chart.options.rangeSelector,i=this.chart.time,o=this[t+"Input"];defined(e)&&(o.previousValue=o.HCTime,o.HCTime=e),o.value=i.dateFormat(n.inputEditDateFormat||"%Y-%m-%d",o.HCTime),this[t+"DateBox"].attr({text:i.dateFormat(n.inputDateFormat||"%b %e, %Y",o.HCTime)})},showInput:function(t){var e=this.inputGroup,n=this[t+"DateBox"];css(this[t+"Input"],{left:e.translateX+n.x+"px",top:e.translateY+"px",width:n.width-2+"px",height:n.height-2+"px",border:"2px solid silver"})},hideInput:function(t){css(this[t+"Input"],{border:0,width:"1px",height:"1px"}),this.setInputValue(t)},drawInput:function(t){var e,n,i,o=this,a=o.chart,r=a.renderer.style||{},s=a.renderer,l=a.options.rangeSelector,u=defaultOptions.lang,c=o.div,d="min"===t,g=this.inputGroup;function p(){var t=e.value,n=(l.inputDateParser||Date.parse)(t),i=a.xAxis[0],r=a.scroller&&a.scroller.xAxis?a.scroller.xAxis:i,s=r.dataMin,u=r.dataMax;n!==e.previousValue&&(e.previousValue=n,isNumber(n)||(n=t.split("-"),n=Date.UTC(pInt(n[0]),pInt(n[1])-1,pInt(n[2]))),isNumber(n)&&(a.time.useUTC||(n+=60*(new Date).getTimezoneOffset()*1e3),d?n>o.maxInput.HCTime?n=void 0:n<s&&(n=s):n<o.minInput.HCTime?n=void 0:n>u&&(n=u),void 0!==n&&i.setExtremes(d?n:i.min,d?i.max:n,void 0,void 0,{trigger:"rangeSelectorInput"})))}this[t+"Label"]=n=s.label(u[d?"rangeSelectorFrom":"rangeSelectorTo"],this.inputGroup.offset).addClass("highcharts-range-label").attr({padding:2}).add(g),g.offset+=n.width+5,this[t+"DateBox"]=i=s.label("",g.offset).addClass("highcharts-range-input").attr({padding:2,width:l.inputBoxWidth||90,height:l.inputBoxHeight||17,"text-align":"center"}).on("click",function(){o.showInput(t),o[t+"Input"].focus()}),a.styledMode||i.attr({stroke:l.inputBoxBorderColor||"#cccccc","stroke-width":1}),i.add(g),g.offset+=i.width+(d?10:0),this[t+"Input"]=e=createElement("input",{name:t,className:"highcharts-range-selector",type:"text"},{top:a.plotTop+"px"},c),a.styledMode||(n.css(merge(r,l.labelStyle)),i.css(merge({color:"#333333"},r,l.inputStyle)),css(e,extend({position:"absolute",border:0,width:"1px",height:"1px",padding:0,textAlign:"center",fontSize:r.fontSize,fontFamily:r.fontFamily,top:"-9999em"},l.inputStyle))),e.onfocus=function(){o.showInput(t)},e.onblur=function(){e===H.doc.activeElement&&p(),o.hideInput(t),e.blur()},e.onchange=p,e.onkeypress=function(t){13===t.keyCode&&p()}},getPosition:function(){var t=this.chart,e=t.options.rangeSelector,n="top"===e.verticalAlign?t.plotTop-t.axisOffset[0]:0;return{buttonTop:n+e.buttonPosition.y,inputTop:n+e.inputPosition.y-10}},getYTDExtremes:function(t,e,n){var i,o=this.chart.time,a=new o.Date(t),r=o.get("FullYear",a),s=n?o.Date.UTC(r,0,1):+new o.Date(r,0,1);return i=Math.max(e||0,s),a=a.getTime(),{max:Math.min(t||a,a),min:i}},render:function(t,e){var n,i,o,a,r,s=this,l=s.chart,u=l.renderer,c=l.container,d=l.options,g=d.exporting&&!1!==d.exporting.enabled&&d.navigation&&d.navigation.buttonOptions,p=defaultOptions.lang,h=s.div,m=d.rangeSelector,x=pick(d.chart.style&&d.chart.style.zIndex,0)+1,f=m.floating,v=s.buttons,b=s.inputGroup,y=m.buttonTheme,M=m.buttonPosition,B=m.inputPosition,S=m.inputEnabled,E=y&&y.states,T=l.plotLeft,w=s.buttonGroup,A=s.rendered,I=s.options.verticalAlign,C=l.legend,D=C&&C.options,k=M.y,O=B.y,H=A||!1,U=H?"animate":"attr",N=0,R=0;if(!1!==m.enabled){var Y,z,G,_;if(A||(s.group=i=u.g("range-selector-group").attr({zIndex:7}).add(),s.buttonGroup=w=u.g("range-selector-buttons").add(i),s.zoomText=u.text(p.rangeSelectorZoom,0,15).add(w),l.styledMode||(s.zoomText.css(m.labelStyle),y["stroke-width"]=pick(y["stroke-width"],0)),s.buttonOptions.forEach(function(t,e){v[e]=u.button(t.text,0,0,function(n){var i,o=t.events&&t.events.click;o&&(i=o.call(t,n)),!1!==i&&s.clickButton(e),s.isActive=!0},y,E&&E.hover,E&&E.select,E&&E.disabled).attr({"text-align":"center"}).add(w)}),!1!==S&&(s.div=h=createElement("div",null,{position:"relative",height:0,zIndex:x}),c.parentNode.insertBefore(h,c),s.inputGroup=b=u.g("input-group").add(i),b.offset=0,s.drawInput("min"),s.drawInput("max"))),s.zoomText[U]({x:pick(T+M.x,T)}),n=pick(T+M.x,T)+s.zoomText.getBBox().width+5,s.buttonOptions.forEach(function(t,e){v[e][U]({x:n}),n+=v[e].width+pick(m.buttonSpacing,5)}),T=l.plotLeft-l.spacing[3],s.updateButtonStates(),g&&this.titleCollision(l)&&"top"===I&&"right"===M.align&&M.y+w.getBBox().height-12<(g.y||0)+g.height&&(N=-40),"left"===M.align?r=M.x-l.spacing[3]:"right"===M.align&&(r=M.x+N-l.spacing[1]),w.align({y:M.y,width:w.getBBox().width,align:M.align,x:r},!0,l.spacingBox),s.group.placed=H,s.buttonGroup.placed=H,!1!==S)N=g&&this.titleCollision(l)&&"top"===I&&"right"===B.align&&B.y-b.getBBox().height-12<(g.y||0)+g.height+l.spacing[0]?-40:0,"left"===B.align?r=T:"right"===B.align&&(r=-Math.max(l.axisOffset[1],-N)),b.align({y:B.y,width:b.getBBox().width,align:B.align,x:B.x+r-2},!0,l.spacingBox),Y=b.alignAttr.translateX+b.alignOptions.x-N+b.getBBox().x+2,z=b.alignOptions.width,G=w.alignAttr.translateX+w.getBBox().x,_=w.getBBox().width+20,(B.align===M.align||G+_>Y&&Y+z>G&&k<O+b.getBBox().height)&&b.attr({translateX:b.alignAttr.translateX+(l.axisOffset[1]>=-N?0:-N),translateY:b.alignAttr.translateY+w.getBBox().height+10}),s.setInputValue("min",t),s.setInputValue("max",e),s.inputGroup.placed=H;s.group.align({verticalAlign:I},!0,l.spacingBox),o=s.group.getBBox().height+20,a=s.group.alignAttr.translateY,"bottom"===I&&(R=a-(o=o+(D&&"bottom"===D.verticalAlign&&D.enabled&&!D.floating?C.legendHeight+pick(D.margin,10):0)-20)-(f?0:m.y)-(l.titleOffset?l.titleOffset[2]:0)-10),"top"===I?(f&&(R=0),l.titleOffset&&l.titleOffset[0]&&(R=l.titleOffset[0]),R+=l.margin[0]-l.spacing[0]||0):"middle"===I&&(O===k?R=O<0?a+void 0:a:(O||k)&&(O<0||k<0?R-=Math.min(O,k):R=a-o+void 0)),s.group.translate(m.x,m.y+Math.floor(R)),!1!==S&&(s.minInput.style.marginTop=s.group.translateY+"px",s.maxInput.style.marginTop=s.group.translateY+"px"),s.rendered=!0}},getHeight:function(){var t,e=this.options,n=this.group,i=e.inputPosition,o=e.buttonPosition,a=e.y,r=o.y,s=i.y,l=0;return e.height?e.height:(l=n?n.getBBox(!0).height+13+a:0,t=Math.min(s,r),(s<0&&r<0||s>0&&r>0)&&(l+=Math.abs(t)),l)},titleCollision:function(t){return!(t.options.title.text||t.options.subtitle.text)},update:function(t){var e=this.chart;merge(!0,e.options.rangeSelector,t),this.destroy(),this.init(e),e.rangeSelector.render()},destroy:function(){var t=this,e=t.minInput,n=t.maxInput;t.unMouseDown(),t.unResize(),destroyObjectProperties(t.buttons),e&&(e.onfocus=e.onblur=e.onchange=null),n&&(n.onfocus=n.onblur=n.onchange=null),objectEach(t,function(e,n){e&&"chart"!==n&&(e.destroy?e.destroy():e.nodeType&&discardElement(this[n])),e!==RangeSelector.prototype[n]&&(t[n]=null)},this)}},Axis.prototype.minFromRange=function(){var t,e,n,i=this.range,o={month:"Month",year:"FullYear"}[i.type],a=this.max,r=this.chart.time,s=function(t,e){var n=new r.Date(t),i=r.get(o,n);return r.set(o,n,i+e),i===r.get(o,n)&&r.set("Date",n,0),n.getTime()-t};return isNumber(i)?(t=a-i,n=i):(t=a+s(a,-i.count),this.chart&&(this.chart.fixedRange=a-t)),e=pick(this.dataMin,Number.MIN_VALUE),isNumber(t)||(t=e),t<=e&&(t=e,void 0===n&&(n=s(t,i.count)),this.newMax=Math.min(t+n,this.dataMax)),isNumber(a)||(t=void 0),t},H.RangeSelector||(addEvent(Chart,"afterGetContainer",function(){this.options.rangeSelector.enabled&&(this.rangeSelector=new RangeSelector(this))}),addEvent(Chart,"beforeRender",function(){var t,e=this.axes,n=this.rangeSelector;n&&(isNumber(n.deferredYTDClick)&&(n.clickButton(n.deferredYTDClick),delete n.deferredYTDClick),e.forEach(function(t){t.updateNames(),t.setScale()}),this.getAxisMargins(),n.render(),t=n.options.verticalAlign,n.options.floating||("bottom"===t?this.extraBottomMargin=!0:"middle"!==t&&(this.extraTopMargin=!0)))}),addEvent(Chart,"update",function(t){var e,n=t.options.rangeSelector,i=this.rangeSelector,o=this.extraBottomMargin,a=this.extraTopMargin;n&&n.enabled&&!defined(i)&&(this.options.rangeSelector.enabled=!0,this.rangeSelector=new RangeSelector(this)),this.extraBottomMargin=!1,this.extraTopMargin=!1,i&&(i.render(),e=n&&n.verticalAlign||i.options&&i.options.verticalAlign,i.options.floating||("bottom"===e?this.extraBottomMargin=!0:"middle"!==e&&(this.extraTopMargin=!0)),this.extraBottomMargin===o&&this.extraTopMargin===a||(this.isDirtyBox=!0))}),addEvent(Chart,"render",function(){var t,e=this.rangeSelector;e&&!e.options.floating&&(e.render(),"bottom"===(t=e.options.verticalAlign)?this.extraBottomMargin=!0:"middle"!==t&&(this.extraTopMargin=!0))}),addEvent(Chart,"getMargins",function(){var t,e=this.rangeSelector;e&&(t=e.getHeight(),this.extraTopMargin&&(this.plotTop+=t),this.extraBottomMargin&&(this.marginBottom+=t))}),Chart.prototype.callbacks.push(function(t){var e,n,i,o=t.rangeSelector;function a(){e=t.xAxis[0].getExtremes(),isNumber(e.min)&&o.render(e.min,e.max)}o&&(i=addEvent(t.xAxis[0],"afterSetExtremes",function(t){o.render(t.min,t.max)}),n=addEvent(t,"redraw",a),a()),addEvent(t,"destroy",function(){o&&(n(),i())})}),H.RangeSelector=RangeSelector);