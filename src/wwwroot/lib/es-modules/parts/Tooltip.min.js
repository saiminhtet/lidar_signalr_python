"use strict";import H from"./Globals.js";import U from"./Utilities.js";var defined=U.defined,discardElement=U.discardElement,extend=U.extend,isNumber=U.isNumber,isString=U.isString,pick=U.pick,splat=U.splat,syncTimeout=U.syncTimeout,doc=H.doc,format=H.format,merge=H.merge,timeUnits=H.timeUnits;H.Tooltip=function(){this.init.apply(this,arguments)},H.Tooltip.prototype={init:function(t,e){this.chart=t,this.options=e,this.crosshairs=[],this.now={x:0,y:0},this.isHidden=!0,this.split=e.split&&!t.inverted,this.shared=e.shared||this.split,this.outside=pick(e.outside,Boolean(t.scrollablePixelsX||t.scrollablePixelsY))},cleanSplit:function(t){this.chart.series.forEach(function(e){var i=e&&e.tt;i&&(!i.isActive||t?e.tt=i.destroy():i.isActive=!1)})},applyFilter:function(){var t=this.chart;t.renderer.definition({tagName:"filter",id:"drop-shadow-"+t.index,opacity:.5,children:[{tagName:"feGaussianBlur",in:"SourceAlpha",stdDeviation:1},{tagName:"feOffset",dx:1,dy:1},{tagName:"feComponentTransfer",children:[{tagName:"feFuncA",type:"linear",slope:.3}]},{tagName:"feMerge",children:[{tagName:"feMergeNode"},{tagName:"feMergeNode",in:"SourceGraphic"}]}]}),t.renderer.definition({tagName:"style",textContent:".highcharts-tooltip-"+t.index+"{filter:url(#drop-shadow-"+t.index+")}"})},getLabel:function(){var t,e,i=this,o=this.chart.renderer,s=this.chart.styledMode,r=this.options,a="tooltip"+(defined(r.className)?" "+r.className:"");return this.label||(this.outside&&(this.container=t=H.doc.createElement("div"),t.className="highcharts-tooltip-container",H.css(t,{position:"absolute",top:"1px",pointerEvents:r.style&&r.style.pointerEvents,zIndex:3}),H.doc.body.appendChild(t),this.renderer=o=new H.Renderer(t,0,0,{},void 0,void 0,o.styledMode)),this.split?this.label=o.g(a):(this.label=o.label("",0,0,r.shape||"callout",null,null,r.useHTML,null,a).attr({padding:r.padding,r:r.borderRadius}),s||this.label.attr({fill:r.backgroundColor,"stroke-width":r.borderWidth}).css(r.style).shadow(r.shadow)),s&&(this.applyFilter(),this.label.addClass("highcharts-tooltip-"+this.chart.index)),i.outside&&!i.split&&(e={x:this.label.xSetter,y:this.label.ySetter},this.label.xSetter=function(o,s){e[s].call(this.label,i.distance),t.style.left=o+"px"},this.label.ySetter=function(o,s){e[s].call(this.label,i.distance),t.style.top=o+"px"}),this.label.attr({zIndex:8}).add()),this.label},update:function(t){this.destroy(),merge(!0,this.chart.options.tooltip.userOptions,t),this.init(this.chart,merge(!0,this.options,t))},destroy:function(){this.label&&(this.label=this.label.destroy()),this.split&&this.tt&&(this.cleanSplit(this.chart,!0),this.tt=this.tt.destroy()),this.renderer&&(this.renderer=this.renderer.destroy(),discardElement(this.container)),H.clearTimeout(this.hideTimer),H.clearTimeout(this.tooltipTimeout)},move:function(t,e,i,o){var s=this,r=s.now,a=!1!==s.options.animation&&!s.isHidden&&(Math.abs(t-r.x)>1||Math.abs(e-r.y)>1),n=s.followPointer||s.len>1;extend(r,{x:a?(2*r.x+t)/3:t,y:a?(r.y+e)/2:e,anchorX:n?void 0:a?(2*r.anchorX+i)/3:i,anchorY:n?void 0:a?(r.anchorY+o)/2:o}),s.getLabel().attr(r),a&&(H.clearTimeout(this.tooltipTimeout),this.tooltipTimeout=setTimeout(function(){s&&s.move(t,e,i,o)},32))},hide:function(t){var e=this;H.clearTimeout(this.hideTimer),t=pick(t,this.options.hideDelay,500),this.isHidden||(this.hideTimer=syncTimeout(function(){e.getLabel()[t?"fadeOut":"hide"](),e.isHidden=!0},t))},getAnchor:function(t,e){var i,o,s,r=this.chart,a=r.pointer,n=r.inverted,l=r.plotTop,h=r.plotLeft,d=0,c=0;return t=splat(t),this.followPointer&&e?(void 0===e.chartX&&(e=a.normalize(e)),i=[e.chartX-r.plotLeft,e.chartY-l]):t[0].tooltipPos?i=t[0].tooltipPos:(t.forEach(function(t){o=t.series.yAxis,s=t.series.xAxis,d+=t.plotX+(!n&&s?s.left-h:0),c+=(t.plotLow?(t.plotLow+t.plotHigh)/2:t.plotY)+(!n&&o?o.top-l:0)}),d/=t.length,c/=t.length,i=[n?r.plotWidth-c:d,this.shared&&!n&&t.length>1&&e?e.chartY-l:n?r.plotHeight-d:c]),i.map(Math.round)},getPosition:function(t,e,i){var o,s=this.chart,r=this.distance,a={},n=s.inverted&&i.h||0,l=this.outside,h=l?doc.documentElement.clientWidth-2*r:s.chartWidth,d=l?Math.max(doc.body.scrollHeight,doc.documentElement.scrollHeight,doc.body.offsetHeight,doc.documentElement.offsetHeight,doc.documentElement.clientHeight):s.chartHeight,c=s.pointer.getChartPosition(),p=s.containerScaling,f=function(t){return p?t*p.scaleX:t},u=function(t){return p?t*p.scaleY:t},m=function(o){var a="x"===o;return[o,a?h:d,a?t:e].concat(l?[a?f(t):u(e),a?c.left-r+f(i.plotX+s.plotLeft):c.top-r+u(i.plotY+s.plotTop),0,a?h:d]:[a?t:e,a?i.plotX+s.plotLeft:i.plotY+s.plotTop,a?s.plotLeft:s.plotTop,a?s.plotLeft+s.plotWidth:s.plotTop+s.plotHeight])},g=m("y"),x=m("x"),y=!this.followPointer&&pick(i.ttBelow,!s.inverted==!!i.negative),b=function(t){var e=g;g=x,x=e,o=t},v=function(){!1!==function(t,e,i,o,s,l,h){var d="y"===t?u(r):f(r),c=(i-o)/2,p=o<s-r,m=s+r+o<e,g=s-d-i+c,x=s+d-c;if(y&&m)a[t]=x;else if(!y&&p)a[t]=g;else if(p)a[t]=Math.min(h-o,g-n<0?g:g-n);else{if(!m)return!1;a[t]=Math.max(l,x+n+i>e?x:x+n)}}.apply(0,g)?!1!==function(t,e,i,o,s){var n;return s<r||s>e-r?n=!1:a[t]=s<i/2?1:s>e-o/2?e-o-2:s-i/2,n}.apply(0,x)||o||(b(!0),v()):o?a.x=a.y=0:(b(!0),v())};return(s.inverted||this.len>1)&&b(),v(),a},defaultFormatter:function(t){var e,i=this.points||splat(this);return(e=(e=[t.tooltipFooterHeaderFormatter(i[0])]).concat(t.bodyFormatter(i))).push(t.tooltipFooterHeaderFormatter(i[0],!0)),e},refresh:function(t,e){var i,o,s,r,a,n=this.chart,l=this.options,h=t,d={},c=[],p=l.formatter||this.defaultFormatter,f=this.shared,u=n.styledMode;if(l.enabled){if(H.clearTimeout(this.hideTimer),this.followPointer=splat(h)[0].series.tooltipOptions.followPointer,i=(s=this.getAnchor(h,e))[0],o=s[1],!f||h.series&&h.series.noSharedTooltip?d=h.getLabelConfig():(n.pointer.applyInactiveState(h),h.forEach(function(t){t.setState("hover"),c.push(t.getLabelConfig())}),(d={x:h[0].category,y:h[0].y}).points=c,h=h[0]),this.len=c.length,r=p.call(d,this),a=h.series,this.distance=pick(a.tooltipOptions.distance,16),!1===r)this.hide();else{if(this.split)this.renderSplit(r,splat(t));else{var m=this.getLabel();l.style.width&&!u||m.css({width:this.chart.spacingBox.width}),m.attr({text:r&&r.join?r.join(""):r}),m.removeClass(/highcharts-color-[\d]+/g).addClass("highcharts-color-"+pick(h.colorIndex,a.colorIndex)),u||m.attr({stroke:l.borderColor||h.color||a.color||"#666666"}),this.updatePosition({plotX:i,plotY:o,negative:h.negative,ttBelow:h.ttBelow,h:s[2]||0})}this.isHidden&&this.label&&this.label.attr({opacity:1}).show(),this.isHidden=!1}H.fireEvent(this,"refresh")}},renderSplit:function(t,e){var i,o=this,s=[],r=this.chart,a=r.renderer,n=!0,l=this.options,h=0,d=this.getLabel(),c=r.plotTop;isString(t)&&(t=[!1,t]),t.slice(0,e.length+1).forEach(function(t,p){if(!1!==t&&""!==t){var f,u,m,g,x,y=e[p-1]||{isHeader:!0,plotX:e[0].plotX,plotY:r.plotHeight},b=y.series||o,v=b.tt,H=y.series||{},w="highcharts-color-"+pick(y.colorIndex,H.colorIndex,"none");if(v||(x={padding:l.padding,r:l.borderRadius},r.styledMode||(x.fill=l.backgroundColor,x["stroke-width"]=l.borderWidth),b.tt=v=a.label(null,null,null,(y.isHeader?l.headerShape:l.shape)||"callout",null,null,l.useHTML).addClass(y.isHeader?"highcharts-tooltip-header ":"highcharts-tooltip-box "+w).attr(x).add(d)),v.isActive=!0,v.attr({text:t}),r.styledMode||v.css(l.style).shadow(l.shadow).attr({stroke:l.borderColor||y.color||H.color||"#333333"}),g=(m=v.getBBox()).width+v.strokeWidth(),y.isHeader?(h=m.height,r.xAxis[0].opposite&&(i=!0,c-=h),u=Math.max(0,Math.min(y.plotX+r.plotLeft-g/2,r.chartWidth+(r.scrollablePixelsX?r.scrollablePixelsX-r.marginRight:0)-g))):u=y.plotX+r.plotLeft-pick(l.distance,16)-g,u<0&&(n=!1),y.isHeader)f=i?-h:r.plotHeight+h;else{var T=H.yAxis;f=T.pos-c+Math.max(0,Math.min(y.plotY||0,T.len))}s.push({target:f,rank:y.isHeader?1:0,size:b.tt.getBBox().height+1,point:y,x:u,tt:v})}}),this.cleanSplit(),l.positioner&&s.forEach(function(t){var e=l.positioner.call(o,t.tt.getBBox().width,t.size,t.point);t.x=e.x,t.align=0,t.target=e.y,t.rank=pick(e.rank,t.rank)}),H.distribute(s,r.plotHeight+h),s.forEach(function(t){var e=t.point,i=e.series,s=i&&i.yAxis;t.tt.attr({visibility:void 0===t.pos?"hidden":"inherit",x:n||e.isHeader||l.positioner?t.x:e.plotX+r.plotLeft+o.distance,y:t.pos+c,anchorX:e.isHeader?e.plotX+r.plotLeft:e.plotX+i.xAxis.pos,anchorY:e.isHeader?r.plotTop+r.plotHeight/2:s.pos+Math.max(0,Math.min(e.plotY,s.len))})});var p=o.container,f=o.outside,u=o.renderer;if(f&&p&&u){var m=r.pointer.getChartPosition();p.style.left=m.left+"px",p.style.top=m.top+"px";var g=d.getBBox(),x=g.width,y=g.height,b=g.x,v=g.y;u.setSize(x+b,y+v,!1)}},updatePosition:function(t){var e,i,o=this.chart,s=o.pointer,r=this.getLabel(),a=t.plotX+o.plotLeft,n=t.plotY+o.plotTop,l=s.getChartPosition();if(e=(this.options.positioner||this.getPosition).call(this,r.width,r.height,t),this.outside){i=(this.options.borderWidth||0)+2*this.distance,this.renderer.setSize(r.width+i,r.height+i,!1);var h=o.containerScaling;h&&(H.css(this.container,{transform:"scale("+h.scaleX+", "+h.scaleY+")"}),a*=h.scaleX,n*=h.scaleY),a+=l.left-e.x,n+=l.top-e.y}this.move(Math.round(e.x),Math.round(e.y||0),a,n)},getDateFormat:function(t,e,i,o){var s,r,a=this.chart.time,n=a.dateFormat("%m-%d %H:%M:%S.%L",e),l="01-01 00:00:00.000",h={millisecond:15,second:12,minute:9,hour:6,day:3},d="millisecond";for(r in timeUnits){if(t===timeUnits.week&&+a.dateFormat("%w",e)===i&&n.substr(6)===l.substr(6)){r="week";break}if(timeUnits[r]>t){r=d;break}if(h[r]&&n.substr(h[r])!==l.substr(h[r]))break;"week"!==r&&(d=r)}return r&&(s=a.resolveDTLFormat(o[r]).main),s},getXDateFormat:function(t,e,i){var o=e.dateTimeLabelFormats,s=i&&i.closestPointRange;return(s?this.getDateFormat(s,t.x,i.options.startOfWeek,o):o.day)||o.year},tooltipFooterHeaderFormatter:function(t,e){var i=e?"footer":"header",o=t.series,s=o.tooltipOptions,r=s.xDateFormat,a=o.xAxis,n=a&&"datetime"===a.options.type&&isNumber(t.key),l=s[i+"Format"],h={isFooter:e,labelConfig:t};return H.fireEvent(this,"headerFormatter",h,function(e){n&&!r&&(r=this.getXDateFormat(t,s,a)),n&&r&&(t.point&&t.point.tooltipDateKeys||["key"]).forEach(function(t){l=l.replace("{point."+t+"}","{point."+t+":"+r+"}")}),o.chart.styledMode&&(l=this.styledModeFormat(l)),e.text=format(l,{point:t,series:o},this.chart.time)}),h.text},bodyFormatter:function(t){return t.map(function(t){var e=t.series.tooltipOptions;return(e[(t.point.formatPrefix||"point")+"Formatter"]||t.point.tooltipFormatter).call(t.point,e[(t.point.formatPrefix||"point")+"Format"]||"")})},styledModeFormat:function(t){return t.replace('style="font-size: 10px"','class="highcharts-header"').replace(/style="color:{(point|series)\.color}"/g,'class="highcharts-color-{$1.colorIndex}"')}};