"use strict";import Highcharts from"./Globals.js";import U from"./Utilities.js";var attr=U.attr,defined=U.defined,extend=U.extend,isNumber=U.isNumber,isObject=U.isObject,objectEach=U.objectEach,pick=U.pick,splat=U.splat;import"./Tooltip.js";import"./Color.js";var H=Highcharts,addEvent=H.addEvent,charts=H.charts,color=H.color,css=H.css,find=H.find,fireEvent=H.fireEvent,offset=H.offset,Tooltip=H.Tooltip;Highcharts.Pointer=function(t,e){this.init(t,e)},Highcharts.Pointer.prototype={init:function(t,e){this.options=e,this.chart=t,this.runChartClick=e.chart.events&&!!e.chart.events.click,this.pinchDown=[],this.lastValidTouch={},Tooltip&&(t.tooltip=new Tooltip(t,e.tooltip),this.followTouchMove=pick(e.tooltip.followTouchMove,!0)),this.setDOMEvents()},zoomOption:function(t){var e,o,i=this.chart,n=i.options.chart,r=n.zoomType||"",s=i.inverted;/touch/.test(t.type)&&(r=pick(n.pinchType,r)),this.zoomX=e=/x/.test(r),this.zoomY=o=/y/.test(r),this.zoomHor=e&&!s||o&&s,this.zoomVert=o&&!s||e&&s,this.hasZoom=e||o},getChartPosition:function(){return this.chartPosition||(this.chartPosition=offset(this.chart.container))},normalize:function(t,e){var o;o=t.touches?t.touches.length?t.touches.item(0):t.changedTouches[0]:t,e||(e=this.getChartPosition());var i=o.pageX-e.left,n=o.pageY-e.top,r=this.chart.containerScaling;return r&&(i/=r.scaleX,n/=r.scaleY),extend(t,{chartX:Math.round(i),chartY:Math.round(n)})},getCoordinates:function(t){var e={xAxis:[],yAxis:[]};return this.chart.axes.forEach(function(o){e[o.isXAxis?"xAxis":"yAxis"].push({axis:o,value:o.toValue(t[o.horiz?"chartX":"chartY"])})}),e},findNearestKDPoint:function(t,e,o){var i;return t.forEach(function(t){var n,r,s,a,h,c=!(t.noSharedTooltip&&e)&&t.options.findNearestPointBy.indexOf("y")<0,u=t.searchPoint(o,c);isObject(u,!0)&&(!isObject(i,!0)||(r=u,s=(n=i).distX-r.distX,a=n.dist-r.dist,h=(r.series.group&&r.series.group.zIndex)-(n.series.group&&n.series.group.zIndex),(0!==s&&e?s:0!==a?a:0!==h?h:n.series.index>r.series.index?-1:1)>0))&&(i=u)}),i},getPointFromEvent:function(t){for(var e,o=t.target;o&&!e;)e=o.point,o=o.parentNode;return e},getChartCoordinatesFromPoint:function(t,e){var o=t.series,i=o.xAxis,n=o.yAxis,r=pick(t.clientX,t.plotX),s=t.shapeArgs;return i&&n?e?{chartX:i.len+i.pos-r,chartY:n.len+n.pos-t.plotY}:{chartX:r+i.pos,chartY:t.plotY+n.pos}:s&&s.x&&s.y?{chartX:s.x,chartY:s.y}:void 0},getHoverData:function(t,e,o,i,n,r){var s,a=[],h=e,c=!(!i||!t),u=h&&!h.stickyTracking,l=function(t){return t.visible&&!(!n&&t.directTouch)&&pick(t.options.enableMouseTracking,!0)},d=u?[h]:o.filter(function(t){return l(t)&&t.stickyTracking});return h=(s=c||!r?t:this.findNearestKDPoint(d,n,r))&&s.series,s&&(n&&!h.noSharedTooltip?(d=o.filter(function(t){return l(t)&&!t.noSharedTooltip})).forEach(function(t){var e=find(t.points,function(t){return t.x===s.x&&!t.isNull});isObject(e)&&(t.chart.isBoosting&&(e=t.getPoint(e)),a.push(e))}):a.push(s)),{hoverPoint:s,hoverSeries:h,hoverPoints:a}},runPointActions:function(t,e){var o,i,n,r,s=this.chart,a=s.series,h=s.tooltip&&s.tooltip.options.enabled?s.tooltip:void 0,c=!!h&&h.shared,u=e||s.hoverPoint,l=u&&u.series||s.hoverSeries,d=(!t||"touchmove"!==t.type)&&(!!e||l&&l.directTouch&&this.isDirectTouch),p=this.getHoverData(u,l,a,d,c,t);if(u=p.hoverPoint,r=p.hoverPoints,i=(l=p.hoverSeries)&&l.tooltipOptions.followPointer,o=c&&l&&!l.noSharedTooltip,u&&(u!==s.hoverPoint||h&&h.isHidden)){if((s.hoverPoints||[]).forEach(function(t){-1===r.indexOf(t)&&t.setState()}),s.hoverSeries!==l&&l.onMouseOver(),this.applyInactiveState(r),(r||[]).forEach(function(t){t.setState("hover")}),s.hoverPoint&&s.hoverPoint.firePointEvent("mouseOut"),!u.series)return;u.firePointEvent("mouseOver"),s.hoverPoints=r,s.hoverPoint=u,h&&h.refresh(o?r:u,t)}else i&&h&&!h.isHidden&&(n=h.getAnchor([{}],t),h.updatePosition({plotX:n[0],plotY:n[1]}));this.unDocMouseMove||(this.unDocMouseMove=addEvent(s.container.ownerDocument,"mousemove",function(t){var e=charts[H.hoverChartIndex];e&&e.pointer.onDocumentMouseMove(t)})),s.axes.forEach(function(e){var o=pick(e.crosshair.snap,!0),i=o?H.find(r,function(t){return t.series[e.coll]===e}):void 0;i||!o?e.drawCrosshair(t,i):e.hideCrosshair()})},applyInactiveState:function(t){var e,o=[];(t||[]).forEach(function(t){e=t.series,o.push(e),e.linkedParent&&o.push(e.linkedParent),e.linkedSeries&&(o=o.concat(e.linkedSeries)),e.navigatorSeries&&o.push(e.navigatorSeries)}),this.chart.series.forEach(function(t){-1===o.indexOf(t)?t.setState("inactive",!0):t.options.inactiveOtherPoints&&t.setAllPointsToState("inactive")})},reset:function(t,e){var o=this.chart,i=o.hoverSeries,n=o.hoverPoint,r=o.hoverPoints,s=o.tooltip,a=s&&s.shared?r:n;t&&a&&splat(a).forEach(function(e){e.series.isCartesian&&void 0===e.plotX&&(t=!1)}),t?s&&a&&splat(a).length&&(s.refresh(a),s.shared&&r?r.forEach(function(t){t.setState(t.state,!0),t.series.isCartesian&&(t.series.xAxis.crosshair&&t.series.xAxis.drawCrosshair(null,t),t.series.yAxis.crosshair&&t.series.yAxis.drawCrosshair(null,t))}):n&&(n.setState(n.state,!0),o.axes.forEach(function(t){t.crosshair&&t.drawCrosshair(null,n)}))):(n&&n.onMouseOut(),r&&r.forEach(function(t){t.setState()}),i&&i.onMouseOut(),s&&s.hide(e),this.unDocMouseMove&&(this.unDocMouseMove=this.unDocMouseMove()),o.axes.forEach(function(t){t.hideCrosshair()}),this.hoverX=o.hoverPoints=o.hoverPoint=null)},scaleGroups:function(t,e){var o,i=this.chart;i.series.forEach(function(n){o=t||n.getPlotBox(),n.xAxis&&n.xAxis.zoomEnabled&&n.group&&(n.group.attr(o),n.markerGroup&&(n.markerGroup.attr(o),n.markerGroup.clip(e?i.clipRect:null)),n.dataLabelsGroup&&n.dataLabelsGroup.attr(o))}),i.clipRect.attr(e||i.clipBox)},dragStart:function(t){var e=this.chart;e.mouseIsDown=t.type,e.cancelClick=!1,e.mouseDownX=this.mouseDownX=t.chartX,e.mouseDownY=this.mouseDownY=t.chartY},drag:function(t){var e,o,i=this.chart,n=i.options.chart,r=t.chartX,s=t.chartY,a=this.zoomHor,h=this.zoomVert,c=i.plotLeft,u=i.plotTop,l=i.plotWidth,d=i.plotHeight,p=this.selectionMarker,v=this.mouseDownX,f=this.mouseDownY,m=n.panKey&&t[n.panKey+"Key"];p&&p.touch||(r<c?r=c:r>c+l&&(r=c+l),s<u?s=u:s>u+d&&(s=u+d),this.hasDragged=Math.sqrt(Math.pow(v-r,2)+Math.pow(f-s,2)),this.hasDragged>10&&(e=i.isInsidePlot(v-c,f-u),i.hasCartesianSeries&&(this.zoomX||this.zoomY)&&e&&!m&&(p||(this.selectionMarker=p=i.renderer.rect(c,u,a?1:l,h?1:d,0).attr({class:"highcharts-selection-marker",zIndex:7}).add(),i.styledMode||p.attr({fill:n.selectionMarkerFill||color("#335cad").setOpacity(.25).get()}))),p&&a&&(o=r-v,p.attr({width:Math.abs(o),x:(o>0?0:o)+v})),p&&h&&(o=s-f,p.attr({height:Math.abs(o),y:(o>0?0:o)+f})),e&&!p&&n.panning&&i.pan(t,n.panning)))},drop:function(t){var e=this,o=this.chart,i=this.hasPinched;if(this.selectionMarker){var n,r={originalEvent:t,xAxis:[],yAxis:[]},s=this.selectionMarker,a=s.attr?s.attr("x"):s.x,h=s.attr?s.attr("y"):s.y,c=s.attr?s.attr("width"):s.width,u=s.attr?s.attr("height"):s.height;(this.hasDragged||i)&&(o.axes.forEach(function(o){if(o.zoomEnabled&&defined(o.min)&&(i||e[{xAxis:"zoomX",yAxis:"zoomY"}[o.coll]])){var s=o.horiz,l="touchend"===t.type?o.minPixelPadding:0,d=o.toValue((s?a:h)+l),p=o.toValue((s?a+c:h+u)-l);r[o.coll].push({axis:o,min:Math.min(d,p),max:Math.max(d,p)}),n=!0}}),n&&fireEvent(o,"selection",r,function(t){o.zoom(extend(t,i?{animation:!1}:null))})),isNumber(o.index)&&(this.selectionMarker=this.selectionMarker.destroy()),i&&this.scaleGroups()}o&&isNumber(o.index)&&(css(o.container,{cursor:o._cursor}),o.cancelClick=this.hasDragged>10,o.mouseIsDown=this.hasDragged=this.hasPinched=!1,this.pinchDown=[])},onContainerMouseDown:function(t){2!==(t=this.normalize(t)).button&&(this.zoomOption(t),t.preventDefault&&t.preventDefault(),this.dragStart(t))},onDocumentMouseUp:function(t){charts[H.hoverChartIndex]&&charts[H.hoverChartIndex].pointer.drop(t)},onDocumentMouseMove:function(t){var e=this.chart,o=this.chartPosition;t=this.normalize(t,o),!o||this.inClass(t.target,"highcharts-tracker")||e.isInsidePlot(t.chartX-e.plotLeft,t.chartY-e.plotTop)||this.reset()},onContainerMouseLeave:function(t){var e=charts[H.hoverChartIndex];e&&(t.relatedTarget||t.toElement)&&(e.pointer.reset(),e.pointer.chartPosition=void 0)},onContainerMouseMove:function(t){var e=this.chart;defined(H.hoverChartIndex)&&charts[H.hoverChartIndex]&&charts[H.hoverChartIndex].mouseIsDown||(H.hoverChartIndex=e.index),(t=this.normalize(t)).preventDefault||(t.returnValue=!1),"mousedown"===e.mouseIsDown&&this.drag(t),!this.inClass(t.target,"highcharts-tracker")&&!e.isInsidePlot(t.chartX-e.plotLeft,t.chartY-e.plotTop)||e.openMenu||this.runPointActions(t)},inClass:function(t,e){for(var o;t;){if(o=attr(t,"class")){if(-1!==o.indexOf(e))return!0;if(-1!==o.indexOf("highcharts-container"))return!1}t=t.parentNode}},onTrackerMouseOut:function(t){var e=this.chart.hoverSeries,o=t.relatedTarget||t.toElement;this.isDirectTouch=!1,!e||!o||e.stickyTracking||this.inClass(o,"highcharts-tooltip")||this.inClass(o,"highcharts-series-"+e.index)&&this.inClass(o,"highcharts-tracker")||e.onMouseOut()},onContainerClick:function(t){var e=this.chart,o=e.hoverPoint,i=e.plotLeft,n=e.plotTop;t=this.normalize(t),e.cancelClick||(o&&this.inClass(t.target,"highcharts-tracker")?(fireEvent(o.series,"click",extend(t,{point:o})),e.hoverPoint&&o.firePointEvent("click",t)):(extend(t,this.getCoordinates(t)),e.isInsidePlot(t.chartX-i,t.chartY-n)&&fireEvent(e,"click",t)))},setDOMEvents:function(){var t=this,e=t.chart.container,o=e.ownerDocument;e.onmousedown=function(e){t.onContainerMouseDown(e)},e.onmousemove=function(e){t.onContainerMouseMove(e)},e.onclick=function(e){t.onContainerClick(e)},this.unbindContainerMouseLeave=addEvent(e,"mouseleave",t.onContainerMouseLeave),H.unbindDocumentMouseUp||(H.unbindDocumentMouseUp=addEvent(o,"mouseup",t.onDocumentMouseUp)),H.hasTouch&&(addEvent(e,"touchstart",function(e){t.onContainerTouchStart(e)}),addEvent(e,"touchmove",function(e){t.onContainerTouchMove(e)}),H.unbindDocumentTouchEnd||(H.unbindDocumentTouchEnd=addEvent(o,"touchend",t.onDocumentTouchEnd)))},destroy:function(){var t=this;t.unDocMouseMove&&t.unDocMouseMove(),this.unbindContainerMouseLeave(),H.chartCount||(H.unbindDocumentMouseUp&&(H.unbindDocumentMouseUp=H.unbindDocumentMouseUp()),H.unbindDocumentTouchEnd&&(H.unbindDocumentTouchEnd=H.unbindDocumentTouchEnd())),clearInterval(t.tooltipTimeout),objectEach(t,function(e,o){t[o]=null})}};