"use strict";import H from"./Globals.js";import"./Axis.js";import U from"./Utilities.js";var defined=U.defined,extend=U.extend,pick=U.pick;import"./Chart.js";import"./Series.js";import"./Navigator.js";var addEvent=H.addEvent,Axis=H.Axis,Chart=H.Chart,css=H.css,noop=H.noop,Series=H.Series,timeUnits=H.timeUnits;addEvent(Series,"updatedData",function(){var t=this.xAxis;t&&t.options.ordinal&&delete t.ordinalIndex}),Axis.prototype.getTimeTicks=function(t,i,o,s,n,e,r){var a,l,h,d,p,c,f=0,v={},g=[],u=-Number.MAX_VALUE,x=this.options.tickPixelInterval,m=this.chart.time,P=[];if(!this.options.ordinal&&!this.options.breaks||!n||n.length<3||void 0===i)return m.getTimeTicks.apply(m,arguments);for(p=n.length,a=0;a<p;a++){if(c=a&&n[a-1]>o,n[a]<i&&(f=a),a===p-1||n[a+1]-n[a]>5*e||c){if(n[a]>u){for(l=m.getTimeTicks(t,n[f],n[a],s);l.length&&l[0]<=u;)l.shift();l.length&&(u=l[l.length-1]),P.push(g.length),g=g.concat(l)}f=a+1}if(c)break}if(d=l.info,r&&d.unitRange<=timeUnits.hour){for(a=g.length-1,f=1;f<a;f++)m.dateFormat("%d",g[f])!==m.dateFormat("%d",g[f-1])&&(v[g[f]]="day",h=!0);h&&(v[g[0]]="day"),d.higherRanks=v}if(d.segmentStarts=P,g.info=d,r&&defined(x)){for(var M,A,k,E,S,y=g.length,b=y,D=[],R=[];b--;)A=this.translate(g[b]),k&&(R[b]=k-A),D[b]=k=A;for(R.sort(),(E=R[Math.floor(R.length/2)])<.6*x&&(E=null),b=g[y-1]>o?y-1:y,k=void 0;b--;)A=D[b],S=Math.abs(k-A),k&&S<.8*x&&(null===E||S<.8*E)?(v[g[b]]&&!v[g[b+1]]?(M=b+1,k=A):M=b,g.splice(M,1)):k=A}return g},extend(Axis.prototype,{beforeSetTickPositions:function(){var t,i,o,s,n,e,r,a,l=[],h=!1,d=this.getExtremes(),p=d.min,c=d.max,f=this.isXAxis&&!!this.options.breaks,v=this.options.ordinal,g=Number.MAX_VALUE,u=this.chart.options.chart.ignoreHiddenSeries;if(v||f){if(this.series.forEach(function(o,s){if(i=[],(!u||!1!==o.visible)&&(!1!==o.takeOrdinalPosition||f)&&(l=l.concat(o.processedXData),t=l.length,l.sort(function(t,i){return t-i}),g=Math.min(g,pick(o.closestPointRange,g)),t)){for(s=0;s<t-1;)l[s]!==l[s+1]&&i.push(l[s+1]),s++;i[0]!==l[0]&&i.unshift(l[0]),l=i}o.isSeriesBoosting&&(a=!0)}),a&&(l.length=0),(t=l.length)>2){for(o=l[1]-l[0],r=t-1;r--&&!h;)l[r+1]-l[r]!==o&&(h=!0);!this.options.keepOrdinalPadding&&(l[0]-p>o||c-l[l.length-1]>o)&&(h=!0)}else this.options.overscroll&&(2===t?g=l[1]-l[0]:1===t?(g=this.options.overscroll,l=[l[0],l[0]+g]):g=this.overscrollPointsRange);h?(this.options.overscroll&&(this.overscrollPointsRange=g,l=l.concat(this.getOverscrollPositions())),this.ordinalPositions=l,s=this.ordinal2lin(Math.max(p,l[0]),!0),n=Math.max(this.ordinal2lin(Math.min(c,l[l.length-1]),!0),1),this.ordinalSlope=e=(c-p)/(n-s),this.ordinalOffset=p-s*e):(this.overscrollPointsRange=pick(this.closestPointRange,this.overscrollPointsRange),this.ordinalPositions=this.ordinalSlope=this.ordinalOffset=void 0)}this.isOrdinal=v&&h,this.groupIntervalFactor=null},val2lin:function(t,i){var o,s=this.ordinalPositions;if(s){var n,e,r=s.length;for(n=r;n--;)if(s[n]===t){e=n;break}for(n=r-1;n--;)if(t>s[n]||0===n){e=n+(t-s[n])/(s[n+1]-s[n]);break}o=i?e:this.ordinalSlope*(e||0)+this.ordinalOffset}else o=t;return o},lin2val:function(t,i){var o=this.ordinalPositions;if(o){var s,n,e=this.ordinalSlope,r=this.ordinalOffset,a=o.length-1;if(i)t<0?t=o[0]:t>a?t=o[a]:n=t-(a=Math.floor(t));else for(;a--;)if(t>=(s=e*a+r)){n=(t-s)/(e*(a+1)+r-s);break}return void 0!==n&&void 0!==o[a]?o[a]+(n?n*(o[a+1]-o[a]):0):t}return t},getExtendedPositions:function(){var t,i,o=this,s=o.chart,n=o.series[0].currentDataGrouping,e=o.ordinalIndex,r=n?n.count+n.unitName:"raw",a=o.options.overscroll,l=o.getExtremes();return e||(e=o.ordinalIndex={}),e[r]||(t={series:[],chart:s,getExtremes:function(){return{min:l.dataMin,max:l.dataMax+a}},options:{ordinal:!0},val2lin:Axis.prototype.val2lin,ordinal2lin:Axis.prototype.ordinal2lin},o.series.forEach(function(e){(i={xAxis:t,xData:e.xData.slice(),chart:s,destroyGroupedData:noop}).xData=i.xData.concat(o.getOverscrollPositions()),i.options={dataGrouping:n?{enabled:!0,forced:!0,approximation:"open",units:[[n.unitName,[n.count]]]}:{enabled:!1}},e.processData.apply(i),t.series.push(i)}),o.beforeSetTickPositions.apply(t),e[r]=t.ordinalPositions),e[r]},getOverscrollPositions:function(){var t=this.options.overscroll,i=this.overscrollPointsRange,o=[],s=this.dataMax;if(defined(i))for(o.push(s);s<=this.dataMax+t;)s+=i,o.push(s);return o},getGroupIntervalFactor:function(t,i,o){var s,n,e=o.processedXData,r=e.length,a=[],l=this.groupIntervalFactor;if(!l){for(s=0;s<r-1;s++)a[s]=e[s+1]-e[s];a.sort(function(t,i){return t-i}),n=a[Math.floor(r/2)],t=Math.max(t,e[0]),i=Math.min(i,e[r-1]),this.groupIntervalFactor=l=r*n/(i-t)}return l},postProcessTickInterval:function(t){var i=this.ordinalSlope;return i?this.options.breaks?this.closestPointRange||t:t/(i/this.closestPointRange):t}}),Axis.prototype.ordinal2lin=Axis.prototype.val2lin,addEvent(Chart,"pan",function(t){var i=this.xAxis[0],o=i.options.overscroll,s=t.originalEvent.chartX,n=!1;if(i.options.ordinal&&i.series.length){var e,r,a,l,h=this.mouseDownX,d=i.getExtremes(),p=d.dataMax,c=d.min,f=d.max,v=this.hoverPoints,g=i.closestPointRange||i.overscrollPointsRange,u=(h-s)/(i.translationSlope*(i.ordinalSlope||g)),x={ordinalPositions:i.getExtendedPositions()},m=i.lin2val,P=i.val2lin;x.ordinalPositions?Math.abs(u)>1&&(v&&v.forEach(function(t){t.setState()}),u<0?(a=x,l=i.ordinalPositions?i:x):(a=i.ordinalPositions?i:x,l=x),p>(r=l.ordinalPositions)[r.length-1]&&r.push(p),this.fixedRange=f-c,(e=i.toFixedRange(null,null,m.apply(a,[P.apply(a,[c,!0])+u,!0]),m.apply(l,[P.apply(l,[f,!0])+u,!0]))).min>=Math.min(d.dataMin,c)&&e.max<=Math.max(p,f)+o&&i.setExtremes(e.min,e.max,!0,!1,{trigger:"pan"}),this.mouseDownX=s,css(this.container,{cursor:"move"})):n=!0}else n=!0;n?o&&(i.max=i.dataMax+o):t.preventDefault()}),addEvent(Axis,"foundExtremes",function(){this.isXAxis&&defined(this.options.overscroll)&&this.max===this.dataMax&&(!this.chart.mouseIsDown||this.isInternal)&&(!this.eventArgs||this.eventArgs&&"navigator"!==this.eventArgs.trigger)&&(this.max+=this.options.overscroll,!this.isInternal&&defined(this.userMin)&&(this.min+=this.options.overscroll))}),addEvent(Axis,"afterSetScale",function(){this.horiz&&!this.isDirty&&(this.isDirty=this.isOrdinal&&this.chart.navigator&&!this.chart.navigator.adaptToUpdatedData)});