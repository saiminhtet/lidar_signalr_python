"use strict";import Highcharts from"../parts/Globals.js";import U from"../parts/Utilities.js";var extend=U.extend;import"../parts/Chart.js";import"../parts/Options.js";import"../mixins/download-url.js";var addEvent=Highcharts.addEvent,merge=Highcharts.merge,win=Highcharts.win,nav=win.navigator,doc=win.document,domurl=win.URL||win.webkitURL||win,isMSBrowser=/Edge\/|Trident\/|MSIE /.test(nav.userAgent),loadEventDeferDelay=isMSBrowser?150:0;function getScript(t,e){var n=doc.getElementsByTagName("head")[0],i=doc.createElement("script");i.type="text/javascript",i.src=t,i.onload=e,i.onerror=function(){Highcharts.error("Error loading script "+t)},n.appendChild(i)}Highcharts.CanVGRenderer={},Highcharts.svgToDataUrl=function(t){var e=nav.userAgent.indexOf("WebKit")>-1&&nav.userAgent.indexOf("Chrome")<0;try{if(!e&&nav.userAgent.toLowerCase().indexOf("firefox")<0)return domurl.createObjectURL(new win.Blob([t],{type:"image/svg+xml;charset-utf-16"}))}catch(t){}return"data:image/svg+xml;charset=UTF-8,"+encodeURIComponent(t)},Highcharts.imageToDataUrl=function(t,e,n,i,o,r,a,c,l){var s,g=new win.Image,h=function(){setTimeout(function(){var r,c=doc.createElement("canvas"),h=c.getContext&&c.getContext("2d");try{if(h){c.height=g.height*i,c.width=g.width*i,h.drawImage(g,0,0,c.width,c.height);try{r=c.toDataURL(e),o(r,e,n,i)}catch(o){s(t,e,n,i)}}else a(t,e,n,i)}finally{l&&l(t,e,n,i)}},loadEventDeferDelay)},d=function(){c(t,e,n,i),l&&l(t,e,n,i)};s=function(){g=new win.Image,s=r,g.crossOrigin="Anonymous",g.onload=h,g.onerror=d,g.src=t},g.onload=h,g.onerror=d,g.src=t},Highcharts.downloadSVGLocal=function(t,e,n,i){var o,r,a,c=!0,l=e.libURL||Highcharts.getOptions().exporting.libURL,s=doc.createElement("div"),g=e.type||"image/png",h=(e.filename||"chart")+"."+("image/svg+xml"===g?"svg":g.split("/")[1]),d=e.scale||1;function p(){s.innerHTML=t;var e,o,r,a,c,l,g,d=s.getElementsByTagName("text");[].forEach.call(d,function(t){["font-family","font-size"].forEach(function(e){!function(t,e){for(var n=t;n&&n!==s;){if(n.style[e]){t.style[e]=n.style[e];break}n=n.parentNode}}(t,e)}),t.style["font-family"]=t.style["font-family"]&&t.style["font-family"].split(" ").splice(-1),e=t.getElementsByTagName("title"),[].forEach.call(e,function(e){t.removeChild(e)})}),r=s.firstChild,a=0,c=r.width.baseVal.value+2*a,l=r.height.baseVal.value+2*a,g=new win.jsPDF("l","pt",[c,l]),[].forEach.call(r.querySelectorAll('*[visibility="hidden"]'),function(t){t.parentNode.removeChild(t)}),win.svg2pdf(r,g,{removeInvalid:!0}),o=g.output("datauristring");try{Highcharts.downloadURL(o,h),i&&i()}catch(t){n(t)}}if(l="/"!==l.slice(-1)?l+"/":l,"image/svg+xml"===g)try{void 0!==nav.msSaveOrOpenBlob?((r=new MSBlobBuilder).append(t),o=r.getBlob("image/svg+xml")):o=Highcharts.svgToDataUrl(t),Highcharts.downloadURL(o,h),i&&i()}catch(t){n(t)}else"application/pdf"===g?win.jsPDF&&win.svg2pdf?p():(c=!0,getScript(l+"jspdf.js",function(){getScript(l+"svg2pdf.js",function(){p()})})):(o=Highcharts.svgToDataUrl(t),a=function(){try{domurl.revokeObjectURL(o)}catch(t){}},Highcharts.imageToDataUrl(o,g,{},d,function(t){try{Highcharts.downloadURL(t,h),i&&i()}catch(t){n(t)}},function(){var e=doc.createElement("canvas"),o=e.getContext("2d"),r=t.match(/^<svg[^>]*width\s*=\s*\"?(\d+)\"?[^>]*>/)[1]*d,s=t.match(/^<svg[^>]*height\s*=\s*\"?(\d+)\"?[^>]*>/)[1]*d,p=function(){o.drawSvg(t,0,0,r,s);try{Highcharts.downloadURL(nav.msSaveOrOpenBlob?e.msToBlob():e.toDataURL(g),h),i&&i()}catch(t){n(t)}finally{a()}};e.width=r,e.height=s,win.canvg?p():(c=!0,getScript(l+"rgbcolor.js",function(){getScript(l+"canvg.js",function(){p()})}))},n,n,function(){c&&a()}))},Highcharts.Chart.prototype.getSVGForLocalExport=function(t,e,n,i){var o,r,a,c,l,s,g,h=this,d=0,p=function(t){return h.sanitizeSVG(t,a)},f=function(){d===o.length&&i(p(r.innerHTML))},m=function(t,e,n){++d,n.imageElement.setAttributeNS("http://www.w3.org/1999/xlink","href",t),f()};h.unbindGetSVG=addEvent(h,"getSVG",function(t){a=t.chartCopy.options,r=t.chartCopy.container.cloneNode(!0)}),h.getSVGForExport(t,e),o=r.getElementsByTagName("image");try{if(!o.length)return void i(p(r.innerHTML));for(l=0,s=o.length;l<s;++l)(g=(c=o[l]).getAttributeNS("http://www.w3.org/1999/xlink","href"))?Highcharts.imageToDataUrl(g,"image/png",{imageElement:c},t.scale,m,n,n,n):(++d,c.parentNode.removeChild(c),f())}catch(t){n(t)}h.unbindGetSVG()},Highcharts.Chart.prototype.exportChartLocal=function(t,e){var n=this,i=Highcharts.merge(n.options.exporting,t),o=function(t){!1===i.fallbackToExportServer?i.error?i.error(i,t):Highcharts.error(28,!0):n.exportChart(i)};isMSBrowser&&n.styledMode&&(Highcharts.SVGRenderer.prototype.inlineWhitelist=[/^blockSize/,/^border/,/^caretColor/,/^color/,/^columnRule/,/^columnRuleColor/,/^cssFloat/,/^cursor/,/^fill$/,/^fillOpacity/,/^font/,/^inlineSize/,/^length/,/^lineHeight/,/^opacity/,/^outline/,/^parentRule/,/^rx$/,/^ry$/,/^stroke/,/^textAlign/,/^textAnchor/,/^textDecoration/,/^transform/,/^vectorEffect/,/^visibility/,/^x$/,/^y$/]),isMSBrowser&&("application/pdf"===i.type||n.container.getElementsByTagName("image").length&&"image/svg+xml"!==i.type)||"application/pdf"===i.type&&[].some.call(n.container.getElementsByTagName("image"),function(t){var e=t.getAttribute("href");return""!==e&&0!==e.indexOf("data:")})?o("Image type not supported for this chart/browser."):n.getSVGForLocalExport(i,e,o,function(t){t.indexOf("<foreignObject")>-1&&"image/svg+xml"!==i.type?o("Image type not supportedfor charts with embedded HTML"):Highcharts.downloadSVGLocal(t,extend({filename:n.getFilename()},i),o)})},merge(!0,Highcharts.getOptions().exporting,{libURL:"https://code.highcharts.com/7.2.2/lib/",menuItemDefinitions:{downloadPNG:{textKey:"downloadPNG",onclick:function(){this.exportChartLocal()}},downloadJPEG:{textKey:"downloadJPEG",onclick:function(){this.exportChartLocal({type:"image/jpeg"})}},downloadSVG:{textKey:"downloadSVG",onclick:function(){this.exportChartLocal({type:"image/svg+xml"})}},downloadPDF:{textKey:"downloadPDF",onclick:function(){this.exportChartLocal({type:"application/pdf"})}}}});