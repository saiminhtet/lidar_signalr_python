"use strict";import H from"../parts/Globals.js";import U from"../parts/Utilities.js";var extend=U.extend,isNumber=U.isNumber;import"../parts/Color.js";import"../parts/Series.js";import"../parts/Options.js";var destroyLoadingDiv,win=H.win,doc=win.document,noop=function(){},Color=H.Color,Series=H.Series,seriesTypes=H.seriesTypes,addEvent=H.addEvent,fireEvent=H.fireEvent,merge=H.merge,pick=H.pick,wrap=H.wrap,CHUNK_SIZE=5e4;H.initCanvasBoost=function(){H.seriesTypes.heatmap&&H.wrap(H.seriesTypes.heatmap.prototype,"drawPoints",function(){var t=this.chart,e=this.getContext(),o=this.chart.inverted,i=this.xAxis,r=this.yAxis;e?(this.points.forEach(function(s){var n,a,c=s.plotY;void 0===c||isNaN(c)||null===s.y||(n=s.shapeArgs,a=t.styledMode?s.series.colorAttribs(s):s.series.pointAttribs(s),e.fillStyle=a.fill,o?e.fillRect(r.len-n.y+i.left,i.len-n.x+r.top,-n.height,-n.width):e.fillRect(n.x+i.left,n.y+r.top,n.width,n.height))}),this.canvasToSVG()):this.chart.showLoading("Your browser doesn't support HTML5 canvas, <br>please use a modern browser")}),extend(Series.prototype,{getContext:function(){var t,e=this.chart,o=e.chartWidth,i=e.chartHeight,r=e.seriesGroup||this.group,s=this,n=function(t,e,o,i,r,s,n){t.call(this,o,e,i,r,s,n)};return e.isChartSeriesBoosting()&&(s=e,r=e.seriesGroup),t=s.ctx,s.canvas?H.Chart:(s.canvas=doc.createElement("canvas"),s.renderTarget=e.renderer.image("",0,0,o,i).addClass("highcharts-boost-canvas").add(r),s.ctx=t=s.canvas.getContext("2d"),e.inverted&&["moveTo","lineTo","rect","arc"].forEach(function(e){wrap(t,e,n)}),s.boostCopy=function(){s.renderTarget.attr({href:s.canvas.toDataURL("image/png")})},s.boostClear=function(){t.clearRect(0,0,s.canvas.width,s.canvas.height),s===this&&s.renderTarget.attr({href:""})},s.boostClipRect=e.renderer.clipRect(),s.renderTarget.clip(s.boostClipRect)),s.canvas.width!==o&&(s.canvas.width=o),s.canvas.height!==i&&(s.canvas.height=i),s.renderTarget.attr({x:0,y:0,width:o,height:i,style:"pointer-events: none",href:""}),s.boostClipRect.attr(e.getBoostClipRect(s)),t},canvasToSVG:function(){this.chart.isChartSeriesBoosting()?this.boostClear&&this.boostClear():(this.boostCopy||this.chart.boostCopy)&&(this.boostCopy||this.chart.boostCopy)()},cvsLineTo:function(t,e,o){t.lineTo(e,o)},renderCanvas:function(){var t,e,o,i,r,s,n,a,c,l,p=this,h=p.options,d=p.chart,v=this.xAxis,u=this.yAxis,g=d.options.boost||{},y=g.timeRendering||!1,f=(g.timeSeriesProcessing,g.timeSetup,0),m=p.processedXData,b=p.processedYData,C=h.data,T=v.getExtremes(),x=T.min,w=T.max,S=u.getExtremes(),k=S.min,D=S.max,E={},M=!!p.sampling,N=h.marker&&h.marker.radius,P=this.cvsDrawPoint,A=h.lineWidth?this.cvsLineTo:void 0,R=N&&N<=1?this.cvsMarkerSquare:this.cvsMarkerCircle,G=this.cvsStrokeBatch||1e3,L=!1!==h.enableMouseTracking,B=h.threshold,X=u.getThreshold(B),U=isNumber(B),Y=X,j=this.fill,O=p.pointArrayMap&&"low,high"===p.pointArrayMap.join(","),I=!!h.stacking,K=p.cropStart||0,V=d.options.loading,W=p.requireSorting,q=h.connectNulls,_=!m,Z=I?p.data:m||C,z=p.fillOpacity?new Color(p.color).setOpacity(pick(h.fillOpacity,.75)).get():p.color,J=function(){j?(t.fillStyle=z,t.fill()):(t.strokeStyle=p.color,t.lineWidth=h.lineWidth,t.stroke())},F=function(e,o,s,n){0===f&&(t.beginPath(),A&&(t.lineJoin="round")),d.scroller&&"highcharts-navigator-series"===p.options.className?(o+=d.scroller.top,s&&(s+=d.scroller.top)):o+=d.plotTop,e+=d.plotLeft,r?t.moveTo(e,o):P?P(t,e,o,s,i):A?A(t,e,o):R&&R.call(p,t,e,o,N,n),(f+=1)===G&&(J(),f=0),i={clientX:e,plotY:o,yBottom:s}},Q="x"===h.findNearestPointBy,$=this.xData||this.options.xData||this.processedXData||!1,tt=function(t,e,i){l=Q?t:t+","+e,L&&!E[l]&&(E[l]=!0,d.inverted&&(t=v.len-t,e=u.len-e),o.push({x:!!$&&$[K+i],clientX:t,plotX:t,plotY:e,i:K+i}))};this.renderTarget&&this.renderTarget.attr({href:""}),(this.points||this.graph)&&this.destroyGraphics(),p.plotGroup("group","series",p.visible?"visible":"hidden",h.zIndex,d.seriesGroup),p.markerGroup=p.group,addEvent(p,"destroy",function(){p.markerGroup=null}),o=this.points=[],t=this.getContext(),p.buildKDTree=noop,this.boostClear&&this.boostClear(),this.visible&&(C.length>99999&&(d.options.loading=merge(V,{labelStyle:{backgroundColor:H.color("#ffffff").setOpacity(.75).get(),padding:"1em",borderRadius:"0.5em"},style:{backgroundColor:"none",opacity:1}}),H.clearTimeout(destroyLoadingDiv),d.showLoading("Drawing..."),d.options.loading=V),y&&console.time("canvas rendering"),H.eachAsync(Z,function(t,o){var i,l,h,g,y,f,m=!1,C=!1,T=!1,S=!1,H=void 0===d.index,E=!0;return H||(_?(i=t[0],l=t[1],Z[o+1]&&(T=Z[o+1][0]),Z[o-1]&&(S=Z[o-1][0])):(i=t,l=b[o],Z[o+1]&&(T=Z[o+1]),Z[o-1]&&(S=Z[o-1])),T&&T>=x&&T<=w&&(m=!0),S&&S>=x&&S<=w&&(C=!0),O?(_&&(l=t.slice(1,3)),f=l[0],l=l[1]):I&&(i=t.x,f=(l=t.stackY)-t.y),W||(E=l>=k&&l<=D),!(y=null===l)&&(i>=x&&i<=w&&E||m||C)&&(h=Math.round(v.toPixels(i,!0)),M?(void 0!==a&&h!==e||(O||(f=l),(void 0===c||l>n)&&(n=l,c=o),(void 0===a||f<s)&&(s=f,a=o)),h!==e&&(void 0!==a&&(g=u.toPixels(n,!0),X=u.toPixels(s,!0),F(h,U?Math.min(g,Y):g,U?Math.max(X,Y):X,o),tt(h,g,c),X!==g&&tt(h,X,a)),a=c=void 0,e=h)):(g=Math.round(u.toPixels(l,!0)),F(h,g,X,o),tt(h,g,o))),r=y&&!q,o%CHUNK_SIZE==0&&(p.boostCopy||p.chart.boostCopy)&&(p.boostCopy||p.chart.boostCopy)()),!H},function(){var t=d.loadingDiv,e=d.loadingShown;J(),p.canvasToSVG(),y&&console.timeEnd("canvas rendering"),fireEvent(p,"renderedCanvas"),e&&(extend(t.style,{transition:"opacity 250ms",opacity:0}),d.loadingShown=!1,destroyLoadingDiv=setTimeout(function(){t.parentNode&&t.parentNode.removeChild(t),d.loadingDiv=d.loadingSpan=null},250)),delete p.buildKDTree,p.buildKDTree()},d.renderer.forExport?Number.MAX_VALUE:void 0))}}),seriesTypes.scatter.prototype.cvsMarkerCircle=function(t,e,o,i){t.moveTo(e,o),t.arc(e,o,i,0,2*Math.PI,!1)},seriesTypes.scatter.prototype.cvsMarkerSquare=function(t,e,o,i){t.rect(e-i,o-i,2*i,2*i)},seriesTypes.scatter.prototype.fill=!0,seriesTypes.bubble&&(seriesTypes.bubble.prototype.cvsMarkerCircle=function(t,e,o,i,r){t.moveTo(e,o),t.arc(e,o,this.radii&&this.radii[r],0,2*Math.PI,!1)},seriesTypes.bubble.prototype.cvsStrokeBatch=1),extend(seriesTypes.area.prototype,{cvsDrawPoint:function(t,e,o,i,r){r&&e!==r.clientX&&(t.moveTo(r.clientX,r.yBottom),t.lineTo(r.clientX,r.plotY),t.lineTo(e,o),t.lineTo(e,i))},fill:!0,fillOpacity:!0,sampling:!0}),extend(seriesTypes.column.prototype,{cvsDrawPoint:function(t,e,o,i){t.rect(e-1,o,1,i-o)},fill:!0,sampling:!0}),H.Chart.prototype.callbacks.push(function(t){addEvent(t,"predraw",function(){t.renderTarget&&t.renderTarget.attr({href:""}),t.canvas&&t.canvas.getContext("2d").clearRect(0,0,t.canvas.width,t.canvas.height)}),addEvent(t,"render",function(){t.boostCopy&&t.boostCopy()})})};