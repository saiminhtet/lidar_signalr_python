"use strict";import H from"../parts/Globals.js";import U from"../parts/Utilities.js";var extend=U.extend,isNumber=U.isNumber,isObject=U.isObject,isString=U.isString;import"../mixins/centered-series.js";import drawPoint from"../mixins/draw-point.js";import mixinTreeSeries from"../mixins/tree-series.js";import"../parts/Series.js";import"./treemap.src.js";var CenteredSeriesMixin=H.CenteredSeriesMixin,Series=H.Series,getCenter=CenteredSeriesMixin.getCenter,getColor=mixinTreeSeries.getColor,getLevelOptions=mixinTreeSeries.getLevelOptions,getStartAndEndRadians=CenteredSeriesMixin.getStartAndEndRadians,isBoolean=function(e){return"boolean"==typeof e},merge=H.merge,noop=H.noop,rad2deg=180/Math.PI,seriesType=H.seriesType,seriesTypes=H.seriesTypes,setTreeValues=mixinTreeSeries.setTreeValues,updateRootId=mixinTreeSeries.updateRootId,range=function(e,t){var r,i=[];if(isNumber(e)&&isNumber(t)&&e<=t)for(r=e;r<=t;r++)i.push(r);return i},calculateLevelSizes=function(e,t){var r,i,n,s,o,a,l,d=isObject(t)?t:{},p=0;return isObject(e)&&(r=merge({},e),a=isNumber(d.from)?d.from:0,l=isNumber(d.to)?d.to:0,n=range(a,l),s=Object.keys(r).filter(function(e){return-1===n.indexOf(+e)}),i=o=isNumber(d.diffRadius)?d.diffRadius:0,n.forEach(function(e){var t=r[e],n=t.levelSize.unit,s=t.levelSize.value;"weight"===n?p+=s:"percentage"===n?(t.levelSize={unit:"pixels",value:s/100*i},o-=t.levelSize.value):"pixels"===n&&(o-=s)}),n.forEach(function(e){var t,i=r[e];"weight"===i.levelSize.unit&&(t=i.levelSize.value,r[e].levelSize={unit:"pixels",value:t/p*o})}),s.forEach(function(e){r[e].levelSize={value:0,unit:"pixels"}})),r},getEndPoint=function(e,t,r,i){return{x:e+Math.cos(r)*i,y:t+Math.sin(r)*i}},layoutAlgorithm=function(e,t,r){var i=e.start,n=e.end-i,s=e.val,o=e.x,a=e.y,l=r&&isObject(r.levelSize)&&isNumber(r.levelSize.value)?r.levelSize.value:0,d=e.r,p=d+l,u=r&&isNumber(r.slicedOffset)?r.slicedOffset:0;return(t||[]).reduce(function(e,t){var r=1/s*t.val*n,c=getEndPoint(o,a,i+r/2,u),h={x:t.sliced?c.x:o,y:t.sliced?c.y:a,innerR:d,r:p,radius:l,start:i,end:i+r};return e.push(h),i=h.end,e},[])},getDlOptions=function(e){var t,r,i=e.point,n=isObject(e.shapeArgs)?e.shapeArgs:{},s=isObject(e.optionsPoint)?e.optionsPoint.dataLabels:{},o=isObject(e.level)?e.level.dataLabels:{},a=merge({style:{}},o,s),l=a.rotationMode;return isNumber(a.rotation)||("auto"===l&&(i.innerArcLength<1&&i.outerArcLength>n.radius?t=0:l=i.innerArcLength>1&&i.outerArcLength>1.5*n.radius?"parallel":"perpendicular"),"auto"!==l&&(t=n.end-(n.end-n.start)/2),a.style.width="parallel"===l?Math.min(2.5*n.radius,(i.outerArcLength+i.innerArcLength)/2):n.radius,"perpendicular"===l&&i.series.chart.renderer.fontMetrics(a.style.fontSize).h>i.outerArcLength&&(a.style.width=1),a.style.width=Math.max(a.style.width-2*(a.padding||0),1),r=t*rad2deg%180,"parallel"===l&&(r-=90),r>90?r-=180:r<-90&&(r+=180),a.rotation=r),0===a.rotation&&(a.rotation=.001),a},getAnimation=function(e,t){var r=t.point,i=t.radians,n=t.innerR,s=t.idRoot,o=t.idPreviousRoot,a=t.shapeExisting,l=t.shapeRoot,d=t.shapePreviousRoot,p=t.visible,u={},c={end:e.end,start:e.start,innerR:e.innerR,r:e.r,x:e.x,y:e.y};return p?!r.graphic&&d&&((u=s===r.id?{start:i.start,end:i.end}:d.end<=e.start?{start:i.end,end:i.end}:{start:i.start,end:i.start}).innerR=u.r=n):r.graphic&&(o===r.id?c={innerR:n,r:n}:l&&(c=l.end<=a.start?{innerR:n,r:n,start:i.end,end:i.end}:{innerR:n,r:n,start:i.start,end:i.start})),{from:u,to:c}},getDrillId=function(e,t,r){var i;return e.node.isLeaf||(i=t===e.id?r[t].parent:e.id),i},cbSetTreeValuesBefore=function(e,t){var r=t.mapIdToNode[e.parent],i=t.series,n=i.chart,s=i.points[e.i],o=i.options.colors||n&&n.options.colors,a=getColor(e,{colors:o,colorIndex:i.colorIndex,index:t.index,mapOptionsToLevel:t.mapOptionsToLevel,parentColor:r&&r.color,parentColorIndex:r&&r.colorIndex,series:t.series,siblings:t.siblings});return e.color=a.color,e.colorIndex=a.colorIndex,s&&(s.color=e.color,s.colorIndex=e.colorIndex,e.sliced=e.id!==t.idRoot&&s.sliced),e},sunburstOptions={center:["50%","50%"],colorByPoint:!1,opacity:1,dataLabels:{allowOverlap:!0,defer:!0,rotationMode:"auto",style:{textOverflow:"ellipsis"}},rootId:void 0,levelIsConstant:!0,levelSize:{value:1,unit:"weight"},slicedOffset:10},sunburstSeries={drawDataLabels:noop,drawPoints:function(){var e,t=this,r=t.mapOptionsToLevel,i=t.shapeRoot,n=t.group,s=t.hasRendered,o=t.rootNode,a=t.idPreviousRoot,l=t.nodeMap,d=l[a],p=d&&d.shapeArgs,u=t.points,c=t.startAndEndRadians,h=t.chart,v=h&&h.options&&h.options.chart||{},g=!isBoolean(v.animation)||v.animation,f=t.center,m={x:f[0],y:f[1]},b=f[3]/2,x=t.chart.renderer,S=!1,y=!1,R=!!(g&&s&&o!==a&&t.dataLabelsGroup);R&&(t.dataLabelsGroup.attr({opacity:0}),e=function(){var e=t;S=!0,e.dataLabelsGroup&&e.dataLabelsGroup.animate({opacity:1,visibility:"visible"})}),u.forEach(function(d){var u,v,f=d.node,S=r[f.level],R=d.shapeExisting||{},A=f.shapeArgs||{},L=!(!f.visible||!f.shapeArgs);u=s&&g?getAnimation(A,{center:m,point:d,radians:c,innerR:b,idRoot:o,idPreviousRoot:a,shapeExisting:R,shapeRoot:i,shapePreviousRoot:p,visible:L}):{to:A,from:{}},extend(d,{shapeExisting:A,tooltipPos:[A.plotX,A.plotY],drillId:getDrillId(d,o,l),name:""+(d.name||d.id||d.index),plotX:A.plotX,plotY:A.plotY,value:f.val,isNull:!L}),d.dlOptions=getDlOptions({point:d,level:S,optionsPoint:d.options,shapeArgs:A}),!y&&L&&(y=!0,v=e),d.draw({animatableAttribs:u.to,attribs:extend(u.from,!h.styledMode&&t.pointAttribs(d,d.selected&&"select")),onComplete:v,group:n,renderer:x,shapeType:"arc",shapeArgs:A})}),R&&y?(t.hasRendered=!1,t.options.dataLabels.defer=!0,Series.prototype.drawDataLabels.call(t),t.hasRendered=!0,S&&e()):Series.prototype.drawDataLabels.call(t)},pointAttribs:seriesTypes.column.prototype.pointAttribs,layoutAlgorithm:layoutAlgorithm,setShapeArgs:function(e,t,r){var i,n=e.level+1,s=r[n],o=e.children.filter(function(e){return e.visible});i=this.layoutAlgorithm(t,o,s),o.forEach(function(e,t){var n=i[t],s=n.start+(n.end-n.start)/2,o=n.innerR+(n.r-n.innerR)/2,a=n.end-n.start,l=0===n.innerR&&a>6.28?{x:n.x,y:n.y}:getEndPoint(n.x,n.y,s,o),d=e.val?e.childrenTotal>e.val?e.childrenTotal:e.val:e.childrenTotal;this.points[e.i]&&(this.points[e.i].innerArcLength=a*n.innerR,this.points[e.i].outerArcLength=a*n.r),e.shapeArgs=merge(n,{plotX:l.x,plotY:l.y+4*Math.abs(Math.cos(s))}),e.values=merge(n,{val:d}),e.children.length&&this.setShapeArgs(e,e.values,r)},this)},translate:function(){var e,t,r,i,n=this,s=n.options,o=n.center=getCenter.call(n),a=n.startAndEndRadians=getStartAndEndRadians(s.startAngle,s.endAngle),l=o[3]/2,d=o[2]/2-l,p=updateRootId(n),u=n.nodeMap,c=u&&u[p],h={};n.shapeRoot=c&&c.shapeArgs,Series.prototype.translate.call(n),r=n.tree=n.getTree(),n.renderTraverseUpButton(p),c=(u=n.nodeMap)[p],t=u[isString(c.parent)?c.parent:""],e=getLevelOptions({from:c.level>0?c.level:1,levels:n.options.levels,to:r.height,defaults:{colorByPoint:s.colorByPoint,dataLabels:s.dataLabels,levelIsConstant:s.levelIsConstant,levelSize:s.levelSize,slicedOffset:s.slicedOffset}}),e=calculateLevelSizes(e,{diffRadius:d,from:c.level>0?c.level:1,to:r.height}),setTreeValues(r,{before:cbSetTreeValuesBefore,idRoot:p,levelIsConstant:s.levelIsConstant,mapOptionsToLevel:e,mapIdToNode:u,points:n.points,series:n}),i=u[""].shapeArgs={end:a.end,r:l,start:a.start,val:c.val,x:o[0],y:o[1]},this.setShapeArgs(t,i,e),n.mapOptionsToLevel=e,n.data.forEach(function(e){h[e.id]&&H.error(31,!1,n.chart),h[e.id]=!0}),h={}},animate:function(e){var t,r=this.chart,i=[r.plotWidth/2,r.plotHeight/2],n=r.plotLeft,s=r.plotTop,o=this.group;e?(t={translateX:i[0]+n,translateY:i[1]+s,scaleX:.001,scaleY:.001,rotation:10,opacity:.01},o.attr(t)):(t={translateX:n,translateY:s,scaleX:1,scaleY:1,rotation:0,opacity:1},o.animate(t,this.options.animation),this.animate=null)},utils:{calculateLevelSizes:calculateLevelSizes,range:range}},sunburstPoint={draw:drawPoint,shouldDraw:function(){return!this.isNull},isValid:function(){return!0}};seriesType("sunburst","treemap",sunburstOptions,sunburstSeries,sunburstPoint);