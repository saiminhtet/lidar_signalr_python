"use strict";import H from"../parts/Globals.js";import U from"../parts/Utilities.js";var extend=U.extend,pick=U.pick;import"../parts/ColumnSeries.js";import"../parts/SvgRenderer.js";var funnel3dMethods,charts=H.charts,color=H.color,error=H.error,merge=H.merge,seriesType=H.seriesType,seriesTypes=H.seriesTypes,relativeLength=H.relativeLength,RendererProto=H.Renderer.prototype,cuboidPath=RendererProto.cuboidPath;seriesType("funnel3d","column",{center:["50%","50%"],width:"90%",neckWidth:"30%",height:"100%",neckHeight:"25%",reversed:!1,gradientForSides:!0,animation:!1,edgeWidth:0,colorByPoint:!0,showInLegend:!1,dataLabels:{align:"right",crop:!1,inside:!1,overflow:"allow"}},{bindAxes:function(){H.Series.prototype.bindAxes.apply(this,arguments),extend(this.xAxis.options,{gridLineWidth:0,lineWidth:0,title:null,tickPositions:[]}),extend(this.yAxis.options,{gridLineWidth:0,title:null,labels:{enabled:!1}})},translate3dShapes:H.noop,translate:function(){H.Series.prototype.translate.apply(this,arguments);var e,t,r,i,n,o,a,d,h,s=0,l=this.chart,p=this.options,g=p.reversed,c=p.ignoreHiddenPoint,u=l.plotWidth,f=l.plotHeight,y=0,m=p.center,x=relativeLength(m[0],u),w=relativeLength(m[1],f),b=relativeLength(p.width,u),L=relativeLength(p.height,f),v=relativeLength(p.neckWidth,u),U=relativeLength(p.neckHeight,f),k=w-L/2+L-U,C=this.data;this.getWidthAt=t=function(e){return e>k||L===U?v:v+(b-v)*(1-(e-(w-L/2))/(L-U))},this.center=[x,w,L],this.centerX=x,C.forEach(function(e){c&&!1===e.visible||(s+=e.y)}),C.forEach(function(u){a=null,r=s?u.y/s:0,o=(n=w-L/2+y*L)+r*L,e=t(n),d=o-n,h={gradientForSides:pick(u.options.gradientForSides,p.gradientForSides),x:x,y:n,height:d,width:e,z:1,top:{width:e}},e=t(o),h.bottom={fraction:r,width:e},n>=k?h.isCylinder=!0:o>k&&(a=o,e=t(k),o=k,h.bottom.width=e,h.middle={fraction:d?(k-n)/d:0,width:e}),g&&(h.y=n=w+L/2-(y+r)*L,h.middle&&(h.middle.fraction=1-(d?h.middle.fraction:0)),e=h.width,h.width=h.bottom.width,h.bottom.width=e),u.shapeArgs=extend(u.shapeArgs,h),u.percentage=100*r,u.plotX=x,u.plotY=g?w+L/2-(y+r/2)*L:(n+(a||o))/2,i=H.perspective([{x:x,y:u.plotY,z:g?-(b-t(u.plotY))/2:-t(u.plotY)/2}],l,!0)[0],u.tooltipPos=[i.x,i.y],u.dlBoxRaw={x:x,width:t(u.plotY),y:n,bottom:h.height,fullWidth:b},c&&!1===u.visible||(y+=r)})},alignDataLabel:function(e,t,r){var i=e.dlBoxRaw,n=this.chart.inverted,o=e.plotY>pick(this.translatedThreshold,this.yAxis.len),a=pick(r.inside,!!this.options.stacking),d={x:i.x,y:i.y,height:0};r.align=pick(r.align,!n||a?"center":o?"right":"left"),r.verticalAlign=pick(r.verticalAlign,n||a?"middle":o?"top":"bottom"),"top"!==r.verticalAlign&&(d.y+=i.bottom/("bottom"===r.verticalAlign?1:2)),d.width=this.getWidthAt(d.y),this.options.reversed&&(d.width=i.fullWidth-d.width),a?d.x-=d.width/2:"left"===r.align?(r.align="right",d.x-=1.5*d.width):"right"===r.align?(r.align="left",d.x+=d.width/2):d.x-=d.width/2,e.dlBox=d,seriesTypes.column.prototype.alignDataLabel.apply(this,arguments)}},{shapeType:"funnel3d",hasNewShapeType:H.seriesTypes.column.prototype.pointClass.prototype.hasNewShapeType}),funnel3dMethods=H.merge(RendererProto.elements3d.cuboid,{parts:["top","bottom","frontUpper","backUpper","frontLower","backLower","rightUpper","rightLower"],mainParts:["top","bottom"],sideGroups:["upperGroup","lowerGroup"],sideParts:{upperGroup:["frontUpper","backUpper","rightUpper"],lowerGroup:["frontLower","backLower","rightLower"]},pathType:"funnel3d",opacitySetter:function(e){var t=this,r=t.parts,i=H.charts[t.renderer.chartIndex],n="group-opacity-"+e+"-"+i.index;return t.parts=t.mainParts,t.singleSetterForParts("opacity",e),t.parts=r,i.renderer.filterId||(i.renderer.definition({tagName:"filter",id:n,children:[{tagName:"feComponentTransfer",children:[{tagName:"feFuncA",type:"table",tableValues:"0 "+e}]}]}),t.sideGroups.forEach(function(e){t[e].attr({filter:"url(#"+n+")"})}),t.renderer.styledMode&&(i.renderer.definition({tagName:"style",textContent:".highcharts-"+n+" {filter:url(#"+n+")}"}),t.sideGroups.forEach(function(e){e.addClass("highcharts-"+n)}))),t},fillSetter:function(e){var t=this,r=color(e),i=r.rgba[3],n={top:color(e).brighten(.1).get(),bottom:color(e).brighten(-.2).get()};return i<1?(r.rgba[3]=1,r=r.get("rgb"),t.attr({opacity:i})):r=e,r.linearGradient||r.radialGradient||!t.gradientForSides||(r={linearGradient:{x1:0,x2:1,y1:1,y2:1},stops:[[0,color(e).brighten(-.2).get()],[.5,e],[1,color(e).brighten(-.2).get()]]}),r.linearGradient?t.sideGroups.forEach(function(e){var i=t[e].gradientBox,o=r.linearGradient,a=merge(r,{linearGradient:{x1:i.x+o.x1*i.width,y1:i.y+o.y1*i.height,x2:i.x+o.x2*i.width,y2:i.y+o.y2*i.height}});t.sideParts[e].forEach(function(e){n[e]=a})}):(merge(!0,n,{frontUpper:r,backUpper:r,rightUpper:r,frontLower:r,backLower:r,rightLower:r}),r.radialGradient&&t.sideGroups.forEach(function(e){var r=t[e].gradientBox,i=r.x+r.width/2,n=r.y+r.height/2,o=Math.min(r.width,r.height);t.sideParts[e].forEach(function(e){t[e].setRadialReference([i,n,o])})})),t.singleSetterForParts("fill",null,n),t.color=t.fill=e,r.linearGradient&&[t.frontLower,t.frontUpper].forEach(function(e){var r=e.element,i=r&&t.renderer.gradients[r.gradient];i&&"userSpaceOnUse"!==i.attr("gradientUnits")&&i.attr({gradientUnits:"userSpaceOnUse"})}),t},adjustForGradient:function(){var e,t=this;t.sideGroups.forEach(function(r){var i={x:Number.MAX_VALUE,y:Number.MAX_VALUE},n={x:-Number.MAX_VALUE,y:-Number.MAX_VALUE};t.sideParts[r].forEach(function(r){var o=t[r];e=o.getBBox(!0),i={x:Math.min(i.x,e.x),y:Math.min(i.y,e.y)},n={x:Math.max(n.x,e.x+e.width),y:Math.max(n.y,e.y+e.height)}}),t[r].gradientBox={x:i.x,width:n.x-i.x,y:i.y,height:n.y-i.y}})},zIndexSetter:function(){return this.finishedOnAdd&&this.adjustForGradient(),this.renderer.Element.prototype.zIndexSetter.apply(this,arguments)},onAdd:function(){this.adjustForGradient(),this.finishedOnAdd=!0}}),RendererProto.elements3d.funnel3d=funnel3dMethods,RendererProto.funnel3d=function(e){var t=this.element3d("funnel3d",e),r=this.styledMode,i={"stroke-width":1,stroke:"none"};return t.upperGroup=this.g("funnel3d-upper-group").attr({zIndex:t.frontUpper.zIndex}).add(t),[t.frontUpper,t.backUpper,t.rightUpper].forEach(function(e){r||e.attr(i),e.add(t.upperGroup)}),t.lowerGroup=this.g("funnel3d-lower-group").attr({zIndex:t.frontLower.zIndex}).add(t),[t.frontLower,t.backLower,t.rightLower].forEach(function(e){r||e.attr(i),e.add(t.lowerGroup)}),t.gradientForSides=e.gradientForSides,t},RendererProto.funnel3dPath=function(e){this.getCylinderEnd||error("A required Highcharts module is missing: cylinder.js",!0,charts[this.chartIndex]);var t,r,i=charts[this.chartIndex],n=e.alphaCorrection=90-Math.abs(i.options.chart.options3d.alpha%180-90),o=cuboidPath.call(this,H.merge(e,{depth:e.width,width:(e.width+e.bottom.width)/2})),a=o.isTop,d=!o.isFront,h=!!e.middle,s=this.getCylinderEnd(i,H.merge(e,{x:e.x-e.width/2,z:e.z-e.width/2,alphaCorrection:n})),l=e.bottom.width,p=H.merge(e,{width:l,x:e.x-l/2,z:e.z-l/2,alphaCorrection:n}),g=this.getCylinderEnd(i,p,!0),c=l,u=p,f=g,y=g;return h&&(c=e.middle.width,u=H.merge(e,{y:e.y+e.middle.fraction*e.height,width:c,x:e.x-c/2,z:e.z-c/2}),f=this.getCylinderEnd(i,u,!1),y=this.getCylinderEnd(i,u,!1)),(t={top:s,bottom:g,frontUpper:this.getCylinderFront(s,f),zIndexes:{group:o.zIndexes.group,top:0!==a?0:3,bottom:1!==a?0:3,frontUpper:d?2:1,backUpper:d?1:2,rightUpper:d?2:1}}).backUpper=this.getCylinderBack(s,f),r=Math.min(c,e.width)/Math.max(c,e.width)!=1,t.rightUpper=this.getCylinderFront(this.getCylinderEnd(i,H.merge(e,{x:e.x-e.width/2,z:e.z-e.width/2,alphaCorrection:r?-n:0}),!1),this.getCylinderEnd(i,H.merge(u,{alphaCorrection:r?-n:0}),!h)),h&&(r=Math.min(c,l)/Math.max(c,l)!=1,H.merge(!0,t,{frontLower:this.getCylinderFront(y,g),backLower:this.getCylinderBack(y,g),rightLower:this.getCylinderFront(this.getCylinderEnd(i,H.merge(p,{alphaCorrection:r?-n:0}),!0),this.getCylinderEnd(i,H.merge(u,{alphaCorrection:r?-n:0}),!1)),zIndexes:{frontLower:d?2:1,backLower:d?1:2,rightLower:d?1:2}})),t};