"use strict";import H from"../parts/Globals.js";import U from"../parts/Utilities.js";var extend=U.extend,isArray=U.isArray,isNumber=U.isNumber,isObject=U.isObject;import drawPoint from"../mixins/draw-point.js";import polygon from"../mixins/polygon.js";import"../parts/Series.js";var merge=H.merge,noop=H.noop,find=H.find,getBoundingBoxFromPolygon=polygon.getBoundingBoxFromPolygon,getPolygon=polygon.getPolygon,isPolygonsColliding=polygon.isPolygonsColliding,movePolygon=polygon.movePolygon,Series=H.Series;function isRectanglesIntersecting(t,i){return!(i.left>t.right||i.right<t.left||i.top>t.bottom||i.bottom<t.top)}function intersectsAnyWord(t,i){var e=!1,o=t.rect,n=t.polygon,r=t.lastCollidedWith,a=function(i){var e=isRectanglesIntersecting(o,i.rect);return e&&(t.rotation%90||i.rotation%90)&&(e=isPolygonsColliding(n,i.polygon)),e};return r&&((e=a(r))||delete t.lastCollidedWith),e||(e=!!find(i,function(i){var e=a(i);return e&&(t.lastCollidedWith=i),e})),e}function archimedeanSpiral(t,i){var e=i.field,o=!1,n=e.width*e.width+e.height*e.height,r=.8*t;return t<=1e4&&(o={x:r*Math.cos(r),y:r*Math.sin(r)},Math.min(Math.abs(o.x),Math.abs(o.y))<n||(o=!1)),o}function squareSpiral(t,i){var e=4*t,o=Math.ceil((Math.sqrt(e)-1)/2),n=2*o+1,r=Math.pow(n,2),a=function(t){return"boolean"==typeof t},l=!1;return n-=1,t<=1e4&&(a(l)&&e>=r-n&&(l={x:o-(r-e),y:-o}),r-=n,a(l)&&e>=r-n&&(l={x:-o,y:r-e-o}),r-=n,a(l)&&(l=e>=r-n?{x:r-e-o,y:o}:{x:o,y:o-(r-e-n)}),l.x*=5,l.y*=5),l}function rectangularSpiral(t,i){var e=squareSpiral(t,i),o=i.field;return e&&(e.x*=o.ratioX,e.y*=o.ratioY),e}function getRandomPosition(t){return Math.round(t*(Math.random()+.5)/2)}function getScale(t,i,e){var o=2*Math.max(Math.abs(e.top),Math.abs(e.bottom)),n=2*Math.max(Math.abs(e.left),Math.abs(e.right)),r=n>0?1/n*t:1,a=o>0?1/o*i:1;return Math.min(r,a)}function getPlayingField(t,i,e){var o=e.reduce(function(t,i){var e=i.dimensions,o=Math.max(e.width,e.height);return t.maxHeight=Math.max(t.maxHeight,e.height),t.maxWidth=Math.max(t.maxWidth,e.width),t.area+=o*o,t},{maxHeight:0,maxWidth:0,area:0}),n=Math.max(o.maxHeight,o.maxWidth,.85*Math.sqrt(o.area)),r=t>i?t/i:1,a=i>t?i/t:1;return{width:n*r,height:n*a,ratioX:r,ratioY:a}}function getRotation(t,i,e,o){var n=!1;return isNumber(t)&&isNumber(i)&&isNumber(e)&&isNumber(o)&&t>0&&i>-1&&o>e&&(n=e+i%t*((o-e)/(t-1||1))),n}function getSpiral(t,i){var e,o=[];for(e=1;e<1e4;e++)o.push(t(e,i));return function(t){return t<=1e4&&o[t-1]}}function outsidePlayingField(t,i){var e=-i.width/2,o=i.width/2,n=-i.height/2,r=i.height/2;return!(e<t.left&&o>t.right&&n<t.top&&r>t.bottom)}function intersectionTesting(t,i){var e=i.placed,o=i.field,n=i.rectangle,r=i.polygon,a=i.spiral,l=1,s={x:0,y:0},d=t.rect=extend({},n);for(t.polygon=r,t.rotation=i.rotation;!1!==s&&(intersectsAnyWord(t,e)||outsidePlayingField(d,o));)s=a(l),isObject(s)&&(d.left=n.left+s.x,d.right=n.right+s.x,d.top=n.top+s.y,d.bottom=n.bottom+s.y,t.polygon=movePolygon(s.x,s.y,r)),l++;return s}function extendPlayingField(t,i){var e,o,n,r,a,l,s,d;return isObject(t)&&isObject(i)?(e=i.bottom-i.top,l=(a=(o=i.right-i.left)*(n=t.ratioX)>e*(r=t.ratioY)?o:e)*n,s=a*r,d=merge(t,{width:t.width+2*l,height:t.height+2*s})):d=t,d}function updateFieldBoundaries(t,i){return(!isNumber(t.left)||t.left>i.left)&&(t.left=i.left),(!isNumber(t.right)||t.right<i.right)&&(t.right=i.right),(!isNumber(t.top)||t.top>i.top)&&(t.top=i.top),(!isNumber(t.bottom)||t.bottom<i.bottom)&&(t.bottom=i.bottom),t}var wordCloudOptions={allowExtendPlayingField:!0,animation:{duration:500},borderWidth:0,clip:!1,colorByPoint:!0,minFontSize:1,maxFontSize:25,placementStrategy:"center",rotation:{from:0,orientations:2,to:90},showInLegend:!1,spiral:"rectangular",style:{fontFamily:"sans-serif",fontWeight:"900",whiteSpace:"nowrap"},tooltip:{followPointer:!0,pointFormat:'<span style="color:{point.color}">‚óè</span> {series.name}: <b>{point.weight}</b><br/>'}},wordCloudSeries={animate:Series.prototype.animate,animateDrilldown:noop,animateDrillupFrom:noop,setClip:noop,bindAxes:function(){var t={endOnTick:!1,gridLineWidth:0,lineWidth:0,maxPadding:0,startOnTick:!1,title:null,tickPositions:[]};Series.prototype.bindAxes.call(this),extend(this.yAxis.options,t),extend(this.xAxis.options,t)},pointAttribs:function(t,i){var e=H.seriesTypes.column.prototype.pointAttribs.call(this,t,i);return delete e.stroke,delete e["stroke-width"],e},deriveFontSize:function(t,i,e){var o=isNumber(t)?t:0,n=isNumber(i)?i:1,r=isNumber(e)?e:1;return Math.floor(Math.max(r,o*n))},drawPoints:function(){var t,i,e,o=this,n=o.hasRendered,r=o.xAxis,a=o.yAxis,l=o.chart,s=o.group,d=o.options,g=d.animation,h=d.allowExtendPlayingField,p=l.renderer,u=p.text().add(s),m=[],c=o.placementStrategy[d.placementStrategy],y=d.rotation,x=o.points.map(function(t){return t.weight}),f=Math.max.apply(null,x),b=o.points.sort(function(t,i){return i.weight-t.weight});b.forEach(function(t){var i,e=1/f*t.weight,n=o.deriveFontSize(e,d.maxFontSize,d.minFontSize),r=extend({fontSize:n+"px"},d.style);u.css(r).attr({x:0,y:0,text:t.name}),i=u.getBBox(!0),t.dimensions={height:i.height,width:i.width}}),e=getPlayingField(r.len,a.len,b),t=getSpiral(o.spirals[d.spiral],{field:e}),b.forEach(function(i){var r,a=1/f*i.weight,l=o.deriveFontSize(a,d.maxFontSize,d.minFontSize),u=extend({fontSize:l+"px"},d.style),x=c(i,{data:b,field:e,placed:m,rotation:y}),w=extend(o.pointAttribs(i,i.selected&&"select"),{align:"center","alignment-baseline":"middle",x:x.x,y:x.y,text:i.name,rotation:x.rotation}),P=getPolygon(x.x,x.y,i.dimensions.width,i.dimensions.height,x.rotation),v=getBoundingBoxFromPolygon(P),S=intersectionTesting(i,{rectangle:v,polygon:P,field:e,placed:m,spiral:t,rotation:x.rotation});!S&&h&&(S=intersectionTesting(i,{rectangle:v,polygon:P,field:e=extendPlayingField(e,v),placed:m,spiral:t,rotation:x.rotation})),isObject(S)?(w.x+=S.x,w.y+=S.y,v.left+=S.x,v.right+=S.x,v.top+=S.y,v.bottom+=S.y,e=updateFieldBoundaries(e,v),m.push(i),i.isNull=!1):i.isNull=!0,g&&(r={x:w.x,y:w.y},n?(delete w.x,delete w.y):(w.x=0,w.y=0)),i.draw({animatableAttribs:r,attribs:w,css:u,group:s,renderer:p,shapeArgs:void 0,shapeType:"text"})}),u=u.destroy(),i=getScale(r.len,a.len,e),o.group.attr({scaleX:i,scaleY:i})},hasData:function(){return isObject(this)&&!0===this.visible&&isArray(this.points)&&this.points.length>0},placementStrategy:{random:function(t,i){var e=i.field,o=i.rotation;return{x:getRandomPosition(e.width)-e.width/2,y:getRandomPosition(e.height)-e.height/2,rotation:getRotation(o.orientations,t.index,o.from,o.to)}},center:function(t,i){var e=i.rotation;return{x:0,y:0,rotation:getRotation(e.orientations,t.index,e.from,e.to)}}},pointArrayMap:["weight"],spirals:{archimedean:archimedeanSpiral,rectangular:rectangularSpiral,square:squareSpiral},utils:{extendPlayingField:extendPlayingField,getRotation:getRotation,isPolygonsColliding:isPolygonsColliding,rotate2DToOrigin:polygon.rotate2DToOrigin,rotate2DToPoint:polygon.rotate2DToPoint},getPlotBox:function(){var t=this.chart,i=t.inverted,e=this[i?"yAxis":"xAxis"],o=this[i?"xAxis":"yAxis"],n=e?e.len:t.plotWidth,r=o?o.len:t.plotHeight;return{translateX:(e?e.left:t.plotLeft)+n/2,translateY:(o?o.top:t.plotTop)+r/2,scaleX:1,scaleY:1}}},wordCloudPoint={draw:drawPoint,shouldDraw:function(){return!this.isNull},isValid:function(){return!0},weight:1};H.seriesType("wordcloud","column",wordCloudOptions,wordCloudSeries,wordCloudPoint);