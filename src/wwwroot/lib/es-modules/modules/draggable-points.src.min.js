"use strict";import H from"../parts/Globals.js";import U from"../parts/Utilities.js";var objectEach=U.objectEach,pick=U.pick,addEvent=H.addEvent,merge=H.merge,seriesTypes=H.seriesTypes;function flipResizeSide(e){return{left:"right",right:"left",top:"bottom",bottom:"top"}[e]}var horizHandleFormatter=function(e){var r=e.shapeArgs||e.graphic.getBBox(),o=r.r||0,t=r.height-o,a=r.height/2;return["M",0,o,"L",0,a-5,"A",1,1,0,0,0,0,a+5,"A",1,1,0,0,0,0,a-5,"M",0,a+5,"L",0,t]},lineDragDropProps=seriesTypes.line.prototype.dragDropProps={x:{axis:"x",move:!0},y:{axis:"y",move:!0}};seriesTypes.flags&&(seriesTypes.flags.prototype.dragDropProps=lineDragDropProps);var columnDragDropProps=seriesTypes.column.prototype.dragDropProps={x:{axis:"x",move:!0},y:{axis:"y",move:!1,resize:!0,beforeResize:function(e,r,o){var t,a,i=o.series.translatedThreshold,n=e.attr("y");r.y>=o.series.options.threshold?(t=e.attr("height"),a=i?i-(n+t):0,e.attr({height:Math.max(0,Math.round(t+a))})):e.attr({y:Math.round(n+(i?i-n:0))})},resizeSide:function(e,r){var o=r.series.chart.dragHandles,t=e.y>=(r.series.options.threshold||0)?"top":"bottom",a=flipResizeSide(t);return o[a]&&(o[a].destroy(),delete o[a]),t},handlePositioner:function(e){var r=e.shapeArgs||e.graphic.getBBox();return{x:r.x,y:e.y>=(e.series.options.threshold||0)?r.y:r.y+r.height}},handleFormatter:function(e){var r=e.shapeArgs,o=r.r||0,t=r.width/2;return["M",o,0,"L",t-5,0,"A",1,1,0,0,0,t+5,0,"A",1,1,0,0,0,t-5,0,"M",t+5,0,"L",r.width-o,0]}}};if(seriesTypes.bullet&&(seriesTypes.bullet.prototype.dragDropProps={x:columnDragDropProps.x,y:columnDragDropProps.y,target:{optionName:"draggableTarget",axis:"y",move:!0,resize:!0,resizeSide:"top",handlePositioner:function(e){var r=e.targetGraphic.getBBox();return{x:e.barX,y:r.y+r.height/2}},handleFormatter:columnDragDropProps.y.handleFormatter}}),seriesTypes.columnrange&&(seriesTypes.columnrange.prototype.dragDropProps={x:{axis:"x",move:!0},low:{optionName:"draggableLow",axis:"y",move:!0,resize:!0,resizeSide:"bottom",handlePositioner:function(e){var r=e.shapeArgs||e.graphic.getBBox();return{x:r.x,y:r.y+r.height}},handleFormatter:columnDragDropProps.y.handleFormatter,propValidate:function(e,r){return e<=r.high}},high:{optionName:"draggableHigh",axis:"y",move:!0,resize:!0,resizeSide:"top",handlePositioner:function(e){var r=e.shapeArgs||e.graphic.getBBox();return{x:r.x,y:r.y}},handleFormatter:columnDragDropProps.y.handleFormatter,propValidate:function(e,r){return e>=r.low}}}),seriesTypes.boxplot&&(seriesTypes.boxplot.prototype.dragDropProps={x:columnDragDropProps.x,low:{optionName:"draggableLow",axis:"y",move:!0,resize:!0,resizeSide:"bottom",handlePositioner:function(e){return{x:e.shapeArgs.x,y:e.lowPlot}},handleFormatter:columnDragDropProps.y.handleFormatter,propValidate:function(e,r){return e<=r.q1}},q1:{optionName:"draggableQ1",axis:"y",move:!0,resize:!0,resizeSide:"bottom",handlePositioner:function(e){return{x:e.shapeArgs.x,y:e.q1Plot}},handleFormatter:columnDragDropProps.y.handleFormatter,propValidate:function(e,r){return e<=r.median&&e>=r.low}},median:{axis:"y",move:!0},q3:{optionName:"draggableQ3",axis:"y",move:!0,resize:!0,resizeSide:"top",handlePositioner:function(e){return{x:e.shapeArgs.x,y:e.q3Plot}},handleFormatter:columnDragDropProps.y.handleFormatter,propValidate:function(e,r){return e<=r.high&&e>=r.median}},high:{optionName:"draggableHigh",axis:"y",move:!0,resize:!0,resizeSide:"top",handlePositioner:function(e){return{x:e.shapeArgs.x,y:e.highPlot}},handleFormatter:columnDragDropProps.y.handleFormatter,propValidate:function(e,r){return e>=r.q3}}}),seriesTypes.ohlc&&(seriesTypes.ohlc.prototype.dragDropProps={x:columnDragDropProps.x,low:{optionName:"draggableLow",axis:"y",move:!0,resize:!0,resizeSide:"bottom",handlePositioner:function(e){return{x:e.shapeArgs.x,y:e.plotLow}},handleFormatter:columnDragDropProps.y.handleFormatter,propValidate:function(e,r){return e<=r.open&&e<=r.close}},high:{optionName:"draggableHigh",axis:"y",move:!0,resize:!0,resizeSide:"top",handlePositioner:function(e){return{x:e.shapeArgs.x,y:e.plotHigh}},handleFormatter:columnDragDropProps.y.handleFormatter,propValidate:function(e,r){return e>=r.open&&e>=r.close}},open:{optionName:"draggableOpen",axis:"y",move:!0,resize:!0,resizeSide:function(e){return e.open>=e.close?"top":"bottom"},handlePositioner:function(e){return{x:e.shapeArgs.x,y:e.plotOpen}},handleFormatter:columnDragDropProps.y.handleFormatter,propValidate:function(e,r){return e<=r.high&&e>=r.low}},close:{optionName:"draggableClose",axis:"y",move:!0,resize:!0,resizeSide:function(e){return e.open>=e.close?"bottom":"top"},handlePositioner:function(e){return{x:e.shapeArgs.x,y:e.plotClose}},handleFormatter:columnDragDropProps.y.handleFormatter,propValidate:function(e,r){return e<=r.high&&e>=r.low}}}),seriesTypes.arearange){var columnrangeDragDropProps=seriesTypes.columnrange.prototype.dragDropProps,arearangeHandleFormatter=function(e){var r=e.graphic?e.graphic.getBBox().width/2+1:4;return["M",0-r,0,"a",r,r,0,1,0,2*r,0,"a",r,r,0,1,0,-2*r,0]};seriesTypes.arearange.prototype.dragDropProps={x:columnrangeDragDropProps.x,low:{optionName:"draggableLow",axis:"y",move:!0,resize:!0,resizeSide:"bottom",handlePositioner:function(e){var r=e.lowerGraphic&&e.lowerGraphic.getBBox();return r?{x:r.x+r.width/2,y:r.y+r.height/2}:{x:-999,y:-999}},handleFormatter:arearangeHandleFormatter,propValidate:columnrangeDragDropProps.low.propValidate},high:{optionName:"draggableHigh",axis:"y",move:!0,resize:!0,resizeSide:"top",handlePositioner:function(e){var r=e.upperGraphic&&e.upperGraphic.getBBox();return r?{x:r.x+r.width/2,y:r.y+r.height/2}:{x:-999,y:-999}},handleFormatter:arearangeHandleFormatter,propValidate:columnrangeDragDropProps.high.propValidate}}}if(seriesTypes.waterfall&&(seriesTypes.waterfall.prototype.dragDropProps={x:columnDragDropProps.x,y:merge(columnDragDropProps.y,{handleFormatter:function(e){return e.isSum||e.isIntermediateSum?null:columnDragDropProps.y.handleFormatter(e)}})}),seriesTypes.xrange){var xrangeHandlePositioner=function(e,r){var o=e.series,t=o.xAxis,a=o.yAxis,i=o.chart.inverted,n=t.toPixels(e[r],!0),s=a.toPixels(e.y,!0);return i?(n=t.len-n,s=a.len-s-e.shapeArgs.height/2):s-=e.shapeArgs.height/2,{x:Math.round(n),y:Math.round(s)}},xrangeDragDropProps=seriesTypes.xrange.prototype.dragDropProps={y:{axis:"y",move:!0},x:{optionName:"draggableX1",axis:"x",move:!0,resize:!0,resizeSide:"left",handlePositioner:function(e){return xrangeHandlePositioner(e,"x")},handleFormatter:horizHandleFormatter,propValidate:function(e,r){return e<=r.x2}},x2:{optionName:"draggableX2",axis:"x",move:!0,resize:!0,resizeSide:"right",handlePositioner:function(e){return xrangeHandlePositioner(e,"x2")},handleFormatter:horizHandleFormatter,propValidate:function(e,r){return e>=r.x}}};seriesTypes.gantt&&(seriesTypes.gantt.prototype.dragDropProps={y:xrangeDragDropProps.y,start:merge(xrangeDragDropProps.x,{optionName:"draggableStart",validateIndividualDrag:function(e){return!e.milestone}}),end:merge(xrangeDragDropProps.x2,{optionName:"draggableEnd",validateIndividualDrag:function(e){return!e.milestone}})})}["gauge","pie","sunburst","wordcloud","sankey","histogram","pareto","vector","windbarb","treemap","bellcurve","sma","map","mapline"].forEach(function(e){seriesTypes[e]&&(seriesTypes[e].prototype.dragDropProps=null)});var defaultDragSensitivity=2,defaultGuideBoxOptions={default:{className:"highcharts-drag-box-default",lineWidth:1,lineColor:"#888",color:"rgba(0, 0, 0, 0.1)",cursor:"move",zIndex:900}},defaultDragHandleOptions={className:"highcharts-drag-handle",color:"#fff",lineColor:"rgba(0, 0, 0, 0.6)",lineWidth:1,zIndex:901};function isSeriesDraggable(e){var r,o=["draggableX","draggableY"];for(objectEach(e.dragDropProps,function(e){e.optionName&&o.push(e.optionName)}),r=o.length;r--;)if(e.options.dragDrop[o[r]])return!0}function isChartDraggable(e){var r=e.series?e.series.length:0;if(e.hasCartesianSeries&&!e.polar)for(;r--;)if(e.series[r].options.dragDrop&&isSeriesDraggable(e.series[r]))return!0}function isPointMovable(e){var r,o,t=e.series,a=t.options.dragDrop||{},i=e.options&&e.options.dragDrop,n=t.dragDropProps;return objectEach(n,function(e){"x"===e.axis&&e.move?r=!0:"y"===e.axis&&e.move&&(o=!0)}),(a.draggableX&&r||a.draggableY&&o)&&!(i&&!1===i.draggableX&&!1===i.draggableY)&&t.yAxis&&t.xAxis}function getNormalizedEvent(e,r){return void 0===e.chartX||void 0===e.chartY?r.pointer.normalize(e):e}function addEvents(e,r,o,t){var a=r.map(function(r){return addEvent(e,r,o,t)});return function(){a.forEach(function(e){e()})}}function hasDraggedPastSensitivity(e,r,o){var t=r.dragDropData.origin,a=t.chartX,i=t.chartY,n=e.chartX,s=e.chartY;return Math.sqrt((n-a)*(n-a)+(s-i)*(s-i))>o}function getPositionSnapshot(e,r,o){var t={chartX:e.chartX,chartY:e.chartY,guideBox:o&&{x:o.attr("x"),y:o.attr("y"),width:o.attr("width"),height:o.attr("height")},points:{}};return r.forEach(function(r){var o={};objectEach(r.series.dragDropProps,function(t,a){var i=r.series[t.axis+"Axis"];o[a]=r[a],o[a+"Offset"]=i.toPixels(r[a])-(i.horiz?e.chartX:e.chartY)}),o.point=r,t.points[r.id]=o}),t}function getGroupedPoints(e){var r=e.series,o=[],t=r.options.dragDrop.groupBy;return r.isSeriesBoosting?r.options.data.forEach(function(e,t){o.push((new r.pointClass).init(r,e)),o[o.length-1].index=t}):o=r.points,e.options[t]?o.filter(function(r){return r.options[t]===e.options[t]}):[e]}function resizeRect(e,r,o){var t;switch(r){case"left":t={x:e.attr("x")+o.x,width:Math.max(1,e.attr("width")-o.x)};break;case"right":t={width:Math.max(1,e.attr("width")+o.x)};break;case"top":t={y:e.attr("y")+o.y,height:Math.max(1,e.attr("height")-o.y)};break;case"bottom":t={height:Math.max(1,e.attr("height")+o.y)}}e.attr(t)}function initDragDrop(e,r){var o,t=getGroupedPoints(r),a=r.series,i=a.chart;pick(a.options.dragDrop&&a.options.dragDrop.liveRedraw,!0)||(i.dragGuideBox=o=a.getGuideBox(t),i.setGuideBoxState("default",a.options.dragDrop.guideBox).add(a.group)),i.dragDropData={origin:getPositionSnapshot(e,t,o),point:r,groupedPoints:t,isDragging:!0}}function getNewPoints(e,r){var o=e.point,t=o.series,a=merge(t.options.dragDrop,o.options.dragDrop),i={},n=e.updateProp,s={};return objectEach(o.series.dragDropProps,function(e,r){n&&(n!==r||!e.resize||e.optionName&&!1===a[e.optionName])||(n||e.move&&("x"===e.axis&&a.draggableX||"y"===e.axis&&a.draggableY))&&(i[r]=e)}),(n?[o]:e.groupedPoints).forEach(function(o){s[o.id]={point:o,newValues:o.getDropValues(e.origin,r,i)}}),s}function updatePoints(e,r){var o=e.dragDropData.newPoints,t=!1!==r&&merge({duration:400},e.options.chart.animation);e.isDragDropAnimating=!0,objectEach(o,function(e){e.point.update(e.newValues,!1)}),e.redraw(t),setTimeout(function(){delete e.isDragDropAnimating,e.hoverPoint&&!e.dragHandles&&e.hoverPoint.showDragHandles()},t.duration)}function resizeGuideBox(e,r,o){var t,a,i=e.series,n=i.chart,s=n.dragDropData,d=i.dragDropProps[s.updateProp];a=s.newPoints[e.id].newValues,t="function"==typeof d.resizeSide?d.resizeSide(a,e):d.resizeSide,d.beforeResize&&d.beforeResize(n.dragGuideBox,a,e),resizeRect(n.dragGuideBox,"x"===d.axis&&i.xAxis.reversed||"y"===d.axis&&i.yAxis.reversed?flipResizeSide(t):t,{x:"x"===d.axis?r-(s.origin.prevdX||0):0,y:"y"===d.axis?o-(s.origin.prevdY||0):0})}function dragMove(e,r){var o=r.series,t=o.chart,a=t.dragDropData,i=merge(o.options.dragDrop,r.options.dragDrop),n=i.draggableX,s=i.draggableY,d=a.origin,p=e.chartX-d.chartX,g=e.chartY-d.chartY,l=p,u=a.updateProp;t.inverted&&(p=-g,g=-l),pick(i.liveRedraw,!0)?(updatePoints(t,!1),r.showDragHandles()):u?resizeGuideBox(r,p,g):t.dragGuideBox.translate(n?p:0,s?g:0),d.prevdX=p,d.prevdY=g}function mouseOut(e){var r=e.series&&e.series.chart,o=r&&r.dragDropData;!r||!r.dragHandles||o&&(o.isDragging&&o.draggedPastSensitivity||o.isHoveringHandle===e.id)||r.hideDragHandles()}function onResizeHandleMouseOut(e){var r=e.series.chart;r.dragDropData&&e.id===r.dragDropData.isHoveringHandle&&delete r.dragDropData.isHoveringHandle,r.hoverPoint||mouseOut(e)}function onResizeHandleMouseDown(e,r,o){var t=r.series.chart;t.zoomOrPanKeyPressed(e)||(t.mouseIsDown=!1,initDragDrop(e,r),t.dragDropData.updateProp=e.updateProp=o,r.firePointEvent("dragStart",e),e.stopPropagation(),e.preventDefault())}function countProps(e){var r=0;for(var o in e)Object.hasOwnProperty.call(e,o)&&r++;return r}function getFirstProp(e){for(var r in e)if(Object.hasOwnProperty.call(e,r))return e[r]}function mouseOver(e){var r=e.series,o=r&&r.chart,t=o&&o.dragDropData;!o||t&&t.isDragging&&t.draggedPastSensitivity||o.isDragDropAnimating||!r.options.dragDrop||o.options&&o.options.chart&&o.options.chart.options3d||(o.dragHandles&&o.hideDragHandles(),e.showDragHandles())}function mouseMove(e,r){if(!r.zoomOrPanKeyPressed(e)){var o,t,a,i,n=r.dragDropData,s=0;n&&n.isDragging&&(t=(o=n.point).series.options.dragDrop,e.preventDefault(),n.draggedPastSensitivity||(n.draggedPastSensitivity=hasDraggedPastSensitivity(e,r,pick(o.options.dragDrop&&o.options.dragDrop.dragSensitivity,t&&t.dragSensitivity,defaultDragSensitivity))),n.draggedPastSensitivity&&(n.newPoints=getNewPoints(n,e),i=1===(s=countProps(a=n.newPoints))?getFirstProp(a):null,o.firePointEvent("drag",{origin:n.origin,newPoints:n.newPoints,newPoint:i&&i.newValues,newPointId:i&&i.point.id,numNewPoints:s,chartX:e.chartX,chartY:e.chartY},function(){dragMove(e,o)})))}}function mouseUp(e,r){var o=r.dragDropData;if(o&&o.isDragging&&o.draggedPastSensitivity){var t=o.point,a=o.newPoints,i=countProps(a),n=1===i?getFirstProp(a):null;r.dragHandles&&r.hideDragHandles(),e.preventDefault(),r.cancelClick=!0,t.firePointEvent("drop",{origin:o.origin,chartX:e.chartX,chartY:e.chartY,newPoints:a,numNewPoints:i,newPoint:n&&n.newValues,newPointId:n&&n.point.id},function(){updatePoints(r)})}delete r.dragDropData,r.dragGuideBox&&(r.dragGuideBox.destroy(),delete r.dragGuideBox)}function mouseDown(e,r){var o=r.hoverPoint,t=H.merge(o&&o.series.options.dragDrop,o&&o.options.dragDrop),a=t.draggableX||!1,i=t.draggableY||!1;r.cancelClick=!1,!a&&!i||r.zoomOrPanKeyPressed(e)||r.hasDraggedAnnotation||(r.dragDropData&&r.dragDropData.isDragging?mouseUp(e,r):o&&isPointMovable(o)&&(r.mouseIsDown=!1,initDragDrop(e,o),o.firePointEvent("dragStart",e)))}function addDragDropEvents(e){var r=e.container,o=H.doc;isChartDraggable(e)&&(addEvents(r,["mousedown","touchstart"],function(r){mouseDown(getNormalizedEvent(r,e),e)}),addEvents(r,["mousemove","touchmove"],function(r){mouseMove(getNormalizedEvent(r,e),e)}),addEvent(r,"mouseleave",function(r){mouseUp(getNormalizedEvent(r,e),e)}),e.unbindDragDropMouseUp=addEvents(o,["mouseup","touchend"],function(r){mouseUp(getNormalizedEvent(r,e),e)}),e.hasAddedDragDropEvents=!0,addEvent(e,"destroy",function(){e.unbindDragDropMouseUp&&e.unbindDragDropMouseUp()}))}H.Chart.prototype.setGuideBoxState=function(e,r){var o=this.dragGuideBox,t=merge(defaultGuideBoxOptions,r),a=merge(t.default,t[e]);return o.attr({className:a.className,stroke:a.lineColor,strokeWidth:a.lineWidth,fill:a.color,cursor:a.cursor,zIndex:a.zIndex}).css({pointerEvents:"none"})},H.Point.prototype.getDropValues=function(e,r,o){var t,a=this,i=a.series,n=merge(i.options.dragDrop,a.options.dragDrop),s={},d=e.points[a.id];for(var p in o)if(Object.hasOwnProperty.call(o,p)){if(void 0!==t){t=!1;break}t=!0}return objectEach(o,function(e,o){var p=d[o],g=i[e.axis+"Axis"],l=function(e,r){var o=i[r.toLowerCase()+"Axis"].categories?1:0,t=pick(n["dragPrecision"+r],o),a=pick(n["dragMin"+r],-1/0),s=pick(n["dragMax"+r],1/0),d=e;return t&&(d=Math.round(d/t)*t),Math.max(a,Math.min(s,d))}(g.toValue((g.horiz?r.chartX:r.chartY)+d[o+"Offset"]),e.axis.toUpperCase());t&&e.propValidate&&!e.propValidate(l,a)||void 0===p||(s[o]=l)}),s},H.Series.prototype.getGuideBox=function(e){var r,o=this.chart,t=1/0,a=-1/0,i=1/0,n=-1/0;return e.forEach(function(e){var o=e.graphic&&e.graphic.getBBox()||e.shapeArgs;o&&(o.width||o.height||o.x||o.y)&&(r=!0,t=Math.min(o.x,t),a=Math.max(o.x+o.width,a),i=Math.min(o.y,i),n=Math.max(o.y+o.height,n))}),r?o.renderer.rect(t,i,a-t,n-i):o.renderer.g()},H.Point.prototype.showDragHandles=function(){var e=this,r=e.series,o=r.chart,t=o.renderer,a=merge(r.options.dragDrop,e.options.dragDrop);objectEach(r.dragDropProps,function(i,n){var s,d,p,g,l=merge(defaultDragHandleOptions,i.handleOptions,a.dragHandle),u={className:l.className,"stroke-width":l.lineWidth,fill:l.color,stroke:l.lineColor},h=l.pathFormatter||i.handleFormatter,c=i.handlePositioner,m=!i.validateIndividualDrag||i.validateIndividualDrag(e);if(i.resize&&m&&i.resizeSide&&h&&(a["draggable"+i.axis.toUpperCase()]||a[i.optionName])&&!1!==a[i.optionName]){if(o.dragHandles||(o.dragHandles={group:t.g("drag-drop-handles").add(r.markerGroup||r.group)}),o.dragHandles.point=e.id,s=c(e),u.d=g=h(e),p="function"==typeof i.resizeSide?i.resizeSide(e.options,e):i.resizeSide,!g||s.x<0||s.y<0)return;u.cursor=l.cursor||"x"===i.axis!=!!o.inverted?"ew-resize":"ns-resize",(d=o.dragHandles[p])||(d=o.dragHandles[p]=t.path().add(o.dragHandles.group)),d.translate(s.x,s.y).attr(u),addEvents(d.element,["touchstart","mousedown"],function(r){onResizeHandleMouseDown(getNormalizedEvent(r,o),e,n)}),addEvent(o.dragHandles.group.element,"mouseover",function(){o.dragDropData=o.dragDropData||{},o.dragDropData.isHoveringHandle=e.id}),addEvents(o.dragHandles.group.element,["touchend","mouseout"],function(){onResizeHandleMouseOut(e)})}})},H.Chart.prototype.hideDragHandles=function(){this.dragHandles&&(objectEach(this.dragHandles,function(e,r){"group"!==r&&e.destroy&&e.destroy()}),this.dragHandles.group&&this.dragHandles.group.destroy&&this.dragHandles.group.destroy(),delete this.dragHandles)},addEvent(H.Point,"mouseOver",function(){var e=this;setTimeout(function(){mouseOver(e)},12)}),addEvent(H.Point,"mouseOut",function(){var e=this;setTimeout(function(){e.series&&mouseOut(e)},10)}),addEvent(H.Point,"remove",function(){var e=this.series.chart,r=e.dragHandles;r&&r.point===this.id&&e.hideDragHandles()}),H.Chart.prototype.zoomOrPanKeyPressed=function(e){var r=this.userOptions.chart||{},o=r.panKey&&r.panKey+"Key";return e[r.zoomKey&&r.zoomKey+"Key"]||e[o]},addEvent(H.Chart,"render",function(){this.hasAddedDragDropEvents||addDragDropEvents(this)});