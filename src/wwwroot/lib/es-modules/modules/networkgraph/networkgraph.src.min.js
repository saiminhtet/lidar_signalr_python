"use strict";import H from"../../parts/Globals.js";import U from"../../parts/Utilities.js";var defined=U.defined,pick=U.pick;import"../../parts/Options.js";import"../../mixins/nodes.js";import"./layouts.js";import"./draggable-nodes.js";var addEvent=H.addEvent,seriesType=H.seriesType,seriesTypes=H.seriesTypes,Point=H.Point,Series=H.Series,dragNodesMixin=H.dragNodesMixin;seriesType("networkgraph","line",{stickyTracking:!1,inactiveOtherPoints:!0,marker:{enabled:!0,states:{inactive:{opacity:.3,animation:{duration:50}}}},states:{inactive:{linkOpacity:.3,animation:{duration:50}}},dataLabels:{formatter:function(){return this.key},linkFormatter:function(){return this.point.fromNode.name+"<br>"+this.point.toNode.name},linkTextPath:{enabled:!0},textPath:{enabled:!1}},link:{color:"rgba(100, 100, 100, 0.5)",width:1},draggable:!0,layoutAlgorithm:{initialPositions:"circle",initialPositionRadius:1,enableSimulation:!1,theta:.5,maxSpeed:10,approximation:"none",type:"reingold-fruchterman",integration:"euler",maxIterations:1e3,gravitationalConstant:.0625,friction:-.981},showInLegend:!1},{forces:["barycenter","repulsive","attractive"],hasDraggableNodes:!0,drawGraph:null,isCartesian:!1,requireSorting:!1,directTouch:!0,noSharedTooltip:!0,pointArrayMap:["from","to"],trackerGroups:["group","markerGroup","dataLabelsGroup"],drawTracker:H.TrackerMixin.drawTrackerPoint,animate:null,buildKDTree:H.noop,createNode:H.NodesMixin.createNode,destroy:function(){this.layout.removeElementFromCollection(this,this.layout.series),H.NodesMixin.destroy.call(this)},init:function(){return Series.prototype.init.apply(this,arguments),addEvent(this,"updatedData",function(){this.layout&&this.layout.stop()}),this},generatePoints:function(){var t,i;for(H.NodesMixin.generatePoints.apply(this,arguments),this.options.nodes&&this.options.nodes.forEach(function(t){this.nodeLookup[t.id]||(this.nodeLookup[t.id]=this.createNode(t.id))},this),i=this.nodes.length-1;i>=0;i--)(t=this.nodes[i]).degree=t.getDegree(),t.radius=pick(t.marker&&t.marker.radius,this.options.marker&&this.options.marker.radius,0),this.nodeLookup[t.id]||t.remove();this.data.forEach(function(t){t.formatPrefix="link"}),this.indexateNodes()},indexateNodes:function(){this.nodes.forEach(function(t,i){t.index=i})},markerAttribs:function(t,i){var e=Series.prototype.markerAttribs.call(this,t,i);return defined(t.plotY)||(e.y=0),e.x=(t.plotX||0)-(e.width/2||0),e},translate:function(){this.processedXData||this.processData(),this.generatePoints(),this.deferLayout(),this.nodes.forEach(function(t){t.isInside=!0,t.linksFrom.forEach(function(t){t.shapeType="path",t.y=1})})},deferLayout:function(){var t,i=this.options.layoutAlgorithm,e=this.chart.graphLayoutsStorage,s=this.chart.graphLayoutsLookup,o=this.chart.options.chart;this.visible&&(e||(this.chart.graphLayoutsStorage=e={},this.chart.graphLayoutsLookup=s=[]),(t=e[i.type])||(i.enableSimulation=defined(o.forExport)?!o.forExport:i.enableSimulation,e[i.type]=t=new H.layouts[i.type],t.init(i),s.splice(t.index,0,t)),this.layout=t,t.setArea(0,0,this.chart.plotWidth,this.chart.plotHeight),t.addElementsToCollection([this],t.series),t.addElementsToCollection(this.nodes,t.nodes),t.addElementsToCollection(this.points,t.links))},render:function(){var t=this.points,i=this.chart.hoverPoint,e=[];this.points=this.nodes,seriesTypes.line.prototype.render.call(this),this.points=t,t.forEach(function(t){t.fromNode&&t.toNode&&(t.renderLink(),t.redrawLink())}),i&&i.series===this&&this.redrawHalo(i),this.chart.hasRendered&&!this.options.dataLabels.allowOverlap&&(this.nodes.concat(this.points).forEach(function(t){t.dataLabel&&e.push(t.dataLabel)}),this.chart.hideOverlappingLabels(e))},drawDataLabels:function(){var t=this.options.dataLabels.textPath;Series.prototype.drawDataLabels.apply(this,arguments),this.points=this.data,this.options.dataLabels.textPath=this.options.dataLabels.linkTextPath,Series.prototype.drawDataLabels.apply(this,arguments),this.points=this.nodes,this.options.dataLabels.textPath=t},pointAttribs:function(t,i){var e=i||t.state||"normal",s=Series.prototype.pointAttribs.call(this,t,e),o=this.options.states[e];return t.isNode||(s=t.getLinkAttributes(),o&&(s={stroke:o.linkColor||s.stroke,dashstyle:o.linkDashStyle||s.dashstyle,opacity:pick(o.linkOpacity,s.opacity),"stroke-width":o.linkColor||s["stroke-width"]})),s},redrawHalo:dragNodesMixin.redrawHalo,onMouseDown:dragNodesMixin.onMouseDown,onMouseMove:dragNodesMixin.onMouseMove,onMouseUp:dragNodesMixin.onMouseUp,setState:function(t,i){i?(this.points=this.nodes.concat(this.data),Series.prototype.setState.apply(this,arguments),this.points=this.data):Series.prototype.setState.apply(this,arguments),this.layout.simulation||t||this.render()}},{setState:H.NodesMixin.setNodeState,init:function(){return Point.prototype.init.apply(this,arguments),this.series.options.draggable&&!this.series.chart.styledMode&&(addEvent(this,"mouseOver",function(){H.css(this.series.chart.container,{cursor:"move"})}),addEvent(this,"mouseOut",function(){H.css(this.series.chart.container,{cursor:"default"})})),this},getDegree:function(){var t=this.isNode?this.linksFrom.length+this.linksTo.length:0;return 0===t?1:t},getLinkAttributes:function(){var t=this.series.options.link,i=this.options;return{"stroke-width":pick(i.width,t.width),stroke:i.color||t.color,dashstyle:i.dashStyle||t.dashStyle,opacity:pick(i.opacity,t.opacity,1)}},renderLink:function(){var t;this.graphic||(this.graphic=this.series.chart.renderer.path(this.getLinkPath()).add(this.series.group),this.series.chart.styledMode||(t=this.series.pointAttribs(this),this.graphic.attr(t),(this.dataLabels||[]).forEach(function(i){i&&i.attr({opacity:t.opacity})})))},redrawLink:function(){var t,i=this.getLinkPath();this.graphic&&(this.shapeArgs={d:i},this.series.chart.styledMode||(t=this.series.pointAttribs(this),this.graphic.attr(t),(this.dataLabels||[]).forEach(function(i){i&&i.attr({opacity:t.opacity})})),this.graphic.animate(this.shapeArgs),this.plotX=(i[1]+i[4])/2,this.plotY=(i[2]+i[5])/2)},getMass:function(){var t=this.fromNode.mass,i=this.toNode.mass,e=t+i;return{fromNode:1-t/e,toNode:1-i/e}},getLinkPath:function(){var t=this.fromNode,i=this.toNode;return t.plotX>i.plotX&&(t=this.toNode,i=this.fromNode),["M",t.plotX,t.plotY,"L",i.plotX,i.plotY]},isValid:function(){return!this.isNode||defined(this.id)},remove:function(t,i){var e,s=this.series,o=s.options.nodes||[],r=o.length;if(this.isNode){for(s.points=[],[].concat(this.linksFrom).concat(this.linksTo).forEach(function(t){(e=t.fromNode.linksFrom.indexOf(t))>-1&&t.fromNode.linksFrom.splice(e,1),(e=t.toNode.linksTo.indexOf(t))>-1&&t.toNode.linksTo.splice(e,1),Series.prototype.removePoint.call(s,s.data.indexOf(t),!1,!1)}),s.points=s.data.slice(),s.nodes.splice(s.nodes.indexOf(this),1);r--;)if(o[r].id===this.options.id){s.options.nodes.splice(r,1);break}this&&this.destroy(),s.isDirty=!0,s.isDirtyData=!0,t&&s.chart.redraw(t)}else s.removePoint(s.data.indexOf(this),t,i)},destroy:function(){return this.isNode&&this.linksFrom.concat(this.linksTo).forEach(function(t){t.destroyElements&&t.destroyElements()}),this.series.layout.removeElementFromCollection(this,this.series.layout[this.isNode?"nodes":"links"]),Point.prototype.destroy.apply(this,arguments)}});