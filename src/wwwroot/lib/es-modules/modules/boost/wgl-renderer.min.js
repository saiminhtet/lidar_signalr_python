"use strict";import H from"../../parts/Globals.js";import GLShader from"./wgl-shader.js";import GLVertexBuffer from"./wgl-vbuffer.js";import U from"../../parts/Utilities.js";var isNumber=U.isNumber,objEach=U.objectEach;import"../../parts/Color.js";var win=H.win,doc=win.document,merge=H.merge,some=H.some,Color=H.Color,pick=H.pick;function GLRenderer(e){var t=!1,i=!1,n=!1,r=0,s=0,o=!1,a=!1,l={},d=!1,u=[],m={},c={column:!0,columnrange:!0,bar:!0,area:!0,arearange:!0},g={scatter:!0,bubble:!0},h={pointSize:1,lineWidth:1,fillColor:"#AA00AA",useAlpha:!0,usePreallocated:!1,useGPUTranslations:!1,debug:{timeRendering:!1,timeSeriesProcessing:!1,timeSetup:!1,timeBufferCopy:!1,timeKDTree:!1,showSkipSummary:!1}};function f(e){var t,i,n;return e.isSeriesBoosting?(t=!!e.options.stacking,i=e.xData||e.options.xData||e.processedXData,n=(t?e.data:i||e.options.data).length,"treemap"===e.type?n*=12:"heatmap"===e.type?n*=6:c[e.type]&&(n*=2),n):0}function p(e,t){return[2/e,0,0,0,0,-2/t,0,0,0,0,-2,0,-1,1,-1,1]}function x(){n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT)}function b(){u=[],l.data=o=[],a=[],i&&i.destroy()}function A(e){t&&(t.setUniform("xAxisTrans",e.transA),t.setUniform("xAxisMin",e.min),t.setUniform("xAxisMinPad",e.minPixelPadding),t.setUniform("xAxisPointRange",e.pointRange),t.setUniform("xAxisLen",e.len),t.setUniform("xAxisPos",e.pos),t.setUniform("xAxisCVSCoord",!e.horiz),t.setUniform("xAxisIsLog",e.isLog),t.setUniform("xAxisReversed",!!e.reversed))}function T(e){t&&(t.setUniform("yAxisTrans",e.transA),t.setUniform("yAxisMin",e.min),t.setUniform("yAxisMinPad",e.minPixelPadding),t.setUniform("yAxisPointRange",e.pointRange),t.setUniform("yAxisLen",e.len),t.setUniform("yAxisPos",e.pos),t.setUniform("yAxisCVSCoord",!e.horiz),t.setUniform("yAxisIsLog",e.isLog),t.setUniform("yAxisReversed",!!e.reversed))}function E(e,i){t.setUniform("hasThreshold",e),t.setUniform("translatedThreshold",i)}function y(o){return!!o&&(!o.chartHeight||o.chartWidth,r=o.chartWidth||800,s=o.chartHeight||400,!!(n&&r&&s&&t)&&(h.debug.timeRendering&&console.time("gl rendering"),n.canvas.width=r,n.canvas.height=s,t.bind(),n.viewport(0,0,r,s),t.setPMatrix(p(r,s)),h.lineWidth>1&&!H.isMS&&n.lineWidth(h.lineWidth),i.build(l.data,"aVertexPosition",4),i.bind(),t.setInverted(o.inverted),u.forEach(function(e,r){var s,a,l,d,u=e.series.options,c=u.marker,f=void 0!==u.lineWidth?u.lineWidth:1,p=u.threshold,x=isNumber(p),b=e.series.yAxis.getThreshold(p),y=pick(u.marker?u.marker.enabled:null,!!e.series.xAxis.isRadial||null,e.series.closestPointRangePx>2*((u.marker?u.marker.radius:10)||10)),P=m[c&&c.symbol||e.series.symbol]||m.circle;if(!(0===e.segments.length||e.segmentslength&&e.segments[0].from===e.segments[0].to)){if(P.isReady&&(n.bindTexture(n.TEXTURE_2D,P.handle),t.setTexture(P.handle)),o.styledMode?l=e.series.markerGroup&&e.series.markerGroup.getStyle("fill"):(l=e.series.pointAttribs&&e.series.pointAttribs().fill||e.series.color,u.colorByPoint&&(l=e.series.chart.options.colors[r])),e.series.fillOpacity&&u.fillOpacity&&(l=new Color(l).setOpacity(pick(u.fillOpacity,1)).get()),d=H.color(l).rgba,h.useAlpha||(d[3]=1),"lines"===e.drawMode&&h.useAlpha&&d[3]<1&&(d[3]/=10),"add"===u.boostBlending?(n.blendFunc(n.SRC_ALPHA,n.ONE),n.blendEquation(n.FUNC_ADD)):"mult"===u.boostBlending||"multiply"===u.boostBlending?n.blendFunc(n.DST_COLOR,n.ZERO):"darken"===u.boostBlending?(n.blendFunc(n.ONE,n.ONE),n.blendEquation(n.FUNC_MIN)):n.blendFuncSeparate(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA,n.ONE,n.ONE_MINUS_SRC_ALPHA),t.reset(),e.colorData.length>0&&(t.setUniform("hasColor",1),(a=GLVertexBuffer(n,t)).build(e.colorData,"aColor",4),a.bind()),t.setColor(d),A(e.series.xAxis),T(e.series.yAxis),E(x,b),"points"===e.drawMode&&(u.marker&&u.marker.radius?t.setPointSize(2*u.marker.radius):t.setPointSize(1)),t.setSkipTranslation(e.skipTranslation),"bubble"===e.series.type&&t.setBubbleUniforms(e.series,e.zMin,e.zMax),t.setDrawAsCircle(g[e.series.type]||!1),f>0||"line_strip"!==e.drawMode)for(s=0;s<e.segments.length;s++)i.render(e.segments[s].from,e.segments[s].to,e.drawMode);if(e.hasMarkers&&y)for(u.marker&&u.marker.radius?t.setPointSize(2*u.marker.radius):t.setPointSize(10),t.setDrawAsCircle(!0),s=0;s<e.segments.length;s++)i.render(e.segments[s].from,e.segments[s].to,"POINTS")}}),h.debug.timeRendering&&console.timeEnd("gl rendering"),e&&e(),void b()))}return l={allocateBufferForSingleSeries:function(e){var t=0;h.usePreallocated&&(e.isSeriesBoosting&&(t=f(e)),i.allocate(t))},pushSeries:function(e){u.length>0&&u[u.length-1].hasMarkers&&(u[u.length-1].markerTo=a.length),h.debug.timeSeriesProcessing&&console.time("building "+e.type+" series"),u.push({segments:[],markerFrom:a.length,colorData:[],series:e,zMin:Number.MAX_VALUE,zMax:-Number.MAX_VALUE,hasMarkers:!!e.options.marker&&!1!==e.options.marker.enabled,showMarkers:!0,drawMode:{area:"lines",arearange:"lines",areaspline:"line_strip",column:"lines",columnrange:"lines",bar:"lines",line:"line_strip",scatter:"points",heatmap:"triangles",treemap:"triangles",bubble:"points"}[e.type]||"line_strip"}),function(e,t){var n,r,s,a,l,d,u,m,g=e.pointArrayMap&&"low,high"===e.pointArrayMap.join(","),f=e.chart,p=e.options,x=!!p.stacking,b=p.data,A=e.xAxis.getExtremes(),T=A.min,E=A.max,y=e.yAxis.getExtremes(),P=y.min,U=y.max,M=e.xData||p.xData||e.processedXData,S=e.yData||p.yData||e.processedYData,R=e.zData||p.zData||e.processedZData,_=e.yAxis,v=e.xAxis,D=e.chart.plotWidth,k=!M||0===M.length,w=p.connectNulls,L=e.points||!1,N=!1,C=!1,z=x?e.data:M||b,B={x:Number.MAX_VALUE,y:0},X={x:-Number.MAX_VALUE,y:0},G=0,I=!1,O=-1,F=!1,V=!1,W=void 0===f.index,j=!1,Y=!1,q=!1,Z=c[e.type],K=!1,J=!0,Q=!0,$=p.zones||!1,ee=!1,te=p.threshold,ie=!1;if(!(p.boostData&&p.boostData.length>0)){if(p.gapSize&&(ie="value"!==p.gapUnit?p.gapSize*e.closestPointRange:p.gapSize),$&&(some($,function(e){if(void 0===e.value)return ee=new H.Color(e.color),!0}),ee||(ee=e.pointAttribs&&e.pointAttribs().fill||e.color,ee=new H.Color(ee))),f.inverted&&(D=e.chart.plotHeight),e.closestPointRangePx=Number.MAX_VALUE,oe(),L&&L.length>0)return t.skipTranslation=!0,t.drawMode="triangles",L[0].node&&L[0].node.levelDynamic&&L.sort(function(e,t){if(e.node){if(e.node.levelDynamic>t.node.levelDynamic)return 1;if(e.node.levelDynamic<t.node.levelDynamic)return-1}return 0}),L.forEach(function(t){var i,n,o,a=t.plotY;void 0===a||isNaN(a)||null===t.y||(i=t.shapeArgs,n=(o=f.styledMode?t.series.colorAttribs(t):o=t.series.pointAttribs(t))["stroke-width"]||0,(r=H.color(o.fill).rgba)[0]/=255,r[1]/=255,r[2]/=255,"treemap"===e.type&&(n=n||1,(s=H.color(o.stroke).rgba)[0]/=255,s[1]/=255,s[2]/=255,ae(i.x,i.y,i.width,i.height,s),n/=2),"heatmap"===e.type&&f.inverted&&(i.x=v.len-i.x,i.y=_.len-i.y,i.width=-i.width,i.height=-i.height),ae(i.x+n,i.y+n,i.width-2*n,i.height-2*n,r))}),void se();for(;O<z.length-1&&(d=z[++O],!W);)k?(a=d[0],l=d[1],z[O+1]&&(V=z[O+1][0]),z[O-1]&&(F=z[O-1][0]),d.length>=3&&(u=d[2],d[2]>t.zMax&&(t.zMax=d[2]),d[2]<t.zMin&&(t.zMin=d[2]))):(a=d,l=S[O],z[O+1]&&(V=z[O+1]),z[O-1]&&(F=z[O-1]),R&&R.length&&(u=R[O],R[O]>t.zMax&&(t.zMax=R[O]),R[O]<t.zMin&&(t.zMin=R[O]))),w||null!==a&&null!==l?(V&&V>=T&&V<=E&&(j=!0),F&&F>=T&&F<=E&&(Y=!0),g?(k&&(l=d.slice(1,3)),m=l[0],l=l[1]):x&&(a=d.x,m=(l=d.stackY)-d.y),null!=P&&null!=U&&(J=l>=P&&l<=U),a>E&&X.x<E&&(X.x=a,X.y=l),a<T&&B.x>T&&(B.x=a,B.y=l),null===l&&w||(null!==l&&(J||j||Y)?((V>=T||a>=T)&&(F<=E||a<=E)&&(K=!0),(K||j||Y)&&(ie&&a-F>ie&&oe(),$&&(q=ee.rgba,some($,function(e,t){var i=$[t-1];if(void 0!==e.value&&l<=e.value)return(!i||l>=i.value)&&(q=H.color(e.color).rgba),!0}),q[0]/=255,q[1]/=255,q[2]/=255),!h.useGPUTranslations&&(t.skipTranslation=!0,a=v.toPixels(a,!0),l=_.toPixels(l,!0),a>D&&"points"===t.drawMode)||(Z&&(n=m,!1!==m&&void 0!==m||(n=l<0?l:0),g||x||(n=Math.max(null===te?P:te,P)),h.useGPUTranslations||(n=_.toPixels(n,!0)),re(a,n,0,0,q)),t.hasMarkers&&K&&!1!==N&&(e.closestPointRangePx=Math.min(e.closestPointRangePx,Math.abs(a-N))),!h.useGPUTranslations&&!h.usePreallocated&&N&&Math.abs(a-N)<1&&C&&Math.abs(l-C)<1?h.debug.showSkipSummary&&++G:(p.step&&!Q&&re(a,C,0,2,q),re(a,l,0,"bubble"===e.type?u||1:2,q),N=a,C=l,I=!0,Q=!1)))):oe())):oe();h.debug.showSkipSummary&&console.log("skipped points:",G),I||!1===w||"line_strip"!==e.drawMode||(B.x<Number.MAX_VALUE&&le(B,!0),X.x>-Number.MAX_VALUE&&le(X)),se()}function ne(e){e&&(t.colorData.push(e[0]),t.colorData.push(e[1]),t.colorData.push(e[2]),t.colorData.push(e[3]))}function re(e,t,n,r,s){ne(s),h.usePreallocated?i.push(e,t,n?1:0,r||1):(o.push(e),o.push(t),o.push(n?1:0),o.push(r||1))}function se(){t.segments.length&&(t.segments[t.segments.length-1].to=o.length)}function oe(){t.segments.length&&t.segments[t.segments.length-1].from===o.length||(se(),t.segments.push({from:o.length}))}function ae(e,t,i,n,r){ne(r),re(e+i,t),ne(r),re(e,t),ne(r),re(e,t+n),ne(r),re(e,t+n),ne(r),re(e+i,t+n),ne(r),re(e+i,t)}function le(e,i){h.useGPUTranslations||(t.skipTranslation=!0,e.x=v.toPixels(e.x,!0),e.y=_.toPixels(e.y,!0)),i?o=[e.x,e.y,0,2].concat(o):re(e.x,e.y,0,2)}}(e,u[u.length-1]),h.debug.timeSeriesProcessing&&console.timeEnd("building "+e.type+" series")},setSize:function(e,i){r===e&&s===i||!t||(r=e,s=i,t.bind(),t.setPMatrix(p(r,s)))},inited:function(){return d},setThreshold:E,init:function(e,r){var s=0,o=["webgl","experimental-webgl","moz-webgl","webkit-3d"];if(d=!1,!e)return!1;for(h.debug.timeSetup&&console.time("gl setup");s<o.length&&!(n=e.getContext(o[s],{}));s++);if(!n)return!1;if(r||b(),n.enable(n.BLEND),n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA),n.disable(n.DEPTH_TEST),n.depthFunc(n.LESS),!(t=GLShader(n)))return!1;function a(e,t){var i={isReady:!1,texture:doc.createElement("canvas"),handle:n.createTexture()},r=i.texture.getContext("2d");m[e]=i,i.texture.width=512,i.texture.height=512,r.mozImageSmoothingEnabled=!1,r.webkitImageSmoothingEnabled=!1,r.msImageSmoothingEnabled=!1,r.imageSmoothingEnabled=!1,r.strokeStyle="rgba(255, 255, 255, 0)",r.fillStyle="#FFF",t(r);try{n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,i.handle),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,i.texture),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.bindTexture(n.TEXTURE_2D,null),i.isReady=!0}catch(e){}}return i=GLVertexBuffer(n,t),a("circle",function(e){e.beginPath(),e.arc(256,256,256,0,2*Math.PI),e.stroke(),e.fill()}),a("square",function(e){e.fillRect(0,0,512,512)}),a("diamond",function(e){e.beginPath(),e.moveTo(256,0),e.lineTo(512,256),e.lineTo(256,512),e.lineTo(0,256),e.lineTo(256,0),e.fill()}),a("triangle",function(e){e.beginPath(),e.moveTo(0,512),e.lineTo(256,0),e.lineTo(512,512),e.lineTo(0,512),e.fill()}),a("triangle-down",function(e){e.beginPath(),e.moveTo(0,0),e.lineTo(256,512),e.lineTo(512,0),e.lineTo(0,0),e.fill()}),d=!0,h.debug.timeSetup&&console.timeEnd("gl setup"),!0},render:function e(t){if(x(),t.renderer.forExport)return y(t);d?y(t):setTimeout(function(){e(t)},1)},settings:h,valid:function(){return!1!==n},clear:x,flush:b,setXAxis:A,setYAxis:T,data:o,gl:function(){return n},allocateBuffer:function(e){var t=0;h.usePreallocated&&(e.series.forEach(function(e){e.isSeriesBoosting&&(t+=f(e))}),i.allocate(t))},destroy:function(){b(),i.destroy(),t.destroy(),n&&(objEach(m,function(e){m[e].handle&&n.deleteTexture(m[e].handle)}),n.canvas.width=1,n.canvas.height=1)},setOptions:function(e){merge(!0,h,e)}}}export default GLRenderer;