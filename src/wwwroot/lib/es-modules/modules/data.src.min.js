"use strict";import Highcharts from"../parts/Globals.js";import U from"../parts/Utilities.js";var defined=U.defined,extend=U.extend,isNumber=U.isNumber,objectEach=U.objectEach,pick=U.pick,splat=U.splat;import"../parts/Chart.js";import"../mixins/ajax.js";var SeriesBuilder,addEvent=Highcharts.addEvent,Chart=Highcharts.Chart,win=Highcharts.win,doc=win.document,merge=Highcharts.merge,fireEvent=Highcharts.fireEvent,Data=function(e,t,r){this.init(e,t,r)};extend(Data.prototype,{init:function(e,t,r){var i,s=e.decimalPoint;t&&(this.chartOptions=t),r&&(this.chart=r),"."!==s&&","!==s&&(s=void 0),this.options=e,this.columns=e.columns||this.rowsToColumns(e.rows)||[],this.firstRowAsNames=pick(e.firstRowAsNames,this.firstRowAsNames,!0),this.decimalRegex=s&&new RegExp("^(-?[0-9]+)"+s+"([0-9]+)$"),this.rawColumns=[],this.columns.length&&(this.dataFound(),i=!0),this.hasURLOption(e)&&(clearTimeout(this.liveDataTimeout),i=!1),i||(i=this.fetchLiveData()),i||(i=Boolean(this.parseCSV().length)),i||(i=Boolean(this.parseTable().length)),i||(i=this.parseGoogleSpreadsheet()),!i&&e.afterComplete&&e.afterComplete()},hasURLOption:function(e){return Boolean(e&&(e.rowsURL||e.csvURL||e.columnsURL))},getColumnDistribution:function(){var e,t=this.chartOptions,r=this.options,i=[],s=function(e){return(Highcharts.seriesTypes[e||"line"].prototype.pointArrayMap||[0]).length},n=function(e){return Highcharts.seriesTypes[e||"line"].prototype.pointArrayMap},a=t&&t.chart&&t.chart.type,o=[],l=[],u=0,h=r&&r.seriesMapping||t&&t.series&&t.series.map(function(){return{x:0}})||[];(t&&t.series||[]).forEach(function(e){o.push(s(e.type||a))}),h.forEach(function(e){i.push(e.x||0)}),0===i.length&&i.push(0),h.forEach(function(r){var i=new SeriesBuilder,h=o[u]||s(a),d=(t&&t.series||[])[u]||{},c=n(d.type||a),m=c||["y"];for((defined(r.x)||d.isCartesian||!c)&&i.addColumnReader(r.x,"x"),objectEach(r,function(e,t){"x"!==t&&i.addColumnReader(e,t)}),e=0;e<h;e++)i.hasReader(m[e])||i.addColumnReader(void 0,m[e]);l.push(i),u++});var d=n(a);void 0===d&&(d=["y"]),this.valueCount={global:s(a),xColumns:i,individual:o,seriesBuilders:l,globalPointArrayMap:d}},dataFound:function(){this.options.switchRowsAndColumns&&(this.columns=this.rowsToColumns(this.columns)),this.getColumnDistribution(),this.parseTypes(),!1!==this.parsed()&&this.complete()},parseCSV:function(e){var t,r,i,s=this,n=e||this.options,a=n.csv,o=void 0!==n.startRow&&n.startRow?n.startRow:0,l=n.endRow||Number.MAX_VALUE,u=void 0!==n.startColumn&&n.startColumn?n.startColumn:0,h=n.endColumn||Number.MAX_VALUE,d=0,c=[],m={",":0,";":0,"\t":0};function f(e,i,s,n){var a=0,o="",l="",d="",m="",f=0,p=0;function g(t){o=e[t],l=e[t-1],d=e[t+1]}function v(e){c.length<p+1&&c.push([e]),c[p][c[p].length-1]!==e&&c[p].push(e)}function x(){if(u>f||f>h)return++f,void(m="");!isNaN(parseFloat(m))&&isFinite(m)?(m=parseFloat(m),v("number")):isNaN(Date.parse(m))?v("string"):(m=m.replace(/\//g,"-"),v("date")),t.length<p+1&&t.push([]),s||(t[p][i]=m),m="",++p,++f}if(e.trim().length&&"#"!==e.trim()[0]){for(;a<e.length;a++){if(g(a),"#"===o)return void x();if('"'===o)for(g(++a);a<e.length&&('"'!==o||'"'===l||'"'===d);)('"'!==o||'"'===o&&'"'!==l)&&(m+=o),g(++a);else n&&n[o]?n[o](o,m)&&x():o===r?x():m+=o}x()}}if(t=this.columns=[],a&&n.beforeParse&&(a=n.beforeParse.call(this,a)),a){i=a.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split(n.lineDelimiter||"\n"),(!o||o<0)&&(o=0),(!l||l>=i.length)&&(l=i.length-1),n.itemDelimiter?r=n.itemDelimiter:(r=null,r=function(e){var t=0,r=0,i=!1;return e.some(function(e,i){var s,n,a,o=!1,l="";if(i>13)return!0;for(var u=0;u<e.length;u++){if(s=e[u],n=e[u+1],a=e[u-1],"#"===s)return;if('"'===s)if(o){if('"'!==a&&'"'!==n){for(;" "===n&&u<e.length;)n=e[++u];void 0!==m[n]&&m[n]++,o=!1}}else o=!0;else void 0!==m[s]?(l=l.trim(),isNaN(Date.parse(l))&&!isNaN(l)&&isFinite(l)||m[s]++,l=""):l+=s;","===s&&r++,"."===s&&t++}}),i=m[";"]>m[","]?";":(m[","],m[";"],","),n.decimalPoint||(n.decimalPoint=t>r?".":",",s.decimalRegex=new RegExp("^(-?[0-9]+)"+n.decimalPoint+"([0-9]+)$")),i}(i));var p=0;for(d=o;d<=l;d++)"#"===i[d][0]?p++:f(i[d],d-o-p);n.columnTypes&&0!==n.columnTypes.length||!c.length||!c[0].length||"date"!==c[0][1]||n.dateFormat||(n.dateFormat=function(e,t){var r,i,a,o=[],l=0,u=!1,h=[],d=[];for((!t||t>e.length)&&(t=e.length);l<t;l++)if(void 0!==e[l]&&e[l]&&e[l].length)for(r=e[l].trim().replace(/\//g," ").replace(/\-/g," ").replace(/\./g," ").split(" "),o=["","",""],a=0;a<r.length;a++)a<o.length&&(r[a]=parseInt(r[a],10),r[a]&&(d[a]=!d[a]||d[a]<r[a]?r[a]:d[a],void 0!==h[a]?h[a]!==r[a]&&(h[a]=!1):h[a]=r[a],r[a]>31?r[a]<100?o[a]="YY":o[a]="YYYY":r[a]>12&&r[a]<=31?(o[a]="dd",u=!0):o[a].length||(o[a]="mm")));if(u){for(a=0;a<h.length;a++)!1!==h[a]?d[a]>12&&"YY"!==o[a]&&"YYYY"!==o[a]&&(o[a]="YY"):d[a]>12&&"mm"===o[a]&&(o[a]="dd");return 3===o.length&&"dd"===o[1]&&"dd"===o[2]&&(o[2]="YY"),i=o.join("/"),(n.dateFormats||s.dateFormats)[i]?i:(fireEvent("deduceDateFailed"),"YYYY/mm/dd")}return"YYYY/mm/dd"}(t[0])),this.dataFound()}return t},parseTable:function(){var e=this.options,t=e.table,r=this.columns,i=e.startRow||0,s=e.endRow||Number.MAX_VALUE,n=e.startColumn||0,a=e.endColumn||Number.MAX_VALUE;return t&&("string"==typeof t&&(t=doc.getElementById(t)),[].forEach.call(t.getElementsByTagName("tr"),function(e,t){t>=i&&t<=s&&[].forEach.call(e.children,function(e,s){("TD"===e.tagName||"TH"===e.tagName)&&s>=n&&s<=a&&(r[s-n]||(r[s-n]=[]),r[s-n][t-i]=e.innerHTML)})}),this.dataFound()),r},fetchLiveData:function(){var e=this,t=this.chart,r=this.options,i=3,s=0,n=r.enablePolling,a=1e3*(r.dataRefreshRate||2),o=merge(r);if(!this.hasURLOption(r))return!1;return a<1e3&&(a=1e3),delete r.csvURL,delete r.rowsURL,delete r.columnsURL,function l(u){function h(o,h,d){if(!o||0!==o.indexOf("http"))return o&&r.error&&r.error("Invalid URL"),!1;function c(){n&&t.liveDataURL===o&&(e.liveDataTimeout=setTimeout(l,a))}return u&&(clearTimeout(e.liveDataTimeout),t.liveDataURL=o),Highcharts.ajax({url:o,dataType:d||"json",success:function(e){t&&t.series&&h(e),c()},error:function(e,t){return++s<i&&c(),r.error&&r.error(t,e)}}),!0}h(o.csvURL,function(e){t.update({data:{csv:e}})},"text")||h(o.rowsURL,function(e){t.update({data:{rows:e}})})||h(o.columnsURL,function(e){t.update({data:{columns:e}})})}(!0),this.hasURLOption(r)},parseGoogleSpreadsheet:function(){var e=this,t=this.options,r=t.googleSpreadsheetKey,i=this.chart,s=t.googleSpreadsheetWorksheet||1,n=t.startRow||0,a=t.endRow||Number.MAX_VALUE,o=t.startColumn||0,l=t.endColumn||Number.MAX_VALUE,u=1e3*(t.dataRefreshRate||2);return u<4e3&&(u=4e3),r&&(delete t.googleSpreadsheetKey,function e(i){var n=["https://spreadsheets.google.com/feeds/cells",r,s,"public/values?alt=json"].join("/");Highcharts.ajax({url:n,dataType:"json",success:function(r){i(r),t.enablePolling&&setTimeout(function(){e(i)},1e3*(t.dataRefreshRate||2))},error:function(e,r){return t.error&&t.error(r,e)}})}(function(t){var r,s,u,h,d,c,m=[],f=t.feed.entry,p=(f||[]).length,g=0,v=0;if(!f||0===f.length)return!1;for(c=0;c<p;c++)r=f[c],g=Math.max(g,r.gs$cell.col),v=Math.max(v,r.gs$cell.row);for(c=0;c<g;c++)c>=o&&c<=l&&(m[c-o]=[]);for(c=0;c<p;c++)u=(r=f[c]).gs$cell.row-1,(h=r.gs$cell.col-1)>=o&&h<=l&&u>=n&&u<=a&&(s=null,(d=r.gs$cell||r.content).numericValue?s=d.$t.indexOf("/")>=0||d.$t.indexOf("-")>=0?d.$t:d.$t.indexOf("%")>0?100*parseFloat(d.numericValue):parseFloat(d.numericValue):d.$t&&d.$t.length&&(s=d.$t),m[h-o][u-n]=s);m.forEach(function(e){for(c=0;c<e.length;c++)void 0===e[c]&&(e[c]=null)}),i&&i.series?i.update({data:{columns:m}}):(e.columns=m,e.dataFound())})),!1},trim:function(e,t){return"string"==typeof e&&(e=e.replace(/^\s+|\s+$/g,""),t&&/^[0-9\s]+$/.test(e)&&(e=e.replace(/\s/g,"")),this.decimalRegex&&(e=e.replace(this.decimalRegex,"$1.$2"))),e},parseTypes:function(){for(var e=this.columns,t=e.length;t--;)this.parseColumn(e[t],t)},parseColumn:function(e,t){var r,i,s,n,a,o,l,u=this.rawColumns,h=this.columns,d=e.length,c=this.firstRowAsNames,m=-1!==this.valueCount.xColumns.indexOf(t),f=[],p=this.chartOptions,g=(this.options.columnTypes||[])[t],v=m&&(p&&p.xAxis&&"category"===splat(p.xAxis)[0].type||"string"===g);for(u[t]||(u[t]=[]);d--;)r=f[d]||e[d],s=this.trim(r),n=this.trim(r,!0),i=parseFloat(n),void 0===u[t][d]&&(u[t][d]=s),v||0===d&&c?e[d]=""+s:+n===i?(e[d]=i,i>31536e6&&"float"!==g?e.isDatetime=!0:e.isNumeric=!0,void 0!==e[d+1]&&(l=i>e[d+1])):(s&&s.length&&(a=this.parseDate(r)),m&&isNumber(a)&&"float"!==g?(f[d]=r,e[d]=a,e.isDatetime=!0,void 0!==e[d+1]&&((o=a>e[d+1])!==l&&void 0!==l&&(this.alternativeFormat?(this.dateFormat=this.alternativeFormat,d=e.length,this.alternativeFormat=this.dateFormats[this.dateFormat].alternative):e.unsorted=!0),l=o)):(e[d]=""===s?null:s,0!==d&&(e.isDatetime||e.isNumeric)&&(e.mixed=!0)));if(m&&e.mixed&&(h[t]=u[t]),m&&l&&this.options.sort)for(t=0;t<h.length;t++)h[t].reverse(),c&&h[t].unshift(h[t].pop())},dateFormats:{"YYYY/mm/dd":{regex:/^([0-9]{4})[\-\/\.]([0-9]{1,2})[\-\/\.]([0-9]{1,2})$/,parser:function(e){return Date.UTC(+e[1],e[2]-1,+e[3])}},"dd/mm/YYYY":{regex:/^([0-9]{1,2})[\-\/\.]([0-9]{1,2})[\-\/\.]([0-9]{4})$/,parser:function(e){return Date.UTC(+e[3],e[2]-1,+e[1])},alternative:"mm/dd/YYYY"},"mm/dd/YYYY":{regex:/^([0-9]{1,2})[\-\/\.]([0-9]{1,2})[\-\/\.]([0-9]{4})$/,parser:function(e){return Date.UTC(+e[3],e[1]-1,+e[2])}},"dd/mm/YY":{regex:/^([0-9]{1,2})[\-\/\.]([0-9]{1,2})[\-\/\.]([0-9]{2})$/,parser:function(e){var t=+e[3];return t>(new Date).getFullYear()-2e3?t+=1900:t+=2e3,Date.UTC(t,e[2]-1,+e[1])},alternative:"mm/dd/YY"},"mm/dd/YY":{regex:/^([0-9]{1,2})[\-\/\.]([0-9]{1,2})[\-\/\.]([0-9]{2})$/,parser:function(e){return Date.UTC(+e[3]+2e3,e[1]-1,+e[2])}}},parseDate:function(e){var t,r,i,s,n=this.options.parseDate,a=this.options.dateFormat||this.dateFormat;if(n)t=n(e);else if("string"==typeof e){if(a)(i=this.dateFormats[a])||(i=this.dateFormats["YYYY/mm/dd"]),(s=e.match(i.regex))&&(t=i.parser(s));else for(r in this.dateFormats)if(i=this.dateFormats[r],s=e.match(i.regex)){this.dateFormat=a=r,this.alternativeFormat=i.alternative,t=i.parser(s);break}s||("object"==typeof(s=Date.parse(e))&&null!==s&&s.getTime?t=s.getTime()-6e4*s.getTimezoneOffset():isNumber(s)&&(t=s-6e4*new Date(s).getTimezoneOffset()))}return t},rowsToColumns:function(e){var t,r,i,s,n;if(e)for(n=[],r=e.length,t=0;t<r;t++)for(s=e[t].length,i=0;i<s;i++)n[i]||(n[i]=[]),n[i][t]=e[t][i];return n},getData:function(){if(this.columns)return this.rowsToColumns(this.columns).slice(1)},parsed:function(){if(this.options.parsed)return this.options.parsed.call(this,this.columns)},getFreeIndexes:function(e,t){var r,i,s,n=[],a=[];for(i=0;i<e;i+=1)n.push(!0);for(r=0;r<t.length;r+=1)for(s=t[r].getReferencedColumnIndexes(),i=0;i<s.length;i+=1)n[s[i]]=!1;for(i=0;i<n.length;i+=1)n[i]&&a.push(i);return a},complete:function(){var e,t,r,i,s,n,a,o,l,u,h,d,c=this.columns,m=this.options,f=[];if(c.length,m.complete||m.afterComplete){if(this.firstRowAsNames)for(i=0;i<c.length;i++)c[i].name=c[i].shift();for(t=[],u=this.getFreeIndexes(c.length,this.valueCount.seriesBuilders),a=0;a<this.valueCount.seriesBuilders.length;a++)(l=this.valueCount.seriesBuilders[a]).populateColumns(u)&&f.push(l);for(;u.length>0;){for((l=new SeriesBuilder).addColumnReader(0,"x"),-1!==(d=u.indexOf(0))&&u.splice(d,1),i=0;i<this.valueCount.global;i++)l.addColumnReader(void 0,this.valueCount.globalPointArrayMap[i]);l.populateColumns(u)&&f.push(l)}if(f.length>0&&f[0].readers.length>0&&void 0!==(h=c[f[0].readers[0].columnIndex])&&(h.isDatetime?e="datetime":h.isNumeric||(e="category")),"category"===e)for(a=0;a<f.length;a++)for(l=f[a],n=0;n<l.readers.length;n++)"x"===l.readers[n].configName&&(l.readers[n].configName="name");for(a=0;a<f.length;a++){for(l=f[a],r=[],s=0;s<c[0].length;s++)r[s]=l.read(c,s);t[a]={data:r},l.name&&(t[a].name=l.name),"category"===e&&(t[a].turboThreshold=0)}o={series:t},e&&(o.xAxis={type:e},"category"===e&&(o.xAxis.uniqueNames=!1)),m.complete&&m.complete(o),m.afterComplete&&m.afterComplete(o)}},update:function(e,t){var r=this.chart;e&&(e.afterComplete=function(e){e&&(e.xAxis&&r.xAxis[0]&&e.xAxis.type===r.xAxis[0].options.type&&delete e.xAxis,r.update(e,t,!0))},merge(!0,r.options.data,e),this.init(r.options.data))}}),Highcharts.Data=Data,Highcharts.data=function(e,t,r){return new Data(e,t,r)},addEvent(Chart,"init",function(e){var t=this,r=e.args[0]||{},i=e.args[1];r&&r.data&&!t.hasDataDef&&(t.hasDataDef=!0,t.data=new Data(extend(r.data,{afterComplete:function(e){var s,n;if(Object.hasOwnProperty.call(r,"series"))if("object"==typeof r.series)for(s=Math.max(r.series.length,e&&e.series?e.series.length:0);s--;)n=r.series[s]||{},r.series[s]=merge(n,e&&e.series?e.series[s]:{});else delete r.series;r=merge(e,r),t.init(r,i)}}),r,t),e.preventDefault())}),(SeriesBuilder=function(){this.readers=[],this.pointIsArray=!0}).prototype.populateColumns=function(e){var t=!0;return this.readers.forEach(function(t){void 0===t.columnIndex&&(t.columnIndex=e.shift())}),this.readers.forEach(function(e){void 0===e.columnIndex&&(t=!1)}),t},SeriesBuilder.prototype.read=function(e,t){var r,i=this.pointIsArray,s=i?[]:{};return this.readers.forEach(function(r){var n=e[r.columnIndex][t];i?s.push(n):r.configName.indexOf(".")>0?Highcharts.Point.prototype.setNestedProperty(s,n,r.configName):s[r.configName]=n}),void 0===this.name&&this.readers.length>=2&&(r=this.getReferencedColumnIndexes()).length>=2&&(r.shift(),r.sort(function(e,t){return e-t}),this.name=e[r.shift()].name),s},SeriesBuilder.prototype.addColumnReader=function(e,t){this.readers.push({columnIndex:e,configName:t}),"x"!==t&&"y"!==t&&void 0!==t&&(this.pointIsArray=!1)},SeriesBuilder.prototype.getReferencedColumnIndexes=function(){var e,t,r=[];for(e=0;e<this.readers.length;e+=1)void 0!==(t=this.readers[e]).columnIndex&&r.push(t.columnIndex);return r},SeriesBuilder.prototype.hasReader=function(e){var t;for(t=0;t<this.readers.length;t+=1)if(this.readers[t].configName===e)return!0};