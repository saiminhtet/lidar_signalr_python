"use strict";import H from"../../../parts/Globals.js";import U from"../../../parts/Utilities.js";var extend=U.extend,isNumber=U.isNumber,pick=U.pick;import AccessibilityComponent from"../AccessibilityComponent.js";import KeyboardNavigationHandler from"../KeyboardNavigationHandler.js";import A11yUtilities from"../utilities.js";var merge=H.merge,stripHTMLTags=A11yUtilities.stripHTMLTagsFromString;function getPointIndex(e){var i=e.index,t=e.series.points,n=t.length;if(t[i]===e)return i;for(;n--;)if(t[n]===e)return n}function isSkipSeries(e){var i=e.chart.options.accessibility,t=e.options.accessibility||{},n=t.keyboardNavigation;return n&&!1===n.enabled||!1===t.enabled||!1===e.options.enableMouseTracking||!e.visible||i.pointNavigationThreshold&&i.pointNavigationThreshold<=e.points.length}function isSkipPoint(e){var i=e.series.chart.options.accessibility;return e.isNull&&i.keyboardNavigation.skipNullPoints||!1===e.visible||isSkipSeries(e.series)}function getClosestPoint(e,i,t,n){var s,r,o,a=1/0,h=i.points.length;if(void 0!==e.plotX&&void 0!==e.plotY){for(;h--;)void 0!==(s=i.points[h]).plotX&&void 0!==s.plotY&&(o=(e.plotX-s.plotX)*(e.plotX-s.plotX)*(t||1)+(e.plotY-s.plotY)*(e.plotY-s.plotY)*(n||1))<a&&(a=o,r=h);return void 0!==r&&i.points[r]}}H.Series.prototype.keyboardMoveVertical=!0,["column","pie"].forEach(function(e){H.seriesTypes[e]&&(H.seriesTypes[e].prototype.keyboardMoveVertical=!1)}),H.addEvent(H.Series,"render",function(){var e=this.chart,i=this.options,t=e.options.accessibility||{},n=this.points||[],s=n.length,r=this.resetA11yMarkerOptions;if(t.enabled&&!1!==(i.accessibility&&i.accessibility.enabled)&&(s<t.pointDescriptionThreshold||!1===t.pointDescriptionThreshold||s<t.pointNavigationThreshold||!1===t.pointNavigationThreshold)){if(i.marker&&!1===i.marker.enabled&&(this.a11yMarkersForced=!0,merge(!0,this.options,{marker:{enabled:!0,states:{normal:{opacity:0}}}})),this._hasPointMarkers&&this.points&&this.points.length)for(var o,a=s;a--;)(o=n[a].options).marker&&(o.marker.enabled?merge(!0,o.marker,{states:{normal:{opacity:o.marker.states&&o.marker.states.normal&&o.marker.states.normal.opacity||1}}}):merge(!0,o.marker,{enabled:!0,states:{normal:{opacity:0}}}))}else this.a11yMarkersForced&&r&&(delete this.a11yMarkersForced,merge(!0,this.options,{marker:{enabled:r.enabled,states:{normal:{opacity:r.states&&r.states.normal&&r.states.normal.opacity}}}}))}),H.addEvent(H.Series,"afterSetOptions",function(e){this.resetA11yMarkerOptions=merge(e.options.marker||{},this.userOptions.marker||{})}),H.Point.prototype.highlight=function(){var e=this.series.chart;return this.isNull?e.tooltip&&e.tooltip.hide(0):this.onMouseOver(),this.graphic&&e.setFocusToElement(this.graphic),e.highlightedPoint=this,this},H.Chart.prototype.highlightAdjacentPoint=function(e){var i,t,n=this.series,s=this.highlightedPoint,r=s&&getPointIndex(s)||0,o=s&&s.series.points,a=this.series&&this.series[this.series.length-1],h=a&&a.points&&a.points[a.points.length-1];if(!n[0]||!n[0].points)return!1;if(s){if(i=n[s.series.index+(e?1:-1)],!(t=o[r+(e?1:-1)])&&i&&(t=i.points[e?0:i.points.length-1]),!t)return!1}else t=e?n[0].points[0]:h;return isSkipPoint(t)?(isSkipSeries(i=t.series)?this.highlightedPoint=e?i.points[i.points.length-1]:i.points[0]:this.highlightedPoint=t,this.highlightAdjacentPoint(e)):t.highlight()},H.Series.prototype.highlightFirstValidPoint=function(){var e=this.chart.highlightedPoint,i=(e&&e.series)===this?getPointIndex(e):0,t=this.points,n=t.length;if(t&&n){for(var s=i;s<n;++s)if(!isSkipPoint(t[s]))return t[s].highlight();for(var r=i;r>=0;--r)if(!isSkipPoint(t[r]))return t[r].highlight()}return!1},H.Chart.prototype.highlightAdjacentSeries=function(e){var i,t,n=this.highlightedPoint,s=this.series&&this.series[this.series.length-1],r=s&&s.points&&s.points[s.points.length-1];return this.highlightedPoint?!!(i=this.series[n.series.index+(e?-1:1)])&&(!!(t=getClosestPoint(n,i,4))&&(isSkipSeries(i)?(t.highlight(),this.highlightAdjacentSeries(e)||(n.highlight(),!1)):(t.highlight(),t.series.highlightFirstValidPoint()))):(i=e?this.series&&this.series[0]:s,!!(t=e?i&&i.points&&i.points[0]:r)&&t.highlight())},H.Chart.prototype.highlightAdjacentPointVertical=function(e){var i,t=this.highlightedPoint,n=1/0;return void 0!==t.plotX&&void 0!==t.plotY&&(this.series.forEach(function(s){isSkipSeries(s)||s.points.forEach(function(r){if(void 0!==r.plotY&&void 0!==r.plotX&&r!==t){var o=r.plotY-t.plotY,a=Math.abs(r.plotX-t.plotX),h=Math.abs(o)*Math.abs(o)+a*a*4;s.yAxis.reversed&&(o*=-1),o<=0&&e||o>=0&&!e||h<5||isSkipPoint(r)||h<n&&(n=h,i=r)}})}),!!i&&i.highlight())},H.Point.prototype.getA11yTimeDescription=function(){var e=this.series,i=e.chart,t=i.options.accessibility;if(e.xAxis&&e.xAxis.isDatetimeAxis)return i.time.dateFormat(t.pointDateFormatter&&t.pointDateFormatter(this)||t.pointDateFormat||H.Tooltip.prototype.getXDateFormat.call({getDateFormat:H.Tooltip.prototype.getDateFormat,chart:i},this,i.options.tooltip,e.xAxis),this.x)};var SeriesComponent=function(){};SeriesComponent.prototype=new AccessibilityComponent,extend(SeriesComponent.prototype,{init:function(){var e=this;this.addEvent(H.Series,"destroy",function(){var i=this.chart;i===e.chart&&i.highlightedPoint&&i.highlightedPoint.series===this&&(delete i.highlightedPoint,i.focusElement&&i.focusElement.removeFocusBorder())}),this.addEvent(H.Tooltip,"refresh",function(){this.chart===e.chart&&this.label&&this.label.element&&this.label.element.setAttribute("aria-hidden",!0)}),this.addEvent(this.chart,"afterDrawSeriesLabels",function(){this.series.forEach(function(e){e.labelBySeries&&e.labelBySeries.attr("aria-hidden",!0)})}),this.initAnnouncer()},onChartRender:function(){var e=this;this.chart.series.forEach(function(i){e[!1!==(i.options.accessibility&&i.options.accessibility.enabled)&&i.visible?"addSeriesDescription":"hideSeriesFromScreenReader"](i)})},getKeyboardNavigation:function(){var e=this.keyCodes,i=this.chart,t=i.inverted,n=i.options.accessibility,s=function(e){return i.highlightAdjacentPoint(e)?this.response.success:n.keyboardNavigation.wrapAround?this.init(e?1:-1):this.response[e?"next":"prev"]};return new KeyboardNavigationHandler(i,{keyCodeMap:[[[t?e.up:e.left,t?e.down:e.right],function(i){return s.call(this,i===e.right||i===e.down)}],[[t?e.left:e.up,t?e.right:e.down],function(t){var r=t===e.down||t===e.right,o=n.keyboardNavigation;if(o.mode&&"serialize"===o.mode)return s.call(this,r);var a=i.highlightedPoint&&i.highlightedPoint.series.keyboardMoveVertical?"highlightAdjacentPointVertical":"highlightAdjacentSeries";return i[a](r),this.response.success}],[[e.enter,e.space],function(){i.highlightedPoint&&i.highlightedPoint.firePointEvent("click")}]],init:function(e){var t=i.series.length,n=e>0?0:t;if(e>0)for(delete i.highlightedPoint;n<t&&!i.series[n].highlightFirstValidPoint();)++n;else for(;n--&&(i.highlightedPoint=i.series[n].points[i.series[n].points.length-1],!i.series[n].highlightFirstValidPoint()););return this.response.success},terminate:function(){i.tooltip&&i.tooltip.hide(0),delete i.highlightedPoint}})},isPointClickable:function(e){var i=e.series.options||{},t=i.point&&i.point.events;return e&&e.graphic&&e.graphic.element&&(e.hcEvents&&e.hcEvents.click||t&&t.click||e.options&&e.options.events&&e.options.events.click)},initAnnouncer:function(){var e=this.chart,i=e.options.accessibility,t=this;this.lastAnnouncementTime=0,this.dirty={allSeries:{}},this.announceRegion=this.createElement("div"),this.announceRegion.setAttribute("aria-hidden",!1),this.announceRegion.setAttribute("aria-live",i.announceNewData.interruptUser?"assertive":"polite"),merge(!0,this.announceRegion.style,this.hiddenStyle),e.renderTo.insertBefore(this.announceRegion,e.renderTo.firstChild),this.addEvent(this.chart,"afterDrilldown",function(){if(e.highlightedPoint=null,e.options.accessibility.announceNewData.enabled){if(this.series&&this.series.length){var i=t.getSeriesElement(this.series[0]);i.focus&&i.getAttribute("aria-label")?i.focus():this.series[0].highlightFirstValidPoint()}t.lastAnnouncementTime=0,e.focusElement&&e.focusElement.removeFocusBorder()}}),this.addEvent(H.Series,"updatedData",function(){this.chart===e&&this.chart.options.accessibility.announceNewData.enabled&&(t.dirty.hasDirty=!0,t.dirty.allSeries[this.name+this.index]=this)}),this.addEvent(e,"afterAddSeries",function(e){if(this.options.accessibility.announceNewData.enabled){var i=e.series;t.dirty.hasDirty=!0,t.dirty.allSeries[i.name+i.index]=i,t.dirty.newSeries=void 0===t.dirty.newSeries?i:null}}),this.addEvent(H.Series,"addPoint",function(i){this.chart===e&&this.chart.options.accessibility.announceNewData.enabled&&(t.dirty.newPoint=void 0===t.dirty.newPoint?i.point:null)}),this.addEvent(e,"redraw",function(){if(this.options.accessibility.announceNewData&&t.dirty.hasDirty){var e,i=t.dirty.newPoint;i&&(e=i.series.data.filter(function(e){return e.x===i.x&&e.y===i.y}),i=1===e.length?e[0]:i),t.announceNewData(Object.keys(t.dirty.allSeries).map(function(e){return t.dirty.allSeries[e]}),t.dirty.newSeries,i),t.dirty={allSeries:{}}}})},announceNewData:function(e,i,t){var n=this.chart.options.accessibility.announceNewData;if(n.enabled){var s,r=this,o=+new Date,a=o-this.lastAnnouncementTime,h=Math.max(0,n.minAnnounceInterval-a);if(this.queuedAnnouncement){var l=(this.queuedAnnouncement.series||[]).concat(e).reduce(function(e,i){return e[i.name+i.index]=i,e},{});s=Object.keys(l).map(function(e){return l[e]})}else s=[].concat(e);var c=this.buildAnnouncementMessage(s,i,t);c&&(this.queuedAnnouncement&&clearTimeout(this.queuedAnnouncementTimer),this.queuedAnnouncement={time:o,message:c,series:s},r.queuedAnnouncementTimer=setTimeout(function(){r&&r.announceRegion&&(r.lastAnnouncementTime=+new Date,r.announceRegion.innerHTML=r.queuedAnnouncement.message,r.clearAnnouncementContainerTimer&&clearTimeout(r.clearAnnouncementContainerTimer),r.clearAnnouncementContainerTimer=setTimeout(function(){r.announceRegion.innerHTML="",delete r.clearAnnouncementContainerTimer},1e3),delete r.queuedAnnouncement,delete r.queuedAnnouncementTimer)},h))}},buildAnnouncementMessage:function(e,i,t){var n=this.chart,s=n.options.accessibility.announceNewData;if(s.announcementFormatter){var r=s.announcementFormatter(e,i,t);if(!1!==r)return r.length?r:null}var o=H.charts&&H.charts.length>1?"Multiple":"Single",a=i?"newSeriesAnnounce"+o:t?"newPointAnnounce"+o:"newDataAnnounce";return n.langFormat("accessibility.announceNewData."+a,{chartTitle:stripHTMLTags(n.options.title.text||n.langFormat("accessibility.defaultChartTitle",{chart:n})),seriesDesc:i?this.defaultSeriesDescriptionFormatter(i):null,pointDesc:t?this.defaultPointDescriptionFormatter(t):null,point:t,series:i})},reverseChildNodes:function(e){for(var i=e.childNodes.length;i--;)e.appendChild(e.childNodes[i])},getSeriesFirstPointElement:function(e){return e.points&&e.points.length&&e.points[0].graphic&&e.points[0].graphic.element},getSeriesElement:function(e){var i=this.getSeriesFirstPointElement(e);return i&&i.parentNode||e.graph&&e.graph.element||e.group&&e.group.element},hideSeriesFromScreenReader:function(e){var i=this.getSeriesElement(e);i&&i.setAttribute("aria-hidden",!0)},addSeriesDescription:function(e){var i=this,t=e.chart,n=t.options.accessibility,s=e.options.accessibility||{},r=i.getSeriesFirstPointElement(e),o=i.getSeriesElement(e),a=e.points&&(e.points.length<n.pointDescriptionThreshold||!1===n.pointDescriptionThreshold)&&!s.exposeAsGroupOnly,h=e.points&&(e.points.length<n.pointNavigationThreshold||!1===n.pointNavigationThreshold);o&&(o.lastChild===r&&i.reverseChildNodes(o),i.unhideElementFromScreenReaders(o),(a||h)&&e.points.forEach(function(e){var t=e.graphic&&e.graphic.element;t&&(t.setAttribute("tabindex","-1"),a?(t.setAttribute("role","img"),t.setAttribute("aria-label",stripHTMLTags(s.pointDescriptionFormatter&&s.pointDescriptionFormatter(e)||n.pointDescriptionFormatter&&n.pointDescriptionFormatter(e)||i.defaultPointDescriptionFormatter(e)))):t.setAttribute("aria-hidden",!0))}),t.series.length>1||n.describeSingleSeries?(s.exposeAsGroupOnly?o.setAttribute("role","img"):"all"===n.landmarkVerbosity&&o.setAttribute("role","region"),o.setAttribute("tabindex","-1"),o.setAttribute("aria-label",stripHTMLTags(n.seriesDescriptionFormatter&&n.seriesDescriptionFormatter(e)||i.defaultSeriesDescriptionFormatter(e)))):o.setAttribute("aria-label",""))},defaultSeriesDescriptionFormatter:function(e){var i=e.chart,t=(e.options.accessibility||{}).description,n=t&&i.langFormat("accessibility.series.description",{description:t,series:e}),s=i.langFormat("accessibility.series.xAxisDescription",{name:e.xAxis&&e.xAxis.getDescription(),series:e}),r=i.langFormat("accessibility.series.yAxisDescription",{name:e.yAxis&&e.yAxis.getDescription(),series:e}),o={name:e.name||"",ix:e.index+1,numSeries:i.series&&i.series.length,numPoints:e.points&&e.points.length,series:e},a=i.types&&i.types.length>1?"Combination":"";return(i.langFormat("accessibility.series.summary."+e.type+a,o)||i.langFormat("accessibility.series.summary.default"+a,o))+(n?" "+n:"")+(i.yAxis&&i.yAxis.length>1&&this.yAxis?" "+r:"")+(i.xAxis&&i.xAxis.length>1&&this.xAxis?" "+s:"")},defaultPointDescriptionFormatter:function(e){var i=e.series,t=i.chart,n=t.options.accessibility,s=e.series.tooltipOptions||{},r=n.pointValuePrefix||s.valuePrefix||"",o=n.pointValueSuffix||s.valueSuffix||"",a=e.options&&e.options.accessibility&&e.options.accessibility.description,h=e.getA11yTimeDescription(),l=function(e){if(isNumber(e)){var i=H.defaultOptions.lang;return H.numberFormat(e,n.pointValueDecimals||s.valueDecimals||-1,i.decimalPoint,i.accessibility.thousandsSep||i.thousandsSep)}return e},c=pick(i.xAxis&&i.xAxis.options.accessibility&&i.xAxis.options.accessibility.enabled,!t.angular),p=i.xAxis&&i.xAxis.categories&&void 0!==e.category&&""+e.category,d=e.name||h||p&&p.replace("<br/>"," ")||(e.id&&e.id.indexOf("highcharts-")<0?e.id:"x, "+e.x),u=e.series.pointArrayMap?e.series.pointArrayMap.reduce(function(i,t){return i+(i.length?", ":"")+t+": "+r+l(pick(e[t],e.options[t]))+o},""):void 0!==e.value?r+l(e.value)+o:r+l(e.y)+o;return(void 0!==e.index?e.index+1+". ":"")+(c?d+", ":"")+u+"."+(a?" "+a:"")+(t.series.length>1&&i.name?" "+i.name:"")}});export default SeriesComponent;