"use strict";import H from"../../parts/Globals.js";import KeyboardNavigationHandler from"./KeyboardNavigationHandler.js";var merge=H.merge,addEvent=H.addEvent,win=H.win,doc=win.document;function KeyboardNavigation(e,t,i){this.init(e,t,i)}KeyboardNavigation.prototype={init:function(e,t){var i=this;this.chart=e,this.components=t,this.modules=[],this.currentModuleIx=0,e.container.hasAttribute("tabIndex")||e.container.setAttribute("tabindex","0"),this.addExitAnchor(),this.unbindKeydownHandler=addEvent(e.renderTo,"keydown",function(e){i.onKeydown(e)}),this.unbindMouseUpHandler=addEvent(doc,"mouseup",function(){i.onMouseUp()}),this.update(),this.modules.length&&this.modules[0].init(1)},update:function(e){var t=this.chart.options.accessibility,i=t&&t.keyboardNavigation,n=this.components;i&&i.enabled&&e&&e.length?this.modules=e.reduce(function(e,t){var i=n[t].getKeyboardNavigation();return i.length?e.concat(i):(e.push(i),e)},[new KeyboardNavigationHandler(this.chart,{})]):(this.modules=[],this.currentModuleIx=0)},onMouseUp:function(){if(!(this.keyboardReset||this.chart.pointer&&this.chart.pointer.chartPosition)){var e=this.chart,t=this.modules&&this.modules[this.currentModuleIx||0];t&&t.terminate&&t.terminate(),e.focusElement&&e.focusElement.removeFocusBorder(),this.currentModuleIx=0,this.keyboardReset=!0}},onKeydown:function(e){var t,i=e||win.event,n=this.modules&&this.modules.length&&this.modules[this.currentModuleIx];if(this.keyboardReset=!1,n){var r=n.run(i);r===n.response.success?t=!0:r===n.response.prev?t=this.prev():r===n.response.next&&(t=this.next()),t&&i.preventDefault()}},prev:function(){return this.move(-1)},next:function(){return this.move(1)},move:function(e){var t=this.modules&&this.modules[this.currentModuleIx];t&&t.terminate&&t.terminate(e),this.chart.focusElement&&this.chart.focusElement.removeFocusBorder(),this.currentModuleIx+=e;var i=this.modules&&this.modules[this.currentModuleIx];if(i){if(i.validate&&!i.validate())return this.move(e);if(i.init)return i.init(e),!0}return this.currentModuleIx=0,e>0?(this.exiting=!0,this.exitAnchor.focus()):this.chart.renderTo.focus(),!1},addExitAnchor:function(){var e=this.chart,t=this.exitAnchorWrapper=doc.createElement("div"),i=this.exitAnchor=doc.createElement("h6"),n=this,r=e.langFormat("accessibility.svgContainerEnd",{chart:e});i.innerHTML=r,t.setAttribute("aria-hidden","false"),t.setAttribute("class","highcharts-exit-anchor-wrapper"),t.style.position="relative",t.style.outline="none",i.setAttribute("tabindex","0"),i.setAttribute("aria-hidden",!1),merge(!0,i.style,{position:"absolute",width:"1px",height:"1px",bottom:"5px",zIndex:0,overflow:"hidden",outline:"none"}),t.appendChild(i),e.renderTo.appendChild(t),this.unbindExitAnchorUpdate=addEvent(e,"render",function(){this.renderTo.appendChild(t)}),this.unbindExitAnchorFocus=addEvent(i,"focus",function(t){var i,r=t||win.event;n.exiting?n.exiting=!1:(e.renderTo.focus(),r.preventDefault(),n.modules&&n.modules.length&&(n.currentModuleIx=n.modules.length-1,(i=n.modules[n.currentModuleIx])&&i.validate&&!i.validate()?n.prev():i&&i.init(-1)))})},destroy:function(){this.unbindExitAnchorFocus&&(this.unbindExitAnchorFocus(),delete this.unbindExitAnchorFocus),this.unbindExitAnchorUpdate&&(this.unbindExitAnchorUpdate(),delete this.unbindExitAnchorUpdate),this.exitAnchorWrapper&&this.exitAnchorWrapper.parentNode&&(this.exitAnchorWrapper.parentNode.removeChild(this.exitAnchorWrapper),delete this.exitAnchor,delete this.exitAnchorWrapper),this.unbindKeydownHandler&&this.unbindKeydownHandler(),this.unbindMouseUpHandler&&this.unbindMouseUpHandler()}};export default KeyboardNavigation;