"use strict";import H from"../parts/Globals.js";import U from"../parts/Utilities.js";var defined=U.defined,isArray=U.isArray,isObject=U.isObject,isString=U.isString,objectEach=U.objectEach,pick=U.pick,addEvent=H.addEvent,createElement=H.createElement,wrap=H.wrap,indexFilter=/\d/g,PREFIX="highcharts-",DIV="div",INPUT="input",LABEL="label",BUTTON="button",SELECT="select",OPTION="option",SPAN="span",UL="ul",LI="li",H3="h3";wrap(H.Pointer.prototype,"onContainerMouseDown",function(t,e){var a=e.target&&e.target.className;isString(a)&&a.indexOf(PREFIX+"popup-field")>=0||t.apply(this,Array.prototype.slice.call(arguments,1))}),H.Popup=function(t,e){this.init(t,e)},H.Popup.prototype={init:function(t,e){this.container=createElement(DIV,{className:PREFIX+"popup"},null,t),this.lang=this.getLangpack(),this.iconsURL=e,this.addCloseBtn()},addCloseBtn:function(){var t,e=this;(t=createElement(DIV,{className:PREFIX+"popup-close"},null,this.container)).style["background-image"]="url("+this.iconsURL+"close.svg)",["click","touchstart"].forEach(function(a){addEvent(t,a,function(){e.closePopup()})})},addColsContainer:function(t){var e,a;return a=createElement(DIV,{className:PREFIX+"popup-lhs-col"},null,t),e=createElement(DIV,{className:PREFIX+"popup-rhs-col"},null,t),createElement(DIV,{className:PREFIX+"popup-rhs-col-wrapper"},null,e),{lhsCol:a,rhsCol:e}},addInput:function(t,e,a,n){var i=t.split("."),o=i[i.length-1],s=this.lang,l=PREFIX+e+"-"+o;l.match(indexFilter)||createElement(LABEL,{innerHTML:s[o]||o,htmlFor:l},null,a),createElement(INPUT,{name:l,value:n[0],type:n[1],className:PREFIX+"popup-field"},null,a).setAttribute(PREFIX+"data-name",t)},addButton:function(t,e,a,n,i){var o,s=this,l=this.closePopup,r=this.getFields;return o=createElement(BUTTON,{innerHTML:e},null,t),["click","touchstart"].forEach(function(t){addEvent(o,t,function(){return l.call(s),n(r(i,a))})}),o},getFields:function(t,e){var a,n,i=t.querySelectorAll("input"),o="#"+PREFIX+"select-series > option:checked",s="#"+PREFIX+"select-volume > option:checked",l=t.querySelectorAll(o)[0],r=t.querySelectorAll(s)[0];return n={actionType:e,linkedTo:l&&l.getAttribute("value"),fields:{}},[].forEach.call(i,function(t){a=t.getAttribute(PREFIX+"data-name"),t.getAttribute(PREFIX+"data-series-id")?n.seriesId=t.value:a?n.fields[a]=t.value:n.type=t.value}),r&&(n.fields["params.volumeSeriesID"]=r.getAttribute("value")),n},showPopup:function(){var t=this.container,e=PREFIX+"annotation-toolbar",a=t.querySelectorAll("."+PREFIX+"popup-close")[0];t.innerHTML="",t.className.indexOf(e)>=0&&(t.classList.remove(e),t.removeAttribute("style")),t.appendChild(a),t.style.display="block"},closePopup:function(){this.popup.container.style.display="none"},showForm:function(t,e,a,n){this.popup=e.navigationBindings.popup,this.showPopup(),"indicators"===t&&this.indicators.addForm.call(this,e,a,n),"annotation-toolbar"===t&&this.annotations.addToolbar.call(this,e,a,n),"annotation-edit"===t&&this.annotations.addForm.call(this,e,a,n),"flag"===t&&this.annotations.addForm.call(this,e,a,n,!0)},getLangpack:function(){return H.getOptions().lang.navigation.popup},annotations:{addToolbar:function(t,e,a){var n,i=this,o=this.lang,s=this.popup.container,l=this.showForm,r=PREFIX+"annotation-toolbar";-1===s.className.indexOf(r)&&(s.className+=" "+r),s.style.top=t.plotTop+10+"px",createElement(SPAN,{innerHTML:pick(o[e.langKey]||e.langKey,e.shapes&&e.shapes[0].type)},null,s),(n=this.addButton(s,o.removeButton||"remove","remove",a,s)).className+=" "+PREFIX+"annotation-remove-button",n.style["background-image"]="url("+this.iconsURL+"destroy.svg)",(n=this.addButton(s,o.editButton||"edit","edit",function(){l.call(i,"annotation-edit",t,e,a)},s)).className+=" "+PREFIX+"annotation-edit-button",n.style["background-image"]="url("+this.iconsURL+"edit.svg)"},addForm:function(t,e,a,n){var i,o,s=this.popup.container,l=this.lang;createElement("h2",{innerHTML:l[e.langKey]||e.langKey,className:PREFIX+"popup-main-title"},null,s),o=createElement(DIV,{className:PREFIX+"popup-lhs-col "+PREFIX+"popup-lhs-full"},null,s),i=createElement(DIV,{className:PREFIX+"popup-bottom-row"},null,s),this.annotations.addFormFields.call(this,o,t,"",e,[],!0),this.addButton(i,n?l.addButton||"add":l.saveButton||"save",n?"add":"save",a,s)},addFormFields:function(t,e,a,n,i,o){var s,l,r=this,c=this.annotations.addFormFields,p=this.addInput,d=this.lang;objectEach(n,function(n,o){s=""!==a?a+"."+o:o,isObject(n)&&(!isArray(n)||isArray(n)&&isObject(n[0])?((l=d[o]||o).match(indexFilter)||i.push([!0,l,t]),c.call(r,t,e,s,n,i,!1)):i.push([r,s,"annotation",t,n]))}),o&&(i=i.sort(function(t){return t[1].match(/format/g)?-1:1})).forEach(function(t){!0===t[0]?createElement(SPAN,{className:PREFIX+"annotation-title",innerHTML:t[1]},null,t[2]):p.apply(t[0],t.splice(1))})}},indicators:{addForm:function(t,e,a){var n,i,o=this.indicators,s=this.lang;this.tabs.init.call(this,t),n=this.popup.container.querySelectorAll("."+PREFIX+"tab-item-content"),this.addColsContainer(n[0]),o.addIndicatorList.call(this,t,n[0],"add"),i=n[0].querySelectorAll("."+PREFIX+"popup-rhs-col")[0],this.addButton(i,s.addButton||"add","add",a,i),this.addColsContainer(n[1]),o.addIndicatorList.call(this,t,n[1],"edit"),i=n[1].querySelectorAll("."+PREFIX+"popup-rhs-col")[0],this.addButton(i,s.saveButton||"save","edit",a,i),this.addButton(i,s.removeButton||"remove","remove",a,i)},addIndicatorList:function(t,e,a){var n,i,o,s=this,l=e.querySelectorAll("."+PREFIX+"popup-lhs-col")[0],r=e.querySelectorAll("."+PREFIX+"popup-rhs-col")[0],c="edit"===a,p=c?t.series:t.options.plotOptions,d=this.indicators.addFormFields;i=createElement(UL,{className:PREFIX+"indicator-list"},null,l),n=r.querySelectorAll("."+PREFIX+"popup-rhs-col-wrapper")[0],objectEach(p,function(e,a){var l=e.options;if(e.params||l&&l.params){var r=s.indicators.getNameType(e,a),u=r.type;o=createElement(LI,{className:PREFIX+"indicator-list",innerHTML:r.name},null,i),["click","touchstart"].forEach(function(a){addEvent(o,a,function(){d.call(s,t,c?e:p[u],r.type,n),c&&e.options&&createElement(INPUT,{type:"hidden",name:PREFIX+"id-"+u,value:e.options.id},null,n).setAttribute(PREFIX+"data-series-id",e.options.id)})})}}),i.childNodes.length>0&&i.childNodes[0].click()},getNameType:function(t,e){var a=t.options,n=H.seriesTypes,i=n[e]&&n[e].prototype.nameBase||e.toUpperCase(),o=e;return a&&a.type&&(o=t.options.type,i=t.name),{name:i,type:o}},listAllSeries:function(t,e,a,n,i){var o,s,l=PREFIX+e+"-type-"+t,r=this.lang;createElement(LABEL,{innerHTML:r[e]||e,htmlFor:l},null,n),(o=createElement(SELECT,{name:l,className:PREFIX+"popup-field"},null,n)).setAttribute("id",PREFIX+"select-"+e),a.series.forEach(function(t){!(s=t.options).params&&s.id&&s.id!==PREFIX+"navigator-series"&&createElement(OPTION,{innerHTML:s.name||s.id,value:s.id},null,o)}),defined(i)&&(o.value=i)},addFormFields:function(t,e,a,n){var i=e.params||e.options.params,o=this.indicators.getNameType;n.innerHTML="",createElement(H3,{className:PREFIX+"indicator-title",innerHTML:o(e,a).name},null,n),createElement(INPUT,{type:"hidden",name:PREFIX+"type-"+a,value:a},null,n),this.indicators.listAllSeries.call(this,a,"series",t,n,e.linkedParent&&i.volumeSeriesID),i.volumeSeriesID&&this.indicators.listAllSeries.call(this,a,"volume",t,n,e.linkedParent&&e.linkedParent.options.id),this.indicators.addParamInputs.call(this,t,"params",i,a,n)},addParamInputs:function(t,e,a,n,i){var o,s=this,l=this.indicators.addParamInputs,r=this.addInput;objectEach(a,function(a,c){o=e+"."+c,isObject(a)?l.call(s,t,o,a,n,i):"params.volumeSeriesID"!==o&&r.call(s,o,n,i,[a,"text"])})},getAmount:function(){var t=this.series,e=0;return objectEach(t,function(t){var a=t.options;(t.params||a&&a.params)&&e++}),e}},tabs:{init:function(t){var e,a=this.tabs,n=this.indicators.getAmount.call(t);e=a.addMenuItem.call(this,"add"),a.addMenuItem.call(this,"edit",n),a.addContentItem.call(this,"add"),a.addContentItem.call(this,"edit"),a.switchTabs.call(this,n),a.selectTab.call(this,e,0)},addMenuItem:function(t,e){var a,n=this.popup.container,i=PREFIX+"tab-item",o=this.lang;return 0===e&&(i+=" "+PREFIX+"tab-disabled"),(a=createElement(SPAN,{innerHTML:o[t+"Button"]||t,className:i},null,n)).setAttribute(PREFIX+"data-tab-type",t),a},addContentItem:function(){var t=this.popup.container;return createElement(DIV,{className:PREFIX+"tab-item-content"},null,t)},switchTabs:function(t){var e=this;this.popup.container.querySelectorAll("."+PREFIX+"tab-item").forEach(function(a,n){"edit"===a.getAttribute(PREFIX+"data-tab-type")&&0===t||["click","touchstart"].forEach(function(t){addEvent(a,t,function(){e.tabs.deselectAll.call(e),e.tabs.selectTab.call(e,this,n)})})})},selectTab:function(t,e){var a=this.popup.container.querySelectorAll("."+PREFIX+"tab-item-content");t.className+=" "+PREFIX+"tab-item-active",a[e].className+=" "+PREFIX+"tab-item-show"},deselectAll:function(){var t,e=this.popup.container,a=e.querySelectorAll("."+PREFIX+"tab-item"),n=e.querySelectorAll("."+PREFIX+"tab-item-content");for(t=0;t<a.length;t++)a[t].classList.remove(PREFIX+"tab-item-active"),n[t].classList.remove(PREFIX+"tab-item-show")}}},addEvent(H.NavigationBindings,"showPopup",function(t){this.popup||(this.popup=new H.Popup(this.chart.container,this.chart.options.navigation.iconsURL||this.chart.options.stockTools&&this.chart.options.stockTools.gui.iconsURL||"https://code.highcharts.com/7.2.2/gfx/stock-icons/")),this.popup.showForm(t.formType,this.chart,t.options,t.onSubmit)}),addEvent(H.NavigationBindings,"closePopup",function(){this.popup&&this.popup.closePopup()});