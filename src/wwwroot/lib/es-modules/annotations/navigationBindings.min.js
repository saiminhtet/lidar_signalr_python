"use strict";import H from"../parts/Globals.js";import U from"../parts/Utilities.js";var attr=U.attr,extend=U.extend,isArray=U.isArray,isNumber=U.isNumber,isObject=U.isObject,objectEach=U.objectEach,pick=U.pick;import chartNavigationMixin from"../mixins/navigation.js";var doc=H.doc,win=H.win,addEvent=H.addEvent,merge=H.merge,fireEvent=H.fireEvent,PREFIX="highcharts-";function closestPolyfill(t,n){var i=win.Element.prototype,e=i.matches||i.msMatchesSelector||i.webkitMatchesSelector,o=null;if(i.closest)o=i.closest.call(t,n);else do{if(e.call(t,n))return t;t=t.parentElement||t.parentNode}while(null!==t&&1===t.nodeType);return o}var bindingsUtils={updateRectSize:function(t,n){var i=n.chart,e=n.options.typeOptions,o=i.pointer.getCoordinates(t),s=o.xAxis[0].value-e.point.x,a=e.point.y-o.yAxis[0].value;n.update({typeOptions:{background:{width:i.inverted?a:s,height:i.inverted?s:a}}})},getFieldType:function(t){return{string:"text",number:"number",boolean:"checkbox"}[typeof t]}};function selectableAnnotation(t){var n=t.prototype.defaultOptions.events&&t.prototype.defaultOptions.events.click;H.merge(!0,t.prototype.defaultOptions.events,{click:function(t){var i=this,e=i.chart.navigationBindings,o=e.activeAnnotation;n&&n.click.call(i,t),o!==i?(e.deselectAnnotation(),e.activeAnnotation=i,i.setControlPointsVisibility(!0),fireEvent(e,"showPopup",{annotation:i,formType:"annotation-toolbar",options:e.annotationToFields(i),onSubmit:function(t){var n,o={};"remove"===t.actionType?(e.activeAnnotation=!1,e.chart.removeAnnotation(i)):(e.fieldsToOptions(t.fields,o),e.deselectAnnotation(),n=o.typeOptions,"measure"===i.options.type&&(n.crosshairY.enabled=0!==n.crosshairY.strokeWidth,n.crosshairX.enabled=0!==n.crosshairX.strokeWidth),i.update(o))}})):(e.deselectAnnotation(),fireEvent(e,"closePopup")),t.activeAnnotation=!0}})}H.NavigationBindings=function(t,n){this.chart=t,this.options=n,this.eventsToUnbind=[],this.container=doc.getElementsByClassName(this.options.bindingsClassName)},H.NavigationBindings.annotationsEditable={nestedOptions:{labelOptions:["style","format","backgroundColor"],labels:["style"],label:["style"],style:["fontSize","color"],background:["fill","strokeWidth","stroke"],innerBackground:["fill","strokeWidth","stroke"],outerBackground:["fill","strokeWidth","stroke"],shapeOptions:["fill","strokeWidth","stroke"],shapes:["fill","strokeWidth","stroke"],line:["strokeWidth","stroke"],backgroundColors:[!0],connector:["fill","strokeWidth","stroke"],crosshairX:["strokeWidth","stroke"],crosshairY:["strokeWidth","stroke"]},circle:["shapes"],verticalLine:[],label:["labelOptions"],measure:["background","crosshairY","crosshairX"],fibonacci:[],tunnel:["background","line","height"],pitchfork:["innerBackground","outerBackground"],rect:["shapes"],crookedLine:[]},H.NavigationBindings.annotationsNonEditable={rectangle:["crosshairX","crosshairY","label"]},extend(H.NavigationBindings.prototype,{initEvents:function(){var t=this,n=t.chart,i=t.container,e=t.options;t.boundClassNames={},objectEach(e.bindings,function(n){t.boundClassNames[n.className]=n}),[].forEach.call(i,function(n){t.eventsToUnbind.push(addEvent(n,"click",function(n){var e=t.getButtonEvents(i,n);e&&t.bindingsButtonClick(e.button,e.events,n)}))}),objectEach(e.events||{},function(n,i){H.isFunction(n)&&t.eventsToUnbind.push(addEvent(t,i,n))}),t.eventsToUnbind.push(addEvent(n.container,"click",function(i){!n.cancelClick&&n.isInsidePlot(i.chartX-n.plotLeft,i.chartY-n.plotTop)&&t.bindingsChartClick(this,i)})),t.eventsToUnbind.push(addEvent(n.container,"mousemove",function(n){t.bindingsContainerMouseMove(this,n)}))},initUpdate:function(){var t=this;chartNavigationMixin.addUpdate(function(n){t.update(n)},this.chart)},bindingsButtonClick:function(t,n,i){var e=this.chart;this.selectedButtonElement&&(fireEvent(this,"deselectButton",{button:this.selectedButtonElement}),this.nextEvent&&(this.currentUserDetails&&"annotations"===this.currentUserDetails.coll&&e.removeAnnotation(this.currentUserDetails),this.mouseMoveEvent=this.nextEvent=!1)),this.selectedButton=n,this.selectedButtonElement=t,fireEvent(this,"selectButton",{button:t}),n.init&&n.init.call(this,t,i),(n.start||n.steps)&&e.renderer.boxWrapper.addClass(PREFIX+"draw-mode")},bindingsChartClick:function(t,n){var i=this.chart,e=this.selectedButton,o=i.renderer.boxWrapper;this.activeAnnotation&&!n.activeAnnotation&&n.target.parentNode&&!closestPolyfill(n.target,"."+PREFIX+"popup")&&(fireEvent(this,"closePopup"),this.deselectAnnotation()),e&&e.start&&(this.nextEvent?(this.nextEvent(n,this.currentUserDetails),this.steps&&(this.stepIndex++,e.steps[this.stepIndex]?this.mouseMoveEvent=this.nextEvent=e.steps[this.stepIndex]:(fireEvent(this,"deselectButton",{button:this.selectedButtonElement}),o.removeClass(PREFIX+"draw-mode"),e.end&&e.end.call(this,n,this.currentUserDetails),this.nextEvent=!1,this.mouseMoveEvent=!1,this.selectedButton=null))):(this.currentUserDetails=e.start.call(this,n),e.steps?(this.stepIndex=0,this.steps=!0,this.mouseMoveEvent=this.nextEvent=e.steps[this.stepIndex]):(fireEvent(this,"deselectButton",{button:this.selectedButtonElement}),o.removeClass(PREFIX+"draw-mode"),this.steps=!1,this.selectedButton=null,e.end&&e.end.call(this,n,this.currentUserDetails))))},bindingsContainerMouseMove:function(t,n){this.mouseMoveEvent&&this.mouseMoveEvent(n,this.currentUserDetails)},fieldsToOptions:function(t,n){return objectEach(t,function(t,i){var e=parseFloat(t),o=i.split("."),s=n,a=o.length-1;!isNumber(e)||t.match(/px/g)||i.match(/format/g)||(t=e),""!==t&&"undefined"!==t&&o.forEach(function(n,i){var e=pick(o[i+1],"");a===i?s[n]=t:s[n]?s=s[n]:(s[n]=e.match(/\d/g)?[]:{},s=s[n])})}),n},deselectAnnotation:function(){this.activeAnnotation&&(this.activeAnnotation.setControlPointsVisibility(!1),this.activeAnnotation=!1)},annotationToFields:function(t){var n=t.options,i=H.NavigationBindings.annotationsEditable,e=i.nestedOptions,o=this.utils.getFieldType,s=pick(n.type,n.shapes&&n.shapes[0]&&n.shapes[0].type,n.labels&&n.labels[0]&&n.labels[0].itemType,"label"),a=H.NavigationBindings.annotationsNonEditable[n.langKey]||[],r={langKey:n.langKey,type:s};function c(n,i,s,r){var l;s&&-1===a.indexOf(i)&&((s.indexOf&&s.indexOf(i))>=0||s[i]||!0===s)&&(isArray(n)?(r[i]=[],n.forEach(function(t,n){isObject(t)?(r[i][n]={},objectEach(t,function(t,o){c(t,o,e[i],r[i][n])})):c(t,0,e[i],r[i])})):isObject(n)?(l={},isArray(r)?(r.push(l),l[i]={},l=l[i]):r[i]=l,objectEach(n,function(t,n){c(t,n,0===i?s:e[i],l)})):"format"===i?r[i]=[H.format(n,t.labels[0].points[0]).toString(),"text"]:isArray(r)?r.push([n,o(n)]):r[i]=[n,o(n)])}return objectEach(n,function(t,o){"typeOptions"===o?(r[o]={},objectEach(n[o],function(t,n){c(t,n,e,r[o])})):c(t,o,i[s],r)}),r},getClickedClassNames:function(t,n){for(var i,e=n.target,o=[];e;)if((i=attr(e,"class"))&&(o=o.concat(i.split(" ").map(function(t){return[t,e]}))),(e=e.parentNode)===t)return o;return o},getButtonEvents:function(t,n){var i,e=this;return this.getClickedClassNames(t,n).forEach(function(t){e.boundClassNames[t[0]]&&!i&&(i={events:e.boundClassNames[t[0]],button:t[1]})}),i},update:function(t){this.options=merge(!0,this.options,t),this.removeEvents(),this.initEvents()},removeEvents:function(){this.eventsToUnbind.forEach(function(t){t()})},destroy:function(){this.removeEvents()},utils:bindingsUtils}),H.Chart.prototype.initNavigationBindings=function(){var t=this.options;t&&t.navigation&&t.navigation.bindings&&(this.navigationBindings=new H.NavigationBindings(this,t.navigation),this.navigationBindings.initEvents(),this.navigationBindings.initUpdate())},addEvent(H.Chart,"load",function(){this.initNavigationBindings()}),addEvent(H.Chart,"destroy",function(){this.navigationBindings&&this.navigationBindings.destroy()}),addEvent(H.NavigationBindings,"deselectButton",function(){this.selectedButtonElement=null}),addEvent(H.Annotation,"remove",function(){this.chart.navigationBindings&&this.chart.navigationBindings.deselectAnnotation()}),H.Annotation&&(selectableAnnotation(H.Annotation),objectEach(H.Annotation.types,function(t){selectableAnnotation(t)})),H.setOptions({lang:{navigation:{popup:{simpleShapes:"Simple shapes",lines:"Lines",circle:"Circle",rectangle:"Rectangle",label:"Label",shapeOptions:"Shape options",typeOptions:"Details",fill:"Fill",format:"Text",strokeWidth:"Line width",stroke:"Line color",title:"Title",name:"Name",labelOptions:"Label options",labels:"Labels",backgroundColor:"Background color",backgroundColors:"Background colors",borderColor:"Border color",borderRadius:"Border radius",borderWidth:"Border width",style:"Style",padding:"Padding",fontSize:"Font size",color:"Color",height:"Height",shapes:"Shape options"}}},navigation:{bindingsClassName:"highcharts-bindings-container",bindings:{circleAnnotation:{className:"highcharts-circle-annotation",start:function(t){var n=this.chart.pointer.getCoordinates(t),i=this.chart.options.navigation,e=[{positioner:function(t){var n=H.Annotation.MockPoint.pointToPixels(t.points[0]),i=t.options.r;return{x:n.x+i*Math.cos(Math.PI/4)-this.graphic.width/2,y:n.y+i*Math.sin(Math.PI/4)-this.graphic.height/2}},events:{drag:function(t,n){var i=n.annotation,e=this.mouseMoveToTranslation(t);n.setRadius(Math.max(n.options.r+e.y/Math.sin(Math.PI/4),5)),i.options.shapes[0]=i.userOptions.shapes[0]=n.options,n.redraw(!1)}}}];return this.chart.addAnnotation(merge({langKey:"circle",shapes:[{type:"circle",point:{xAxis:0,yAxis:0,x:n.xAxis[0].value,y:n.yAxis[0].value},r:5,controlPoints:e}]},i.annotationsOptions,i.bindings.circleAnnotation.annotationsOptions))},steps:[function(t,n){var i=n.options.shapes[0].point,e=this.chart.xAxis[0].toPixels(i.x),o=this.chart.yAxis[0].toPixels(i.y),s=this.chart.inverted,a=Math.max(Math.sqrt(Math.pow(s?o-t.chartX:e-t.chartX,2)+Math.pow(s?e-t.chartY:o-t.chartY,2)),5);n.update({shapes:[{r:a}]})}]},rectangleAnnotation:{className:"highcharts-rectangle-annotation",start:function(t){var n=this.chart.pointer.getCoordinates(t),i=this.chart.options.navigation,e=n.xAxis[0].value,o=n.yAxis[0].value,s=[{positioner:function(t){var n=H.Annotation.MockPoint.pointToPixels(t.shapes[0].points[2]);return{x:n.x-4,y:n.y-4}},events:{drag:function(t,n){var i=this.chart.pointer.getCoordinates(t),e=i.xAxis[0].value,o=i.yAxis[0].value,s=n.options.shapes[0].points;s[1].x=e,s[2].x=e,s[2].y=o,s[3].y=o,n.options.shapes[0].points=s,n.redraw(!1)}}}];return this.chart.addAnnotation(merge({langKey:"rectangle",shapes:[{type:"path",points:[{xAxis:0,yAxis:0,x:e,y:o},{xAxis:0,yAxis:0,x:e,y:o},{xAxis:0,yAxis:0,x:e,y:o},{xAxis:0,yAxis:0,x:e,y:o}]}],controlPoints:s},i.annotationsOptions,i.bindings.rectangleAnnotation.annotationsOptions))},steps:[function(t,n){var i=n.options.shapes[0].points,e=this.chart.pointer.getCoordinates(t),o=e.xAxis[0].value,s=e.yAxis[0].value;i[1].x=o,i[2].x=o,i[2].y=s,i[3].y=s,n.update({shapes:[{points:i}]})}]},labelAnnotation:{className:"highcharts-label-annotation",start:function(t){var n=this.chart.pointer.getCoordinates(t),i=this.chart.options.navigation,e=[{symbol:"triangle-down",positioner:function(t){if(!t.graphic.placed)return{x:0,y:-9e7};var n=H.Annotation.MockPoint.pointToPixels(t.points[0]);return{x:n.x-this.graphic.width/2,y:n.y-this.graphic.height/2}},events:{drag:function(t,n){var i=this.mouseMoveToTranslation(t);n.translatePoint(i.x,i.y),n.annotation.labels[0].options=n.options,n.redraw(!1)}}},{symbol:"square",positioner:function(t){return t.graphic.placed?{x:t.graphic.alignAttr.x-this.graphic.width/2,y:t.graphic.alignAttr.y-this.graphic.height/2}:{x:0,y:-9e7}},events:{drag:function(t,n){var i=this.mouseMoveToTranslation(t);n.translate(i.x,i.y),n.annotation.labels[0].options=n.options,n.redraw(!1)}}}];return this.chart.addAnnotation(merge({langKey:"label",labelOptions:{format:"{y:.2f}"},labels:[{point:{xAxis:0,yAxis:0,x:n.xAxis[0].value,y:n.yAxis[0].value},overflow:"none",crop:!0,controlPoints:e}]},i.annotationsOptions,i.bindings.labelAnnotation.annotationsOptions))}}},events:{},annotationsOptions:{}}});