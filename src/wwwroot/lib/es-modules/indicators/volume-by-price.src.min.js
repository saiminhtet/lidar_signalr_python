"use strict";import H from"../parts/Globals.js";import U from"../parts/Utilities.js";var arrayMax=U.arrayMax,arrayMin=U.arrayMin,extend=U.extend,isArray=U.isArray;function arrayExtremesOHLC(e){for(var t,o=e.length,s=e[0][3],a=s,i=1;i<o;i++)(t=e[i][3])<s&&(s=t),t>a&&(a=t);return{min:s,max:a}}var abs=Math.abs,noop=H.noop,addEvent=H.addEvent,correctFloat=H.correctFloat,seriesType=H.seriesType,columnPrototype=H.seriesTypes.column.prototype;seriesType("vbp","sma",{params:{ranges:12,volumeSeriesID:"volume"},zoneLines:{enabled:!0,styles:{color:"#0A9AC9",dashStyle:"LongDash",lineWidth:1}},volumeDivision:{enabled:!0,styles:{positiveColor:"rgba(144, 237, 125, 0.8)",negativeColor:"rgba(244, 91, 91, 0.8)"}},animationLimit:1e3,enableMouseTracking:!1,pointPadding:0,zIndex:-1,crisp:!0,dataGrouping:{enabled:!1},dataLabels:{allowOverlap:!0,enabled:!0,format:"P: {point.volumePos:.2f} | N: {point.volumeNeg:.2f}",padding:0,style:{fontSize:"7px"},verticalAlign:"top"}},{nameBase:"Volume by Price",bindTo:{series:!1,eventName:"afterSetExtremes"},calculateOn:"render",markerAttribs:noop,drawGraph:noop,getColumnMetrics:columnPrototype.getColumnMetrics,crispCol:columnPrototype.crispCol,init:function(e){var t,o,s;return H.seriesTypes.sma.prototype.init.apply(this,arguments),t=this.options.params,o=this.linkedParent,s=e.get(t.volumeSeriesID),this.addCustomEvents(o,s),this},addCustomEvents:function(e,t){var o=this;function s(){o.chart.redraw(),o.setData([]),o.zoneStarts=[],o.zoneLinesSVG&&(o.zoneLinesSVG.destroy(),delete o.zoneLinesSVG)}return o.dataEventsToUnbind.push(addEvent(e,"remove",function(){s()})),t&&o.dataEventsToUnbind.push(addEvent(t,"remove",function(){s()})),o},animate:function(e){var t=this,o={};H.svg&&!e&&(o.translateX=t.yAxis.pos,t.group.animate(o,extend(H.animObject(t.options.animation),{step:function(e,o){t.group.attr({scaleX:Math.max(.001,o.pos)})}})),t.animate=null)},drawPoints:function(){this.options.volumeDivision.enabled&&(this.posNegVolume(!0,!0),columnPrototype.drawPoints.apply(this,arguments),this.posNegVolume(!1,!1)),columnPrototype.drawPoints.apply(this,arguments)},posNegVolume:function(e,t){var o,s,a,i,n=t?["positive","negative"]:["negative","positive"],r=this.options.volumeDivision,l=this.points.length,p=[],h=[],u=0;for(e?(this.posWidths=p,this.negWidths=h):(p=this.posWidths,h=this.negWidths);u<l;u++)(i=this.points[u])[n[0]+"Graphic"]=i.graphic,i.graphic=i[n[1]+"Graphic"],e&&(o=i.shapeArgs.width,(a=(s=this.priceZones[u]).wholeVolumeData)?(p.push(o/a*s.positiveVolumeData),h.push(o/a*s.negativeVolumeData)):(p.push(0),h.push(0))),i.color=t?r.styles.positiveColor:r.styles.negativeColor,i.shapeArgs.width=t?this.posWidths[u]:this.negWidths[u],i.shapeArgs.x=t?i.shapeArgs.x:this.posWidths[u]},translate:function(){var e,t,o,s,a,i,n,r,l,p,h,u,d=this,c=d.options,m=d.chart,v=d.yAxis,g=v.min,y=d.options.zoneLines,f=d.priceZones,D=0;columnPrototype.translate.apply(d),(e=d.points).length&&(l=c.pointPadding<.5?c.pointPadding:.1,t=d.volumeDataArray,o=arrayMax(t),s=m.plotWidth/2,p=m.plotTop,a=abs(v.toPixels(g)-v.toPixels(g+d.rangeStep)),n=abs(v.toPixels(g)-v.toPixels(g+d.rangeStep)),l&&(i=abs(a*(1-2*l)),D=abs((a-i)/2),a=abs(i)),e.forEach(function(e,t){h=e.barX=e.plotX=0,u=e.plotY=v.toPixels(f[t].start)-p-(v.reversed?a-n:a)-D,r=correctFloat(s*f[t].wholeVolumeData/o),e.pointWidth=r,e.shapeArgs=d.crispCol.apply(d,[h,u,r,a]),e.volumeNeg=f[t].negativeVolumeData,e.volumePos=f[t].positiveVolumeData,e.volumeAll=f[t].wholeVolumeData}),y.enabled&&d.drawZones(m,v,d.zoneStarts,y.styles))},getValues:function(e,t){var o,s,a=e.processedXData,i=e.processedYData,n=this.chart,r=t.ranges,l=[],p=[],h=[];return e.chart?(s=n.get(t.volumeSeriesID))?(o=isArray(i[0]))&&4!==i[0].length?H.error("Type of "+e.name+" series is different than line, OHLC or candlestick.",!0,n):((this.priceZones=this.specifyZones(o,a,i,r,s)).forEach(function(e,t){l.push([e.x,e.end]),p.push(l[t][0]),h.push(l[t][1])}),{values:l,xData:p,yData:h}):H.error("Series "+t.volumeSeriesID+" not found! Check `volumeSeriesID`.",!0,n):H.error("Base series not found! In case it has been removed, add a new one.",!0,n)},specifyZones:function(e,t,o,s,a){var i,n,r=!!e&&arrayExtremesOHLC(o),l=r?r.min:arrayMin(o),p=r?r.max:arrayMax(o),h=this.zoneStarts=[],u=[],d=0,c=1;if(!l||!p)return this.points.length&&(this.setData([]),this.zoneStarts=[],this.zoneLinesSVG.destroy()),[];for(i=this.rangeStep=correctFloat(p-l)/s,h.push(l);d<s-1;d++)h.push(correctFloat(h[d]+i));for(h.push(p),n=h.length;c<n;c++)u.push({index:c-1,x:t[0],start:h[c-1],end:h[c]});return this.volumePerZone(e,u,a,t,o)},volumePerZone:function(e,t,o,s,a){var i,n,r,l,p,h=this,u=o.processedXData,d=o.processedYData,c=t.length-1,m=a.length,v=d.length;return abs(m-v)&&(s[0]!==u[0]&&d.unshift(0),s[m-1]!==u[v-1]&&d.push(0)),h.volumeDataArray=[],t.forEach(function(t){for(t.wholeVolumeData=0,t.positiveVolumeData=0,t.negativeVolumeData=0,p=0;p<m;p++)n=!1,r=!1,l=e?a[p][3]:a[p],i=p?e?a[p-1][3]:a[p-1]:l,l<=t.start&&0===t.index&&(n=!0),l>=t.end&&t.index===c&&(r=!0),(l>t.start||n)&&(l<t.end||r)&&(t.wholeVolumeData+=d[p],i>l?t.negativeVolumeData+=d[p]:t.positiveVolumeData+=d[p]);h.volumeDataArray.push(t.wholeVolumeData)}),t},drawZones:function(e,t,o,s){var a,i=e.renderer,n=this.zoneLinesSVG,r=[],l=e.plotWidth,p=e.plotTop;o.forEach(function(o){a=t.toPixels(o)-p,r=r.concat(e.renderer.crispLine(["M",0,a,"L",l,a],s.lineWidth))}),n?n.animate({d:r}):n=this.zoneLinesSVG=i.path(r).attr({"stroke-width":s.lineWidth,stroke:s.color,dashstyle:s.dashStyle,zIndex:this.group.zIndex+.1}).add(this.group)}},{destroy:function(){return this.negativeGraphic&&(this.negativeGraphic=this.negativeGraphic.destroy()),H.Point.prototype.destroy.apply(this,arguments)}});