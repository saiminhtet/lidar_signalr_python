"use strict";import H from"../parts/Globals.js";import U from"../parts/Utilities.js";var UNDEFINED,defined=U.defined,isArray=U.isArray,objectEach=U.objectEach,seriesType=H.seriesType,merge=H.merge,color=H.color,SMA=H.seriesTypes.sma;function maxHigh(o){return o.reduce(function(o,n){return Math.max(o,n[1])},-1/0)}function minLow(o){return o.reduce(function(o,n){return Math.min(o,n[2])},1/0)}function highlowLevel(o){return{high:maxHigh(o),low:minLow(o)}}function getClosestPointRange(o){var n,t,e,i,p;return o.series.forEach(function(o){if(o.xData)for(i=o.xData,t=o.xIncrement?1:i.length-1,p=t;p>0;p--)e=i[p]-i[p-1],(n===UNDEFINED||e<n)&&(n=e)}),n}function checkLineIntersection(o,n,t,e){if(o&&n&&t&&e){var i,p,a=n.plotX-o.plotX,l=n.plotY-o.plotY,r=e.plotX-t.plotX,s=e.plotY-t.plotY,h=o.plotX-t.plotX,c=o.plotY-t.plotY;if(p=(r*c-s*h)/(-r*l+a*s),(i=(-l*h+a*c)/(-r*l+a*s))>=0&&i<=1&&p>=0&&p<=1)return{plotX:o.plotX+p*a,plotY:o.plotY+p*l}}return!1}function drawSenkouSpan(o){var n=o.indicator;n.points=o.points,n.nextPoints=o.nextPoints,n.color=o.color,n.options=merge(o.options.senkouSpan.styles,o.gap),n.graph=o.graph,n.fillGraph=!0,SMA.prototype.drawGraph.call(n)}H.approximations["ichimoku-averages"]=function(){var o,n=[];return[].forEach.call(arguments,function(t,e){n.push(H.approximations.average(t)),o=!o&&void 0===n[e]}),o?void 0:n},seriesType("ikh","sma",{params:{period:26,periodTenkan:9,periodSenkouSpanB:52},marker:{enabled:!1},tooltip:{pointFormat:'<span style="color:{point.color}">‚óè</span> <b> {series.name}</b><br/>TENKAN SEN: {point.tenkanSen:.3f}<br/>KIJUN SEN: {point.kijunSen:.3f}<br/>CHIKOU SPAN: {point.chikouSpan:.3f}<br/>SENKOU SPAN A: {point.senkouSpanA:.3f}<br/>SENKOU SPAN B: {point.senkouSpanB:.3f}<br/>'},tenkanLine:{styles:{lineWidth:1,lineColor:void 0}},kijunLine:{styles:{lineWidth:1,lineColor:void 0}},chikouLine:{styles:{lineWidth:1,lineColor:void 0}},senkouSpanA:{styles:{lineWidth:1,lineColor:void 0}},senkouSpanB:{styles:{lineWidth:1,lineColor:void 0}},senkouSpan:{styles:{fill:"rgba(255, 0, 0, 0.5)"}},dataGrouping:{approximation:"ichimoku-averages"}},{pointArrayMap:["tenkanSen","kijunSen","chikouSpan","senkouSpanA","senkouSpanB"],pointValKey:"tenkanSen",nameComponents:["periodSenkouSpanB","period","periodTenkan"],init:function(){SMA.prototype.init.apply(this,arguments),this.options=merge({tenkanLine:{styles:{lineColor:this.color}},kijunLine:{styles:{lineColor:this.color}},chikouLine:{styles:{lineColor:this.color}},senkouSpanA:{styles:{lineColor:this.color,fill:color(this.color).setOpacity(.5).get()}},senkouSpanB:{styles:{lineColor:this.color,fill:color(this.color).setOpacity(.5).get()}},senkouSpan:{styles:{fill:color(this.color).setOpacity(.2).get()}}},this.options)},toYData:function(o){return[o.tenkanSen,o.kijunSen,o.chikouSpan,o.senkouSpanA,o.senkouSpanB]},translate:function(){var o=this;SMA.prototype.translate.apply(o),o.points.forEach(function(n){o.pointArrayMap.forEach(function(t){defined(n[t])&&(n["plot"+t]=o.yAxis.toPixels(n[t],!0),n.plotY=n["plot"+t],n.tooltipPos=[n.plotX,n["plot"+t]],n.isNull=!1)})})},drawGraph:function(){var o,n,t,e,i,p,a,l,r,s,h,c,u,g=this,S=g.points,k=S.length,f=g.options,d=g.graph,y=g.color,A={options:{gapSize:f.gapSize}},E=g.pointArrayMap.length,N=[[],[],[],[],[],[]],m={tenkanLine:N[0],kijunLine:N[1],chikouLine:N[2],senkouSpanA:N[3],senkouSpanB:N[4],senkouSpan:N[5]},v=[],D=g.options.senkouSpan,x=D.color||D.styles.fill,C=D.negativeColor,Y=[[],[]],P=[[],[]],L=0;for(g.ikhMap=m;k--;){for(n=S[k],t=0;t<E;t++)o=g.pointArrayMap[t],defined(n[o])&&N[t].push({plotX:n.plotX,plotY:n["plot"+o],isNull:!1});if(C&&k!==S.length-1){var B=m.senkouSpanB.length-1,M=checkLineIntersection(m.senkouSpanA[B-1],m.senkouSpanA[B],m.senkouSpanB[B-1],m.senkouSpanB[B]),U={plotX:M.plotX,plotY:M.plotY,isNull:!1,intersectPoint:!0};M&&(m.senkouSpanA.splice(B,0,U),m.senkouSpanB.splice(B,0,U),v.push(B))}}if(objectEach(m,function(o,n){f[n]&&"senkouSpan"!==n&&(g.points=N[L],g.options=merge(f[n].styles,A),g.graph=g["graph"+n],g.fillGraph=!1,g.color=y,SMA.prototype.drawGraph.call(g),g["graph"+n]=g.graph),L++}),g.graphCollection&&g.graphCollection.forEach(function(o){g[o].destroy(),delete g[o]}),g.graphCollection=[],C&&m.senkouSpanA[0]&&m.senkouSpanB[0]){for(v.unshift(0),v.push(m.senkouSpanA.length-1),c=0;c<v.length-1;c++)if(e=v[c],i=v[c+1],p=m.senkouSpanB.slice(e,i+1),a=m.senkouSpanA.slice(e,i+1),Math.floor(p.length/2)>=1){var w=Math.floor(p.length/2);if(p[w].plotY===a[w].plotY){for(l=0,r=0,u=0;u<p.length;u++)l+=p[u].plotY,r+=a[u].plotY;Y[h=l>r?0:1]=Y[h].concat(p),P[h]=P[h].concat(a)}else h=p[w].plotY>a[w].plotY?0:1,Y[h]=Y[h].concat(p),P[h]=P[h].concat(a)}else h=p[0].plotY>a[0].plotY?0:1,Y[h]=Y[h].concat(p),P[h]=P[h].concat(a);["graphsenkouSpanColor","graphsenkouSpanNegativeColor"].forEach(function(o,n){Y[n].length&&P[n].length&&(s=0===n?x:C,drawSenkouSpan({indicator:g,points:Y[n],nextPoints:P[n],color:s,options:f,gap:A,graph:g[o]}),g[o]=g.graph,g.graphCollection.push(o))})}else drawSenkouSpan({indicator:g,points:m.senkouSpanB,nextPoints:m.senkouSpanA,color:x,options:f,gap:A,graph:g.graphsenkouSpan}),g.graphsenkouSpan=g.graph;delete g.nextPoints,delete g.fillGraph,g.points=S,g.options=f,g.graph=d},getGraphPath:function(o){var n,t=[],e=[],i=[];if(o=o||this.points,this.fillGraph&&this.nextPoints){(n=SMA.prototype.getGraphPath.call(this,this.nextPoints))[0]="L",t=SMA.prototype.getGraphPath.call(this,o);for(var p=(i=n.slice(0,t.length)).length-1;p>0;p-=3)e.push(i[p-2],i[p-1],i[p]);t=t.concat(e)}else t=SMA.prototype.getGraphPath.apply(this,arguments);return t},getValues:function(o,n){var t,e,i,p,a,l,r,s,h,c,u,g=n.period,S=n.periodTenkan,k=n.periodSenkouSpanB,f=o.xData,d=o.yData,y=o.xAxis,A=d&&d.length||0,E=getClosestPointRange(y),N=[],m=[];if(f.length<=g||!isArray(d[0])||4!==d[0].length)return!1;for(t=f[0]-g*E,l=0;l<g;l++)m.push(t+l*E);for(l=0;l<A;l++)l>=S&&(r=((i=highlowLevel(d.slice(l-S,l))).high+i.low)/2),l>=g&&(c=(r+(s=((p=highlowLevel(d.slice(l-g,l))).high+p.low)/2))/2),l>=k&&(u=((a=highlowLevel(d.slice(l-k,l))).high+a.low)/2),h=d[l][3],e=f[l],N[l]===UNDEFINED&&(N[l]=[]),N[l+g]===UNDEFINED&&(N[l+g]=[]),N[l+g][0]=r,N[l+g][1]=s,N[l+g][2]=UNDEFINED,N[l][2]=h,l<=g&&(N[l+g][3]=UNDEFINED,N[l+g][4]=UNDEFINED),N[l+2*g]===UNDEFINED&&(N[l+2*g]=[]),N[l+2*g][3]=c,N[l+2*g][4]=u,m.push(e);for(l=1;l<=g;l++)m.push(e+l*E);return{values:N,xData:m,yData:N}}});