"use strict";import H from"../parts/Globals.js";import U from"../parts/Utilities.js";var defined=U.defined,extend=U.extend,isNumber=U.isNumber,isString=U.isString,pick=U.pick;import"./GridAxis.js";import Tree from"./Tree.js";import mixinTreeSeries from"../mixins/tree-series.js";import"../modules/broken-axis.src.js";var addEvent=H.addEvent,argsToArray=function(e){return Array.prototype.slice.call(e,1)},find=H.find,fireEvent=H.fireEvent,getLevelOptions=mixinTreeSeries.getLevelOptions,merge=H.merge,isBoolean=function(e){return"boolean"==typeof e},isObject=function(e){return U.isObject(e,!0)},wrap=H.wrap,GridAxis=H.Axis,GridAxisTick=H.Tick,override=function(e,t){var i,o;for(i in t)Object.hasOwnProperty.call(t,i)&&(o=t[i],wrap(e,i,o))},getBreakFromNode=function(e,t){var i=e.collapseStart,o=e.collapseEnd;return o>=t&&(i-=.5),{from:i,to:o,showPoints:!1}},getTickPositions=function(e){return Object.keys(e.mapOfPosToGridNode).reduce(function(t,i){var o=+i;return e.min<=o&&e.max>=o&&!e.isInAnyBreak(o)&&t.push(o),t},[])},isCollapsed=function(e,t){var i=e.options.breaks||[],o=getBreakFromNode(t,e.max);return i.some(function(e){return e.from===o.from&&e.to===o.to})},collapse=function(e,t){var i=e.options.breaks||[],o=getBreakFromNode(t,e.max);return i.push(o),i},expand=function(e,t){var i=e.options.breaks||[],o=getBreakFromNode(t,e.max);return i.reduce(function(e,t){return t.to===o.to&&t.from===o.from||e.push(t),e},[])},toggleCollapse=function(e,t){return isCollapsed(e,t)?expand(e,t):collapse(e,t)},renderLabelIcon=function(e,t){var i=e.labelIcon,o=!i,r=t.renderer,s=t.xy,n=t.options,a=n.width,d=n.height,l={x:s.x-a/2-n.padding,y:s.y-d/2},c=t.collapsed?90:180,p=t.show&&isNumber(l.y);o&&(e.labelIcon=i=r.path(r.symbols[n.type](n.x,n.y,a,d)).addClass("highcharts-label-icon").add(t.group)),p||i.attr({y:-9999}),r.styledMode||i.attr({"stroke-width":1,fill:pick(t.color,"#666666")}).css({cursor:"pointer",stroke:n.lineColor,strokeWidth:n.lineWidth}),i[o?"attr":"animate"]({translateX:l.x,translateY:l.y,rotation:c})},onTickHover=function(e){e.addClass("highcharts-treegrid-node-active"),e.renderer.styledMode||e.css({textDecoration:"underline"})},onTickHoverExit=function(e,t){var i=defined(t.style)?t.style:{};e.removeClass("highcharts-treegrid-node-active"),e.renderer.styledMode||e.css({textDecoration:i.textDecoration})},getTreeGridFromData=function(e,t,i){var o,r,s,n=[],a=[],d={},l={},c=-1,p=!!isBoolean(t)&&t;return r={after:function(e){var t=l[e.pos],i=0,o=0;t.children.forEach(function(e){o+=e.descendants+1,i=Math.max(e.height+1,i)}),t.descendants=o,t.height=i,t.collapsed&&a.push(t)},before:function(e){var t,i,o=isObject(e.data)?e.data:{},r=isString(o.name)?o.name:"",s=d[e.parent],a=isObject(s)?l[s.pos]:null;p&&isObject(a)&&(t=find(a.children,function(e){return e.name===r}))?(i=t.pos,t.nodes.push(e)):i=c++,l[i]||(l[i]=t={depth:a?a.depth+1:0,name:r,nodes:[e],children:[],pos:i},-1!==i&&n.push(r),isObject(a)&&a.children.push(t)),isString(e.id)&&(d[e.id]=e),!0===o.collapsed&&(t.collapsed=!0),e.pos=i}},s=function(e,t){var i=function(e,o,r){var s=e.nodes,n=o+(-1===o?0:t-1),a=(n-o)/2,d=o+a;return s.forEach(function(e){var t=e.data;isObject(t)&&(t.y=o+t.seriesIndex,delete t.seriesIndex),e.pos=d}),r[d]=e,e.pos=d,e.tickmarkOffset=a+.5,e.collapseStart=n+.5,e.children.forEach(function(e){i(e,n+1,r),n=e.collapseEnd-.5}),e.collapseEnd=n+.5,r};return i(e[-1],-1,{})},o=Tree.getTree(e,r),l=s(l,i),{categories:n,mapOfIdToNode:d,mapOfPosToGridNode:l,collapsedNodes:a,tree:o}},onBeforeRender=function(e){e.target.axes.filter(function(e){return"treegrid"===e.options.type}).forEach(function(t){var i,o,r,s=t.options||{},n=s.labels,a=s.uniqueNames,d=0;(!t.mapOfPosToGridNode||t.series.some(function(e){return!e.hasRendered||e.isDirtyData||e.isDirty}))&&(o=t.series.reduce(function(e,t){return t.visible&&(t.options.data.forEach(function(t){isObject(t)&&(t.seriesIndex=d,e.push(t))}),!0===a&&d++),e},[]),r=getTreeGridFromData(o,a,!0===a?d:1),t.categories=r.categories,t.mapOfPosToGridNode=r.mapOfPosToGridNode,t.hasNames=!0,t.tree=r.tree,t.series.forEach(function(e){var t=e.options.data.map(function(e){return isObject(e)?merge(e):e});e.visible&&e.setData(t,!1)}),t.mapOptionsToLevel=getLevelOptions({defaults:n,from:1,levels:n.levels,to:t.tree.height}),"beforeRender"===e.type&&(i=H.addEvent(t,"foundExtremes",function(){r.collapsedNodes.forEach(function(e){var i=collapse(t,e);t.setBreaks(i,!1)}),i()})))})};override(GridAxis.prototype,{init:function(e,t,i){var o="treegrid"===i.type;o&&(addEvent(t,"beforeRender",onBeforeRender),addEvent(t,"beforeRedraw",onBeforeRender),i=merge({grid:{enabled:!0},labels:{align:"left",levels:[{level:void 0},{level:1,style:{fontWeight:"bold"}}],symbol:{type:"triangle",x:-5,y:-5,height:10,width:10,padding:5}},uniqueNames:!1},i,{reversed:!0,grid:{columns:void 0}})),e.apply(this,[t,i]),o&&(this.hasNames=!0,this.options.showLastLabel=!0)},getMaxLabelDimensions:function(e){var t,i=this.options,o=i&&i.labels,r=o&&isNumber(o.indentation)?i.labels.indentation:0,s=e.apply(this,argsToArray(arguments));return"treegrid"===this.options.type&&this.mapOfPosToGridNode&&(t=this.mapOfPosToGridNode[-1].height,s.width+=r*(t-1)),s},generateTick:function(e,t){var i,o,r,s=isObject(this.mapOptionsToLevel)?this.mapOptionsToLevel:{},n="treegrid"===this.options.type,a=this.ticks,d=a[t];n?((i=s[(r=this.mapOfPosToGridNode[t]).depth])&&(o={labels:i}),d?(d.parameters.category=r.name,d.options=o,d.addLabel()):a[t]=d=new GridAxisTick(this,t,null,void 0,{category:r.name,tickmarkOffset:r.tickmarkOffset,options:o})):e.apply(this,argsToArray(arguments))},setTickInterval:function(e){var t=this.options;"treegrid"===t.type?(this.min=pick(this.userMin,t.min,this.dataMin),this.max=pick(this.userMax,t.max,this.dataMax),fireEvent(this,"foundExtremes"),this.setAxisTranslation(!0),this.tickmarkOffset=.5,this.tickInterval=1,this.tickPositions=this.mapOfPosToGridNode?getTickPositions(this):[]):e.apply(this,argsToArray(arguments))}}),override(GridAxisTick.prototype,{getLabelPosition:function(e,t,i,o,r,s,n,a,d){var l,c,p,h,f,u=pick(this.options&&this.options.labels,s),m=this.pos,g=this.axis,v="treegrid"===g.options.type,y=e.apply(this,[t,i,o,r,u,n,a,d]);return v&&(l=u&&isObject(u.symbol)?u.symbol:{},c=u&&isNumber(u.indentation)?u.indentation:0,f=(h=(p=g.mapOfPosToGridNode)&&p[m])&&h.depth||1,y.x+=l.width+2*l.padding+(f-1)*c),y},renderLabel:function(e){var t,i,o,r=this,s=r.pos,n=r.axis,a=r.label,d=n.mapOfPosToGridNode,l=n.options,c=pick(r.options&&r.options.labels,l&&l.labels),p=c&&isObject(c.symbol)?c.symbol:{},h=d&&d[s],f=h&&h.depth,u="treegrid"===l.type,m=!(!a||!a.element),g=n.tickPositions.indexOf(s)>-1,v=n.chart.styledMode;u&&h&&m&&a.addClass("highcharts-treegrid-node-level-"+f),e.apply(r,argsToArray(arguments)),u&&h&&m&&h.descendants>0&&(t=isCollapsed(n,h),renderLabelIcon(r,{color:!v&&a.styles.color,collapsed:t,group:a.parentGroup,options:p,renderer:a.renderer,show:g,xy:a.xy}),i="highcharts-treegrid-node-"+(t?"collapsed":"expanded"),o="highcharts-treegrid-node-"+(t?"expanded":"collapsed"),a.addClass(i).removeClass(o),v||a.css({cursor:"pointer"}),[a,r.labelIcon].forEach(function(e){e.attachedTreeGridEvents||(H.addEvent(e.element,"mouseover",function(){onTickHover(a)}),H.addEvent(e.element,"mouseout",function(){onTickHoverExit(a,c)}),H.addEvent(e.element,"click",function(){r.toggleCollapse()}),e.attachedTreeGridEvents=!0)}))}}),extend(GridAxisTick.prototype,{collapse:function(e){var t=this.axis,i=this.pos,o=t.mapOfPosToGridNode[i],r=collapse(t,o);t.setBreaks(r,pick(e,!0))},expand:function(e){var t=this.axis,i=this.pos,o=t.mapOfPosToGridNode[i],r=expand(t,o);t.setBreaks(r,pick(e,!0))},toggleCollapse:function(e){var t=this.axis,i=this.pos,o=t.mapOfPosToGridNode[i],r=toggleCollapse(t,o);t.setBreaks(r,pick(e,!0))}}),GridAxis.prototype.utils={getNode:Tree.getNode};