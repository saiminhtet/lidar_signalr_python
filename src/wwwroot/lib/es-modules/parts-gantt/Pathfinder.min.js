"use strict";import H from"../parts/Globals.js";import"../parts/Point.js";import U from"../parts/Utilities.js";var defined=U.defined,extend=U.extend,objectEach=U.objectEach,pick=U.pick,splat=U.splat;import pathfinderAlgorithms from"./PathfinderAlgorithms.js";import"./ArrowSymbols.js";var deg2rad=H.deg2rad,addEvent=H.addEvent,merge=H.merge,max=Math.max,min=Math.min;function getPointBB(t){var i,n=t.shapeArgs;return n?{xMin:n.x,xMax:n.x+n.width,yMin:n.y,yMax:n.y+n.height}:(i=t.graphic&&t.graphic.getBBox())?{xMin:t.plotX-i.width/2,xMax:t.plotX+i.width/2,yMin:t.plotY-i.height/2,yMax:t.plotY+i.height/2}:null}function calculateObstacleMargin(t){for(var i,n,e=t.length,r=0,o=[],a=function(t,i,n){var e=pick(n,10),r=t.yMax+e>i.yMin-e&&t.yMin-e<i.yMax+e,o=t.xMax+e>i.xMin-e&&t.xMin-e<i.xMax+e,s=r?t.xMin>i.xMax?t.xMin-i.xMax:i.xMin-t.xMax:1/0,h=o?t.yMin>i.yMax?t.yMin-i.yMax:i.yMin-t.yMax:1/0;return o&&r?e?a(t,i,Math.floor(e/2)):1/0:min(s,h)};r<e;++r)for(i=r+1;i<e;++i)(n=a(t[r],t[i]))<80&&o.push(n);return o.push(80),max(Math.floor(o.sort(function(t,i){return t-i})[Math.floor(o.length/10)]/2-1),1)}function Connection(t,i,n){this.init(t,i,n)}function Pathfinder(t){this.init(t)}function warnLegacy(t){(t.options.pathfinder||t.series.reduce(function(t,i){return i.options&&merge(!0,i.options.connectors=i.options.connectors||{},i.options.pathfinder),t||i.options&&i.options.pathfinder},!1))&&(merge(!0,t.options.connectors=t.options.connectors||{},t.options.pathfinder),H.error('WARNING: Pathfinder options have been renamed. Use "chart.connectors" or "series.connectors" instead.'))}extend(H.defaultOptions,{connectors:{type:"straight",lineWidth:1,marker:{enabled:!1,align:"center",verticalAlign:"middle",inside:!1,lineWidth:1},startMarker:{symbol:"diamond"},endMarker:{symbol:"arrow-filled"}}}),Connection.prototype={init:function(t,i,n){this.fromPoint=t,this.toPoint=i,this.options=n,this.chart=t.series.chart,this.pathfinder=this.chart.pathfinder},renderPath:function(t,i,n){var e,r=this.chart,o=r.styledMode,a=r.pathfinder,s=!r.options.chart.forExport&&!1!==n,h=this.graphics&&this.graphics.path;a.group||(a.group=r.renderer.g().addClass("highcharts-pathfinder-group").attr({zIndex:-1}).add(r.seriesGroup)),a.group.translate(r.plotLeft,r.plotTop),h&&h.renderer||(h=r.renderer.path().add(a.group),o||h.attr({opacity:0})),h.attr(i),e={d:t},o||(e.opacity=1),h[s?"animate":"attr"](e,n),this.graphics=this.graphics||{},this.graphics.path=h},addMarker:function(t,i,n){var e,r,o,a,s,h,c,d=this.fromPoint.series.chart,l=d.pathfinder,p=d.renderer,g="start"===t?this.fromPoint:this.toPoint,f=g.getPathfinderAnchorPoint(i);i.enabled&&(c="start"===t?{x:n[4],y:n[5]}:{x:n[n.length-5],y:n[n.length-4]},r=g.getRadiansToVector(c,f),e=g.getMarkerVector(r,i.radius,f),o=-r/deg2rad,i.width&&i.height?(s=i.width,h=i.height):s=h=2*i.radius,this.graphics=this.graphics||{},a={x:e.x-s/2,y:e.y-h/2,width:s,height:h,rotation:o,rotationOriginX:e.x,rotationOriginY:e.y},this.graphics[t]?this.graphics[t].animate(a):(this.graphics[t]=p.symbol(i.symbol).addClass("highcharts-point-connecting-path-"+t+"-marker").attr(a).add(l.group),p.styledMode||this.graphics[t].attr({fill:i.color||this.fromPoint.color,stroke:i.lineColor,"stroke-width":i.lineWidth,opacity:0}).animate({opacity:1},g.series.options.animation)))},getPath:function(t){var i=this.pathfinder,n=this.chart,e=i.algorithms[t.type],r=i.chartObstacles;if("function"==typeof e)return e.requiresObstacles&&!r&&(r=i.chartObstacles=i.getChartObstacles(t),n.options.connectors.algorithmMargin=t.algorithmMargin,i.chartObstacleMetrics=i.getObstacleMetrics(r)),e(this.fromPoint.getPathfinderAnchorPoint(t.startMarker),this.toPoint.getPathfinderAnchorPoint(t.endMarker),merge({chartObstacles:r,lineObstacles:i.lineObstacles||[],obstacleMetrics:i.chartObstacleMetrics,hardBounds:{xMin:0,xMax:n.plotWidth,yMin:0,yMax:n.plotHeight},obstacleOptions:{margin:t.algorithmMargin},startDirectionX:i.getAlgorithmStartDirection(t.startMarker)},t));H.error('"'+t.type+'" is not a Pathfinder algorithm.')},render:function(){var t,i,n=this.fromPoint,e=n.series,r=e.chart,o=r.pathfinder,a=merge(r.options.connectors,e.options.connectors,n.options.connectors,this.options),s={};r.styledMode||(s.stroke=a.lineColor||n.color,s["stroke-width"]=a.lineWidth,a.dashStyle&&(s.dashstyle=a.dashStyle)),s.class="highcharts-point-connecting-path highcharts-color-"+n.colorIndex,a=merge(s,a),defined(a.marker.radius)||(a.marker.radius=min(max(Math.ceil((a.algorithmMargin||8)/2)-1,1),5)),i=(t=this.getPath(a)).path,t.obstacles&&(o.lineObstacles=o.lineObstacles||[],o.lineObstacles=o.lineObstacles.concat(t.obstacles)),this.renderPath(i,s,e.options.animation),this.addMarker("start",merge(a.marker,a.startMarker),i),this.addMarker("end",merge(a.marker,a.endMarker),i)},destroy:function(){this.graphics&&(objectEach(this.graphics,function(t){t.destroy()}),delete this.graphics)}},Pathfinder.prototype={algorithms:pathfinderAlgorithms,init:function(t){this.chart=t,this.connections=[],addEvent(t,"redraw",function(){this.pathfinder.update()})},update:function(t){var i=this.chart,n=this,e=n.connections;n.connections=[],i.series.forEach(function(t){t.visible&&!t.options.isInternal&&t.points.forEach(function(t){var e,r=t.options&&t.options.connect&&splat(t.options.connect);t.visible&&!1!==t.isInside&&r&&r.forEach(function(r){(e=i.get("string"==typeof r?r:r.to))instanceof H.Point&&e.series.visible&&e.visible&&!1!==e.isInside&&n.connections.push(new Connection(t,e,"string"==typeof r?{}:r))})})});for(var r,o,a=0,s=e.length,h=n.connections.length;a<s;++a){for(o=!1,r=0;r<h;++r)if(e[a].fromPoint===n.connections[r].fromPoint&&e[a].toPoint===n.connections[r].toPoint){n.connections[r].graphics=e[a].graphics,o=!0;break}o||e[a].destroy()}delete this.chartObstacles,delete this.lineObstacles,n.renderConnections(t)},renderConnections:function(t){t?this.chart.series.forEach(function(t){var i=function(){var i=t.chart.pathfinder;(i&&i.connections||[]).forEach(function(i){i.fromPoint&&i.fromPoint.series===t&&i.render()}),t.pathfinderRemoveRenderEvent&&(t.pathfinderRemoveRenderEvent(),delete t.pathfinderRemoveRenderEvent)};!1===t.options.animation?i():t.pathfinderRemoveRenderEvent=addEvent(t,"afterAnimate",i)}):this.connections.forEach(function(t){t.render()})},getChartObstacles:function(t){for(var i,n=[],e=this.chart.series,r=pick(t.algorithmMargin,0),o=0,a=e.length;o<a;++o)if(e[o].visible&&!e[o].options.isInternal)for(var s,h,c=0,d=e[o].points.length;c<d;++c)(h=e[o].points[c]).visible&&(s=getPointBB(h))&&n.push({xMin:s.xMin-r,xMax:s.xMax+r,yMin:s.yMin-r,yMax:s.yMax+r});return n=n.sort(function(t,i){return t.xMin-i.xMin}),defined(t.algorithmMargin)||(i=t.algorithmMargin=calculateObstacleMargin(n),n.forEach(function(t){t.xMin-=i,t.xMax+=i,t.yMin-=i,t.yMax+=i})),n},getObstacleMetrics:function(t){for(var i,n,e=0,r=0,o=t.length;o--;)e<(i=t[o].xMax-t[o].xMin)&&(e=i),r<(n=t[o].yMax-t[o].yMin)&&(r=n);return{maxHeight:r,maxWidth:e}},getAlgorithmStartDirection:function(t){var i="left"!==t.align&&"right"!==t.align,n="top"!==t.verticalAlign&&"bottom"!==t.verticalAlign;return i?!!n&&void 0:!!n||void 0}},H.Connection=Connection,H.Pathfinder=Pathfinder,extend(H.Point.prototype,{getPathfinderAnchorPoint:function(t){var i,n,e=getPointBB(this);switch(t.align){case"right":i="xMax";break;case"left":i="xMin"}switch(t.verticalAlign){case"top":n="yMin";break;case"bottom":n="yMax"}return{x:i?e[i]:(e.xMin+e.xMax)/2,y:n?e[n]:(e.yMin+e.yMax)/2}},getRadiansToVector:function(t,i){var n;return defined(i)||(i={x:((n=getPointBB(this)).xMin+n.xMax)/2,y:(n.yMin+n.yMax)/2}),Math.atan2(i.y-t.y,t.x-i.x)},getMarkerVector:function(t,i,n){for(var e,r=2*Math.PI,o=t,a=getPointBB(this),s=a.xMax-a.xMin,h=a.yMax-a.yMin,c=Math.atan2(h,s),d=!1,l=s/2,p=h/2,g=a.xMin+l,f=a.yMin+p,M={x:g,y:f},x={},y=1,m=1;o<-Math.PI;)o+=r;for(;o>Math.PI;)o-=r;return e=Math.tan(o),o>-c&&o<=c?(m=-1,d=!0):o>c&&o<=Math.PI-c?m=-1:o>Math.PI-c||o<=-(Math.PI-c)?(y=-1,d=!0):y=-1,d?(M.x+=y*l,M.y+=m*l*e):(M.x+=y*(h/(2*e)),M.y+=m*p),n.x!==g&&(M.x=n.x),n.y!==f&&(M.y=n.y),x.x=M.x+i*Math.cos(o),x.y=M.y-i*Math.sin(o),x}}),H.Chart.prototype.callbacks.push(function(t){!1!==t.options.connectors.enabled&&(warnLegacy(t),this.pathfinder=new Pathfinder(this),this.pathfinder.update(!0))});